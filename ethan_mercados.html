<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ethan mercados Â· Cartera</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#040e0e;--surface:#071717;--surface2:#0b1f1f;--surface3:#0f2828;
  --border:#1a3c3c;--border2:#245050;
  --accent:#40d9c0;--accent2:#2ba897;--accent-glow:rgba(64,217,192,0.10);
  --bull:#4ade80;--bull-dim:rgba(74,222,128,0.10);--bull-border:rgba(74,222,128,0.25);
  --bear:#f47174;--bear-dim:rgba(244,113,116,0.10);--bear-border:rgba(244,113,116,0.25);
  --warn:#fbbf24;--warn-dim:rgba(251,191,36,0.10);
  --text:#d0e8e4;--text2:#9cb8b4;--text3:#4a706a;
  --radius:12px;--radius-sm:8px;
  --font:'Montserrat',sans-serif;--mono:'IBM Plex Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.app{max-width:1440px;margin:0 auto;padding:20px 24px 60px}
header{display:flex;align-items:center;justify-content:space-between;padding:20px 0 24px;border-bottom:1px solid var(--border);margin-bottom:24px;flex-wrap:wrap;gap:16px}
.brand{display:flex;align-items:center;gap:14px}
.brand-icon{width:44px;height:44px;background:linear-gradient(135deg,#0f2828,#133232);border:1px solid var(--accent);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;letter-spacing:-1px;font-family:var(--mono)}
.brand h1{font-size:22px;font-weight:700;letter-spacing:-0.5px}
.brand p{font-size:12px;color:var(--text2);margin-top:1px}

/* TABS */
.tabs{display:flex;gap:4px;background:var(--surface);border-radius:var(--radius);padding:4px;margin-bottom:20px;border:1px solid var(--border)}
.tab{padding:10px 22px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text2);border:none;background:none;font-family:var(--font)}
.tab:hover{color:var(--text);background:var(--surface2)}
.tab.active{background:var(--accent-glow);color:var(--accent);border:1px solid rgba(59,130,246,0.3)}
.sub-tabs{display:flex;gap:4px;margin-bottom:20px}
.sub-tab{padding:8px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text3);border:1px solid var(--border);background:var(--surface);font-family:var(--font)}
.sub-tab:hover{color:var(--text2);border-color:var(--border2)}
.sub-tab.active-bull{background:var(--bull-dim);color:var(--bull);border-color:var(--bull-border)}
.sub-tab.active-bear{background:var(--bear-dim);color:var(--bear);border-color:var(--bear-border)}
.sub-tab.active-gen{background:var(--accent-glow);color:var(--accent);border-color:rgba(59,130,246,0.3)}
.view{display:none}.view.active{display:block}
.sub-view{display:none}.sub-view.active{display:block}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:16px;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:0.5px}
.card-title span{font-size:16px}

/* KPIs */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi.green::before{background:var(--bull)}.kpi.red::before{background:var(--bear)}.kpi.blue::before{background:var(--accent)}.kpi.purple::before{background:var(--accent2)}.kpi.yellow::before{background:var(--warn)}
.kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:0.6px;color:var(--text2);margin-bottom:6px;font-weight:500}
.kpi-value{font-size:26px;font-weight:700;font-family:var(--mono);letter-spacing:-1px;line-height:1.1}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:4px;font-family:var(--mono)}
.kpi-value.green{color:var(--bull)}.kpi-value.red{color:var(--bear)}.kpi-value.blue{color:var(--accent)}.kpi-value.yellow{color:var(--warn)}.kpi-value.purple{color:var(--accent2)}

/* TABLES */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:var(--surface2);padding:10px 14px;text-align:left;font-weight:600;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;position:sticky;top:0}
td{padding:10px 14px;border-top:1px solid var(--border);white-space:nowrap}
tr:hover td{background:var(--surface2)}
.ticker{font-family:var(--mono);font-weight:600;font-size:12px;background:var(--surface2);padding:2px 8px;border-radius:4px}
.badge-green{color:var(--bull);background:var(--bull-dim);padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:12px;font-weight:600}
.badge-red{color:var(--bear);background:var(--bear-dim);padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:12px;font-weight:600}

/* FORMS */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group label{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text2);font-weight:500}
input[type="number"],input[type="text"],input[type="date"],select{
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;width:100%;transition:border-color .2s}
input:focus,select:focus{border-color:var(--accent)}
input[type="range"]{-webkit-appearance:none;background:var(--surface2);height:6px;border-radius:3px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid var(--surface)}
.btn{padding:9px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:var(--font)}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#2563eb}
.btn-success{background:var(--bull);color:#fff}.btn-success:hover{background:#059669}
.btn-danger{background:var(--bear);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text2)}.btn-outline:hover{border-color:var(--text);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:11px}

/* STRAT TABS */
.strat-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px}
.strat-tab{padding:7px 14px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .2s;font-family:var(--font)}
.strat-tab:hover{border-color:var(--accent);color:var(--text)}
.strat-tab.active{background:var(--accent-glow);color:var(--accent);border-color:rgba(59,130,246,0.4)}
.strat-view{display:none}.strat-view.active{display:block}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
.mb-sm{margin-bottom:14px}.mb-md{margin-bottom:20px}.mb-lg{margin-bottom:28px}

.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-box canvas{max-height:300px}

.semaforo{display:flex;gap:12px;align-items:center;padding:14px 18px;border-radius:var(--radius);font-weight:600;font-size:14px}
.semaforo.verde{background:var(--bull-dim);border:1px solid var(--bull-border);color:var(--bull)}
.semaforo.amarillo{background:var(--warn-dim);border:1px solid rgba(245,158,11,0.3);color:var(--warn)}
.semaforo.rojo{background:var(--bear-dim);border:1px solid var(--bear-border);color:var(--bear)}
.semaforo-dot{width:14px;height:14px;border-radius:50%;animation:pulse 2s infinite}
.semaforo.verde .semaforo-dot{background:var(--bull)}
.semaforo.amarillo .semaforo-dot{background:var(--warn)}
.semaforo.rojo .semaforo-dot{background:var(--bear)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.proj-row{display:grid;grid-template-columns:60px 1fr 100px;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.proj-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .5s ease}

.empty-state{text-align:center;padding:40px 20px;color:var(--text3)}
.empty-state p{font-size:14px;margin-bottom:8px}
.empty-state small{font-size:12px}
.close-pos-btn{font-size:10px;padding:4px 12px;background:var(--bear-dim);color:var(--bear);border:1px solid var(--bear-border);border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font);font-weight:600;transition:all .2s}
.close-pos-btn:hover{background:var(--bear);color:#fff}

@media(max-width:900px){.g2,.g3{grid-template-columns:1fr}.kpi-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.app{padding:12px 10px}.kpi-grid{grid-template-columns:1fr}.tabs,.sub-tabs{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<header>
  <div class="brand">
    <div class="brand-icon">E</div>
    <div><h1 style="font-family:'Cormorant Garamond',serif;font-weight:300;letter-spacing:2px">ETHAN <span style="font-weight:600">Mercados</span></h1><p>Cartera & Risk Management</p></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span style="font-family:var(--mono);font-size:12px;color:var(--text2)" id="lastUpdate"></span>
    <button class="btn btn-sm btn-outline" onclick="resetAllData()" style="font-size:10px;opacity:0.6">Resetear datos</button>
  </div>
</header>

<!-- CAPITAL BAR (siempre visible) -->
<div class="card mb-md" style="display:flex;flex-wrap:wrap;gap:20px;align-items:flex-end">
  <div class="form-group" style="min-width:180px">
    <label>Capital Total (â‚¬)</label>
    <input type="number" id="capitalTotal" value="10000" min="100" step="100" oninput="recalcAll()">
  </div>
  <div class="form-group" style="min-width:140px">
    <label>% RV Alcista</label>
    <input type="number" id="pctAlcista" value="50" min="0" max="100" step="5" oninput="recalcAll()">
  </div>
  <div class="form-group" style="min-width:140px">
    <label>% RV Bajista</label>
    <input type="number" id="pctBajista" value="50" min="0" max="100" step="5" oninput="recalcAll()">
  </div>
  <div style="font-family:var(--mono);font-size:13px;color:var(--text2)">
    Alcista: <strong id="euroAlcista" style="color:var(--bull)">â‚¬5,000</strong> Â· 
    Bajista: <strong id="euroBajista" style="color:var(--bear)">â‚¬5,000</strong>
  </div>
</div>

<!-- 2 MAIN TABS -->
<div class="tabs">
  <button class="tab active" data-view="cartera" onclick="switchMain('cartera')">ğŸ“Š Cartera</button>
  <button class="tab" data-view="risk" onclick="switchMain('risk')">âš™ï¸ Risk Management</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: CARTERA                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view active" id="view-cartera">
  <div class="sub-tabs">
    <button class="sub-tab active-bull" data-sub="bull" onclick="switchSub('bull')">ğŸ“ˆ RV Alcista</button>
    <button class="sub-tab" data-sub="bear" onclick="switchSub('bear')">ğŸ“‰ RV Bajista</button>
    <button class="sub-tab" data-sub="general" onclick="switchSub('general')">ğŸ“Š General + Proyecciones</button>
  </div>

  <!-- SUB: BULL -->
  <div class="sub-view active" id="sub-bull">
    <div class="kpi-grid" id="kpi-bull"></div>
    <div class="g2 mb-md">
      <div class="card">
        <div class="card-title"><span>ğŸ“‹</span> Operaciones Cerradas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Salida</th><th>P.Ent</th><th>P.Sal</th><th>Capital</th><th>P/L â‚¬</th><th>P/L %</th><th>DÃ­as</th></tr></thead>
          <tbody id="tb-bull-closed"></tbody></table>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸŸ¢</span> Posiciones Abiertas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Precio</th><th>Capital</th><th>Peso</th><th>Acc.</th><th></th></tr></thead>
          <tbody id="tb-bull-open"></tbody></table>
        </div>
      </div>
    </div>
    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>ğŸ“Š</span> P/L por OperaciÃ³n</div><canvas id="chart-bull-pl"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>ğŸ“ˆ</span> Equity Curve</div><canvas id="chart-bull-equity"></canvas></div>
    </div>
    <div class="card mb-md">
      <div class="card-title"><span>â•</span> AÃ±adir OperaciÃ³n Alcista</div>
      <div class="form-grid mb-sm">
        <div class="form-group"><label>Valor</label><input type="text" id="add-bull-valor" placeholder="APPLE"></div>
        <div class="form-group"><label>Ticker</label><input type="text" id="add-bull-ticker" placeholder="AAPL"></div>
        <div class="form-group"><label>F. Entrada</label><input type="date" id="add-bull-fentrada"></div>
        <div class="form-group"><label>F. Salida (vacÃ­o=abierta)</label><input type="date" id="add-bull-fsalida"></div>
        <div class="form-group"><label>P. Entrada (â‚¬)</label><input type="number" id="add-bull-pentrada" step="0.01"></div>
        <div class="form-group"><label>P. Salida (â‚¬)</label><input type="number" id="add-bull-psalida" step="0.01"></div>
        <div class="form-group"><label>Capital (â‚¬)</label><input type="number" id="add-bull-capital" step="100"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-success" onclick="addOp('bull')">AÃ±adir</button></div>
      </div>
    </div>
  </div>

  <!-- SUB: BEAR -->
  <div class="sub-view" id="sub-bear">
    <div class="kpi-grid" id="kpi-bear"></div>
    <div class="g2 mb-md">
      <div class="card">
        <div class="card-title"><span>ğŸ“‹</span> Operaciones Cerradas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Salida</th><th>P.Ent</th><th>P.Sal</th><th>Capital</th><th>P/L â‚¬</th><th>P/L %</th><th>DÃ­as</th></tr></thead>
          <tbody id="tb-bear-closed"></tbody></table>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ”´</span> Posiciones Abiertas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Precio</th><th>Capital</th><th>Peso</th><th>Acc.</th><th></th></tr></thead>
          <tbody id="tb-bear-open"></tbody></table>
        </div>
      </div>
    </div>
    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>ğŸ“Š</span> P/L por OperaciÃ³n</div><canvas id="chart-bear-pl"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>ğŸ“ˆ</span> Equity Curve</div><canvas id="chart-bear-equity"></canvas></div>
    </div>
    <div class="card mb-md">
      <div class="card-title"><span>â•</span> AÃ±adir OperaciÃ³n Bajista</div>
      <div class="form-grid mb-sm">
        <div class="form-group"><label>Valor</label><input type="text" id="add-bear-valor" placeholder="TESLA"></div>
        <div class="form-group"><label>Ticker</label><input type="text" id="add-bear-ticker" placeholder="TSLA"></div>
        <div class="form-group"><label>F. Entrada</label><input type="date" id="add-bear-fentrada"></div>
        <div class="form-group"><label>F. Salida (vacÃ­o=abierta)</label><input type="date" id="add-bear-fsalida"></div>
        <div class="form-group"><label>P. Entrada (â‚¬)</label><input type="number" id="add-bear-pentrada" step="0.01"></div>
        <div class="form-group"><label>P. Salida (â‚¬)</label><input type="number" id="add-bear-psalida" step="0.01"></div>
        <div class="form-group"><label>Capital (â‚¬)</label><input type="number" id="add-bear-capital" step="100"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-danger" onclick="addOp('bear')">AÃ±adir</button></div>
      </div>
    </div>
  </div>

  <!-- SUB: GENERAL + ANÃLISIS INSTITUCIONAL -->
  <div class="sub-view" id="sub-general">
    
    <!-- KPIs resumen -->
    <div class="kpi-grid" id="kpi-general"></div>

    <!-- Comparativa Alcista vs Bajista -->
    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>âš–ï¸</span> Comparativa Alcista vs Bajista</div><canvas id="chart-compare"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>ğŸ“ˆ</span> Equity Curve Combinada</div><canvas id="chart-general-equity"></canvas></div>
    </div>

    <!-- â•â•â• BLOQUE 1: RENTABILIDAD â•â•â• -->
    <div class="card mb-md" style="border-color:var(--accent)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>ğŸ“Š</span> 1. RENTABILIDAD</div>
      <div class="g2 mb-sm">
        <div id="rent-serie-mensual"></div>
        <div id="rent-serie-anual"></div>
      </div>
      <div class="kpi-grid mb-sm" id="kpi-rent"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>ğŸ“…</span> Rentabilidad Mensual</div><canvas id="chart-rent-mensual"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>ğŸ”„</span> Rolling Returns</div><canvas id="chart-rolling"></canvas></div>
      </div>
      <div id="rent-benchmark"></div>
    </div>

    <!-- â•â•â• BLOQUE 2: RIESGO â•â•â• -->
    <div class="card mb-md" style="border-color:var(--bear)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>âš ï¸</span> 2. RIESGO (nivel fondo)</div>
      <div class="kpi-grid mb-sm" id="kpi-riesgo"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>ğŸ“‰</span> Drawdown HistÃ³rico</div><canvas id="chart-drawdown"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>ğŸ“Š</span> DistribuciÃ³n de Retornos</div><canvas id="chart-distrib"></canvas></div>
      </div>
      <div id="risk-detail"></div>
    </div>

    <!-- â•â•â• BLOQUE 3: EFICIENCIA RIESGO-RETORNO â•â•â• -->
    <div class="card mb-md" style="border-color:var(--warn)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>âš¡</span> 3. EFICIENCIA RIESGO-RETORNO</div>
      <div class="kpi-grid mb-sm" id="kpi-eficiencia"></div>
      <div id="eficiencia-detail"></div>
    </div>

    <!-- â•â•â• BLOQUE 4: PROBABILIDAD & ROBUSTEZ â•â•â• -->
    <div class="card mb-md" style="border-color:rgba(168,85,247,0.5)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>ğŸ¯</span> 4. PROBABILIDAD & ROBUSTEZ</div>
      <div class="kpi-grid mb-sm" id="kpi-prob"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>ğŸ²</span> Monte Carlo (1000 simulaciones)</div><canvas id="chart-montecarlo"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>ğŸ“ˆ</span> Prob. de Alcanzar Objetivo</div><canvas id="chart-prob-obj"></canvas></div>
      </div>
      <div class="g2 mb-sm">
        <div id="stress-test"></div>
        <div id="prob-detail"></div>
      </div>
    </div>

    <!-- â•â•â• PROYECCIONES (se mantiene) â•â•â• -->
    <div class="card mb-md">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>ğŸš€</span> PROYECCIONES & ESCENARIOS</div>
      <div class="kpi-grid mb-sm" id="kpi-proj"></div>
      <div class="g2 mb-sm">
        <div>
          <p style="font-size:12px;color:var(--text2);margin-bottom:14px">Basado en rentabilidad media Ã— sizing actual, con reinversiÃ³n compuesta.</p>
          <div id="proj-table"></div>
        </div>
        <div class="chart-box"><div class="card-title"><span>ğŸ“ˆ</span> Curva de Crecimiento</div><canvas id="chart-projection"></canvas></div>
      </div>
      <div class="g2">
        <div id="dd-analysis"></div>
        <div id="scenarios"></div>
      </div>
    </div>

    <!-- Serie mensual limpia (hidden, para export) -->
    <div id="serie-mensual-raw" style="display:none"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- VIEW: RISK MANAGEMENT                      -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-risk">
  <!-- CALCULADORA DE POSICIÃ“N -->
  <div class="card mb-md" style="border-color:var(--accent)">
    <div class="card-title"><span>ğŸ“</span> Calculadora de TamaÃ±o de PosiciÃ³n</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px">Calcula cuÃ¡ntas acciones comprar y cuÃ¡nto capital invertir para cada operaciÃ³n que quieras abrir.</p>
    <div class="form-grid mb-sm">
      <div class="form-group"><label>Ticker / Valor</label><input type="text" id="sz-ticker" placeholder="Ej: AAPL" oninput="calcSizing()"></div>
      <div class="form-group"><label>Precio de Entrada (â‚¬)</label><input type="number" id="sz-precio" step="0.01" placeholder="150.00" oninput="calcSizing()"></div>
      <div class="form-group"><label>Stop Loss (â‚¬)</label><input type="number" id="sz-stop" step="0.01" placeholder="145.00" oninput="calcSizing()"></div>
      <div class="form-group"><label>Take Profit (â‚¬) <span style="color:var(--text3)">(opcional)</span></label><input type="number" id="sz-tp" step="0.01" placeholder="165.00" oninput="calcSizing()"></div>
    </div>
    <div id="sz-result"></div>
  </div>

  <div id="semaforo-container" class="mb-md"></div>

  <div class="card mb-md">
    <div class="card-title"><span>ğŸ¯</span> ConfiguraciÃ³n de Riesgo</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Riesgo por OperaciÃ³n (%)</label>
        <input type="range" id="riesgoPct" min="0.5" max="5" step="0.25" value="1" oninput="recalcAll()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)"><span>0.5%</span><span id="riesgoPctVal" style="color:var(--accent);font-weight:700">1%</span><span>5%</span></div>
      </div>
      <div class="form-group">
        <label>Drawdown MÃ¡x. Tolerable (%)</label>
        <input type="range" id="ddPct" min="5" max="30" step="1" value="10" oninput="recalcAll()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)"><span>5%</span><span id="ddPctVal" style="color:var(--bear);font-weight:700">10%</span><span>30%</span></div>
      </div>
      <div class="form-group">
        <label>Posiciones SimultÃ¡neas MÃ¡x.</label>
        <input type="number" id="maxPos" value="3" min="1" max="20" oninput="recalcAll()">
      </div>
    </div>
  </div>

  <div class="kpi-grid mb-md" id="kpi-risk"></div>

  <!-- 7 Strategy tabs -->
  <div class="strat-tabs">
    <button class="strat-tab active" onclick="switchStrat('pctfijo')">% Fijo</button>
    <button class="strat-tab" onclick="switchStrat('kelly')">Kelly</button>
    <button class="strat-tab" onclick="switchStrat('martingala')">Martingala</button>
    <button class="strat-tab" onclick="switchStrat('antimartingala')">Anti-Martingala</button>
    <button class="strat-tab" onclick="switchStrat('fibonacci')">Fibonacci</button>
    <button class="strat-tab" onclick="switchStrat('parabolico')">ParabÃ³lico</button>
    <button class="strat-tab" onclick="switchStrat('volatilidad')">Por Volatilidad</button>
  </div>

  <!-- % Fijo -->
  <div class="strat-view active" id="strat-pctfijo">
    <div class="g2">
      <div class="card">
        <div class="card-title"><span>ğŸ“</span> % Fijo del Capital</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Arriesgas un porcentaje fijo en cada operaciÃ³n. La mÃ¡s recomendada.</p>
        <div class="form-group mb-sm"><label>Stop Loss (â‚¬ desde entrada)</label><input type="number" id="pf-sl" value="2" step="0.1" oninput="calcPctFijo()"></div>
        <div id="pf-result"></div>
      </div>
      <div class="card">
        <div class="card-title"><span>ğŸ“‰</span> SimulaciÃ³n de Rachas Perdedoras</div>
        <div id="pf-racha"></div>
      </div>
    </div>
  </div>

  <!-- Kelly -->
  <div class="strat-view" id="strat-kelly"><div class="g2">
    <div class="card"><div class="card-title"><span>ğŸ§®</span> Criterio de Kelly</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">FracciÃ³n Ã³ptima para maximizar crecimiento a largo plazo. Se alimenta de tu Win Rate y ratios reales.</p>
      <div id="kelly-result"></div></div>
    <div class="card"><div class="card-title"><span>ğŸ“Š</span> Full vs Half vs Quarter</div><div id="kelly-comparison"></div></div>
  </div></div>

  <!-- Martingala -->
  <div class="strat-view" id="strat-martingala"><div class="g2">
    <div class="card"><div class="card-title"><span>âš ï¸</span> Martingala (Alto Riesgo)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Doblas la apuesta tras cada pÃ©rdida. Extremadamente peligrosa.</p>
      <div class="form-group mb-sm"><label>Apuesta Inicial (â‚¬)</label><input type="number" id="mg-apuesta" value="100" step="10" oninput="calcMartingala()"></div>
      <div id="mg-result"></div></div>
    <div class="card"><div class="card-title"><span>ğŸ’€</span> Tabla de DestrucciÃ³n</div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Apuesta</th><th>PÃ©rdida Acum.</th><th>% Capital</th><th>Estado</th></tr></thead><tbody id="mg-table"></tbody></table></div></div>
  </div></div>

  <!-- Anti-Martingala -->
  <div class="strat-view" id="strat-antimartingala"><div class="g2">
    <div class="card"><div class="card-title"><span>ğŸ”„</span> Anti-Martingala (Paroli)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Doblas tras cada ganancia, reset tras pÃ©rdida.</p>
      <div class="form-group mb-sm"><label>Apuesta Base (â‚¬)</label><input type="number" id="am-apuesta" value="100" step="10" oninput="calcAntiMartingala()"></div>
      <div class="form-group mb-sm"><label>Reset tras X ganancias</label><input type="number" id="am-reset" value="3" min="2" max="10" oninput="calcAntiMartingala()"></div>
      <div id="am-result"></div></div>
    <div class="card"><div class="card-title"><span>ğŸ“Š</span> Tabla de ProgresiÃ³n</div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Apuesta</th><th>Ganancia Acum.</th><th>AcciÃ³n</th></tr></thead><tbody id="am-table"></tbody></table></div></div>
  </div></div>

  <!-- Fibonacci -->
  <div class="strat-view" id="strat-fibonacci"><div class="g2">
    <div class="card"><div class="card-title"><span>ğŸŒ€</span> Secuencia Fibonacci</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Aumentas siguiendo Fibonacci tras cada pÃ©rdida.</p>
      <div class="form-group mb-sm"><label>Unidad Base (â‚¬)</label><input type="number" id="fib-base" value="50" step="10" oninput="calcFibonacci()"></div>
      <div id="fib-result"></div></div>
    <div class="card"><div class="card-title"><span>ğŸ“Š</span> Secuencia</div>
      <div class="table-wrap"><table><thead><tr><th>Paso</th><th>Mult.</th><th>Apuesta</th><th>Acum.</th><th>Estado</th></tr></thead><tbody id="fib-table"></tbody></table></div></div>
  </div></div>

  <!-- ParabÃ³lico -->
  <div class="strat-view" id="strat-parabolico"><div class="g2">
    <div class="card"><div class="card-title"><span>ğŸ“ˆ</span> ParabÃ³lico (Power of Profits)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Escalas usando solo ganancias acumuladas. Capital original protegido.</p>
      <div class="form-group mb-sm"><label>Delta de escalado (%)</label><input type="number" id="par-delta" value="25" min="5" max="100" step="5" oninput="calcParabolico()"></div>
      <div id="par-result"></div></div>
    <div class="card"><div class="card-title"><span>ğŸ“Š</span> Niveles de Escalado</div>
      <div class="table-wrap"><table><thead><tr><th>Nivel</th><th>Beneficio Necesario</th><th>Sizing</th><th>Aumento</th></tr></thead><tbody id="par-table"></tbody></table></div></div>
  </div></div>

  <!-- Volatilidad -->
  <div class="strat-view" id="strat-volatilidad">
    <div class="card">
      <div class="card-title"><span>âš¡</span> Sizing por Volatilidad Inversa (ATR)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">MÃ¡s capital a activos menos volÃ¡tiles, igualando riesgo real.</p>
      <div id="vol-inputs" class="mb-sm"></div>
      <button class="btn btn-outline btn-sm" onclick="addVolRow()">+ AÃ±adir Activo</button>
      <div id="vol-result" style="margin-top:16px"></div>
    </div>
  </div>
</div>

<!-- MODAL CERRAR POSICIÃ“N -->
<div id="close-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:28px;width:380px;max-width:90vw">
    <div style="font-size:14px;font-weight:600;margin-bottom:18px;color:var(--text)">Cerrar PosiciÃ³n: <span id="cm-name" style="color:var(--accent)"></span></div>
    <div class="form-group mb-sm"><label>Fecha de Salida</label><input type="date" id="cm-fecha"></div>
    <div class="form-group mb-sm"><label>Precio de Salida (â‚¬)</label><input type="number" id="cm-precio" step="0.01" placeholder="0.00"></div>
    <div id="cm-preview" style="margin:14px 0;font-size:13px;font-family:var(--mono);color:var(--text2)"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-success" onclick="confirmClose()">Cerrar PosiciÃ³n</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- JAVASCRIPT                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ DATA + PERSISTENCE â”€â”€
var DATA = loadData();

function loadData() {
  try {
    var saved = localStorage.getItem('ethan_cartera');
    if (saved) {
      var d = JSON.parse(saved);
      if (d.bull && d.bear) {
        d.bull.enriched = [];
        d.bear.enriched = [];
        return d;
      }
    }
  } catch(e) { console.log('No saved data'); }
  return { bull: { closed: [], open: [] }, bear: { closed: [], open: [] } };
}

function saveData() {
  try {
    var toSave = {
      bull: { closed: DATA.bull.closed, open: DATA.bull.open },
      bear: { closed: DATA.bear.closed, open: DATA.bear.open }
    };
    localStorage.setItem('ethan_cartera', JSON.stringify(toSave));
  } catch(e) { console.log('Save error', e); }
}

function enrichOps(ops, isBear) {
  return ops.map(op => {
    const dias = Math.round((new Date(op.fs) - new Date(op.fe)) / 86400000);
    const acciones = op.cap / op.pe;
    let pl, pct;
    if (isBear) { pl = acciones * (op.pe - op.ps); pct = (op.pe - op.ps) / op.pe; }
    else { pl = acciones * (op.ps - op.pe); pct = (op.ps - op.pe) / op.pe; }
    return { ...op, dias, acciones, pl: Math.round(pl * 100) / 100, pct };
  });
}
DATA.bull.enriched = enrichOps(DATA.bull.closed, false);
DATA.bear.enriched = enrichOps(DATA.bear.closed, true);

// â”€â”€ CALC RATIOS â”€â”€
function calcRatios(ops) {
  if (!ops.length) return null;
  const totalPL = ops.reduce((s,o) => s+o.pl, 0);
  const winners = ops.filter(o => o.pl > 0), losers = ops.filter(o => o.pl <= 0);
  const winRate = winners.length / ops.length;
  const avgWinPct = winners.length ? winners.reduce((s,o) => s+o.pct, 0)/winners.length : 0;
  const avgLossPct = losers.length ? Math.abs(losers.reduce((s,o) => s+o.pct, 0)/losers.length) : 0;
  const esperanza = winRate * avgWinPct - (1-winRate) * avgLossPct;
  const rents = ops.map(o => o.pct);
  const meanRent = rents.reduce((s,r) => s+r, 0)/rents.length;
  const stdRent = Math.sqrt(rents.reduce((s,r) => s+(r-meanRent)**2, 0)/rents.length);
  const sharpe = stdRent > 0 ? meanRent/stdRent : 0;
  const diasArr = ops.map(o => o.dias).filter(d => d > 0);
  const diasMedio = diasArr.length ? diasArr.reduce((s,d) => s+d, 0)/diasArr.length : 0;
  const maxWin = ops.reduce((a,b) => a.pct > b.pct ? a : b);
  const maxLoss = ops.reduce((a,b) => a.pct < b.pct ? a : b);
  const opsAnio = diasMedio > 0 ? 365.25/diasMedio : 0;
  const grossWin = winners.reduce((s,o) => s+o.pl, 0);
  const grossLoss = Math.abs(losers.reduce((s,o) => s+o.pl, 0));
  const profitFactor = grossLoss > 0 ? grossWin/grossLoss : Infinity;
  let maxConsecLoss = 0, cl = 0;
  ops.forEach(o => { if (o.pl <= 0) { cl++; maxConsecLoss = Math.max(maxConsecLoss, cl); } else cl = 0; });
  return { totalPL, winRate, avgWinPct, avgLossPct, esperanza, sharpe, diasMedio, maxWin, maxLoss, opsAnio, rentMedia: meanRent, profitFactor, maxConsecLoss, winners: winners.length, losers: losers.length, total: ops.length, stdRent };
}

// â”€â”€ CHARTS â”€â”€
const charts = {};
function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

// â”€â”€ FORMATTERS â”€â”€
function fmt(n, d=2) { return n.toFixed(d); }
function fmtE(n) { return 'â‚¬'+n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtPct(n) { return (n>=0?'+':'')+(n*100).toFixed(2)+'%'; }
function fmtK(n) { return n>=1000 ? 'â‚¬'+(n/1000).toFixed(1)+'k' : fmtE(n); }

// â”€â”€ RENDER KPIs â”€â”€
function renderKPIs(id, r, color) {
  const c = document.getElementById(id);
  if (!r) { c.innerHTML = '<div class="empty-state"><p>Sin operaciones cerradas</p><small>AÃ±ade operaciones con el formulario de abajo</small></div>'; return; }
  const cl = color==='bull'?'green':color==='bear'?'red':'blue';
  c.innerHTML = `
    <div class="kpi ${cl}"><div class="kpi-label">P/L Total</div><div class="kpi-value ${r.totalPL>=0?'green':'red'}">${fmtE(r.totalPL)}</div><div class="kpi-sub">${r.total} operaciones</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Win Rate</div><div class="kpi-value">${(r.winRate*100).toFixed(1)}%</div><div class="kpi-sub">${r.winners}W / ${r.losers}L</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Rent. Media/Op</div><div class="kpi-value ${r.rentMedia>=0?'green':'red'}">${fmtPct(r.rentMedia)}</div><div class="kpi-sub">${fmt(r.diasMedio,0)} dÃ­as Â· ${fmt(r.opsAnio,1)} ops/aÃ±o</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Esperanza Mat.</div><div class="kpi-value ${r.esperanza>=0?'green':'red'}">${fmtPct(r.esperanza)}</div><div class="kpi-sub">Sharpe: ${fmt(r.sharpe)}</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Profit Factor</div><div class="kpi-value">${r.profitFactor===Infinity?'âˆ':fmt(r.profitFactor)}</div><div class="kpi-sub">AvgW: ${fmtPct(r.avgWinPct)} Â· AvgL: -${(r.avgLossPct*100).toFixed(2)}%</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">MÃ¡x Ganancia</div><div class="kpi-value green">${fmtPct(r.maxWin.pct)}</div><div class="kpi-sub">${r.maxWin.ticker} Â· ${r.maxWin.dias}d</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">MÃ¡x PÃ©rdida</div><div class="kpi-value red">${fmtPct(r.maxLoss.pct)}</div><div class="kpi-sub">${r.maxLoss.ticker} Â· ${r.maxLoss.dias}d</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">MÃ¡x Rachas Perd.</div><div class="kpi-value red">${r.maxConsecLoss}</div><div class="kpi-sub">consecutivas</div></div>`;
}

function renderTable(tbId, ops) {
  document.getElementById(tbId).innerHTML = ops.length ? ops.map(o => `<tr>
    <td><strong>${o.valor}</strong></td><td><span class="ticker">${o.ticker}</span></td>
    <td>${new Date(o.fe).toLocaleDateString('es-ES')}</td><td>${new Date(o.fs).toLocaleDateString('es-ES')}</td>
    <td>${fmtE(o.pe)}</td><td>${fmtE(o.ps)}</td><td>${fmtE(o.cap)}</td>
    <td><span class="${o.pl>=0?'badge-green':'badge-red'}">${fmtE(o.pl)}</span></td>
    <td><span class="${o.pct>=0?'badge-green':'badge-red'}">${fmtPct(o.pct)}</span></td>
    <td>${o.dias}d</td></tr>`).join('') : '<tr><td colspan="10" style="text-align:center;color:var(--text3)">â€”</td></tr>';
}

function renderOpenTable(tbId, ops, type) {
  const tb = document.getElementById(tbId);
  tb.innerHTML = ops.length ? ops.map((o,i) => '<tr>' +
    '<td><strong>' + o.valor + '</strong></td>' +
    '<td><span class="ticker">' + o.ticker + '</span></td>' +
    '<td>' + new Date(o.fe).toLocaleDateString('es-ES') + '</td>' +
    '<td>' + fmtE(o.pe) + '</td>' +
    '<td>' + fmtE(o.cap) + '</td>' +
    '<td>' + (o.peso*100).toFixed(0) + '%</td>' +
    '<td>' + (o.cap/o.pe).toFixed(2) + '</td>' +
    '<td><button class="close-pos-btn" data-type="' + type + '" data-idx="' + i + '">&#10005; Cerrar</button></td>' +
    '</tr>').join('') : '<tr><td colspan="8" style="text-align:center;color:var(--text3)">&mdash;</td></tr>';
}

function renderPLChart(canvasId, ops, cPos, cNeg) {
  destroyChart(canvasId);
  if (!ops.length) return;
  charts[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
    type:'bar', data:{labels:ops.map(o=>o.ticker),datasets:[{data:ops.map(o=>o.pl),backgroundColor:ops.map(o=>o.pl>=0?cPos:cNeg),borderRadius:4}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtE(c.parsed.y)}}},scales:{y:{ticks:{callback:v=>'â‚¬'+v,color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });
}

function renderEquityChart(canvasId, ops, color) {
  destroyChart(canvasId);
  if (!ops.length) return;
  let eq = [0]; ops.forEach((o,i) => eq.push(eq[i]+o.pl));
  charts[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
    type:'line', data:{labels:['Inicio',...ops.map(o=>o.ticker)],datasets:[{data:eq,borderColor:color,backgroundColor:color+'20',fill:true,tension:.3,pointRadius:4,pointBackgroundColor:color}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtE(c.parsed.y)}}},scales:{y:{ticks:{callback:v=>'â‚¬'+v,color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });
}

// â”€â”€ GENERAL VIEW (INSTITUTIONAL ANALYTICS) â”€â”€

// Helper: group operations by month â†’ returns [{month:'2024-05', ops:[], rentAcum:X}, ...]
function buildMonthlySeries(ops) {
  if (!ops.length) return [];
  const sorted = [...ops].sort((a,b) => new Date(a.fs) - new Date(b.fs));
  const months = {};
  sorted.forEach(op => {
    const m = op.fs.substring(0,7); // 'YYYY-MM'
    if (!months[m]) months[m] = [];
    months[m].push(op);
  });
  const series = [];
  let acum = 0;
  Object.keys(months).sort().forEach(m => {
    const mOps = months[m];
    const rentMes = mOps.reduce((s,o) => s + o.pct, 0) / mOps.length; // avg return that month
    const plMes = mOps.reduce((s,o) => s + o.pl, 0);
    acum += plMes;
    series.push({ month: m, ops: mOps, rentMes, plMes, acum, nOps: mOps.length });
  });
  return series;
}

// Helper: group by year
function buildAnnualSeries(monthly) {
  const years = {};
  monthly.forEach(m => {
    const y = m.month.substring(0,4);
    if (!years[y]) years[y] = { ops: 0, rentSum: 0, plSum: 0 };
    years[y].ops += m.nOps;
    years[y].rentSum += m.rentMes * m.nOps;
    years[y].plSum += m.plMes;
  });
  return Object.keys(years).sort().map(y => ({
    year: y,
    nOps: years[y].ops,
    rentMedia: years[y].ops > 0 ? years[y].rentSum / years[y].ops : 0,
    plTotal: years[y].plSum
  }));
}

// Helper: rolling returns (window = N operations)
function calcRolling(ops, window) {
  if (ops.length < window) return [];
  const result = [];
  for (let i = window; i <= ops.length; i++) {
    const slice = ops.slice(i - window, i);
    const cumRet = slice.reduce((s,o) => s * (1 + o.pct), 1) - 1;
    result.push({ idx: i, ret: cumRet, endDate: slice[slice.length-1].fs });
  }
  return result;
}

// Helper: max drawdown on equity curve
function calcDrawdownSeries(ops) {
  if (!ops.length) return { maxDD: 0, ddDuration: 0, ddSeries: [], peakSeries: [] };
  let equity = [0], peak = 0, maxDD = 0, ddStart = 0, ddEnd = 0, maxDDDuration = 0;
  let currentDDStart = 0, inDD = false;
  const ddSeries = [], peakSeries = [];
  
  ops.forEach((o, i) => {
    equity.push(equity[i] + o.pl);
    const eq = equity[i+1];
    if (eq > peak) { 
      peak = eq; 
      if (inDD) {
        const dur = i - currentDDStart;
        if (dur > maxDDDuration) maxDDDuration = dur;
        inDD = false;
      }
    } else if (!inDD) {
      inDD = true;
      currentDDStart = i;
    }
    const dd = peak > 0 ? (eq - peak) / peak : (peak === 0 && eq < 0) ? eq / (ops[0].cap || 1) : 0;
    if (dd < maxDD) { maxDD = dd; ddStart = currentDDStart; ddEnd = i; }
    ddSeries.push(dd);
    peakSeries.push(peak);
  });
  if (inDD) {
    const dur = ops.length - currentDDStart;
    if (dur > maxDDDuration) maxDDDuration = dur;
  }
  return { maxDD, ddDuration: maxDDDuration, ddSeries, peakSeries, equity };
}

// Helper: downside deviation
function calcDownsideDeviation(rents, mar = 0) {
  const neg = rents.filter(r => r < mar).map(r => (r - mar) ** 2);
  return neg.length ? Math.sqrt(neg.reduce((s,x) => s+x, 0) / rents.length) : 0;
}

// Helper: VaR parametric 95%
function calcVaR95(rents) {
  if (!rents.length) return 0;
  const mean = rents.reduce((s,r) => s+r, 0) / rents.length;
  const std = Math.sqrt(rents.reduce((s,r) => s + (r-mean)**2, 0) / rents.length);
  return mean - 1.645 * std;
}

// Helper: Monte Carlo simulation
function monteCarloSim(rents, nSims, nOps, startCap) {
  const paths = [];
  const finals = [];
  for (let s = 0; s < nSims; s++) {
    let cap = startCap;
    const path = [cap];
    for (let i = 0; i < nOps; i++) {
      const r = rents[Math.floor(Math.random() * rents.length)];
      cap *= (1 + r);
      path.push(cap);
    }
    paths.push(path);
    finals.push(cap);
  }
  finals.sort((a,b) => a - b);
  return {
    paths,
    finals,
    p5: finals[Math.floor(nSims * 0.05)],
    p25: finals[Math.floor(nSims * 0.25)],
    p50: finals[Math.floor(nSims * 0.50)],
    p75: finals[Math.floor(nSims * 0.75)],
    p95: finals[Math.floor(nSims * 0.95)],
    probLoss: finals.filter(f => f < startCap).length / nSims,
    probDD20: paths.filter(p => {
      let pk = p[0];
      for (let i = 1; i < p.length; i++) {
        if (p[i] > pk) pk = p[i];
        if (pk > 0 && (p[i] - pk) / pk < -0.20) return true;
      }
      return false;
    }).length / nSims
  };
}

// Helper: stress test (simulate N consecutive worst ops)
function stressTest(rents, nWorst) {
  const sorted = [...rents].sort((a,b) => a - b);
  const worst = sorted.slice(0, nWorst);
  let cap = 1;
  worst.forEach(r => cap *= (1+r));
  return cap - 1; // total loss pct
}

function renderGeneral() {
  const rb = calcRatios(DATA.bull.enriched), rr = calcRatios(DATA.bear.enriched);
  const allOps = [...DATA.bull.enriched,...DATA.bear.enriched].sort((a,b)=>new Date(a.fe)-new Date(b.fe));
  const rg = calcRatios(allOps);
  renderKPIs('kpi-general', rg, 'general');

  // Radar chart (same as before)
  destroyChart('chart-compare');
  if (rb || rr) {
    const mkData = r => [r?.winRate*100||0,(r?.rentMedia||0)*100,(r?.esperanza||0)*100,r?.sharpe||0,Math.min(r?.profitFactor||0,10)];
    charts['chart-compare'] = new Chart(document.getElementById('chart-compare').getContext('2d'), {
      type:'radar',data:{labels:['Win Rate','Rent. Media %','Esperanza %','Sharpe','Profit Factor'],
        datasets:[{label:'Alcista',data:mkData(rb),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',pointBackgroundColor:'#10b981'},
                  {label:'Bajista',data:mkData(rr),borderColor:'#f43f5e',backgroundColor:'rgba(244,63,94,0.1)',pointBackgroundColor:'#f43f5e'}]},
      options:{responsive:true,scales:{r:{ticks:{color:'#8896ab',backdropColor:'transparent'},grid:{color:'rgba(255,255,255,0.06)'},pointLabels:{color:'#e8ecf4',font:{size:11}}}},plugins:{legend:{labels:{color:'#e8ecf4'}}}}
    });
  }

  // Combined equity
  destroyChart('chart-general-equity');
  if (allOps.length) {
    let eq=[0]; allOps.forEach((o,i)=>eq.push(eq[i]+o.pl));
    charts['chart-general-equity'] = new Chart(document.getElementById('chart-general-equity').getContext('2d'), {
      type:'line',data:{labels:eq.map((_,i)=>i===0?'Inicio':'Op '+i),datasets:[{label:'Combinada',data:eq,borderColor:'#38bdf8',tension:.3,pointRadius:3,fill:false}]},
      options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4'}}},scales:{y:{ticks:{callback:v=>'â‚¬'+v,color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
    });
  }

  if (!rg || allOps.length < 2) {
    ['rent-serie-mensual','rent-serie-anual','kpi-rent','rent-benchmark','kpi-riesgo','risk-detail',
     'kpi-eficiencia','eficiencia-detail','kpi-prob','stress-test','prob-detail'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '<div class="empty-state"><small>Necesitas operaciones cerradas para ver anÃ¡lisis</small></div>';
    });
    ['chart-rent-mensual','chart-rolling','chart-drawdown','chart-distrib','chart-montecarlo','chart-prob-obj'].forEach(id => destroyChart(id));
    renderProjections();
    return;
  }

  const rents = allOps.map(o => o.pct);
  const { capital } = getConfig();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOQUE 1: RENTABILIDAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const monthly = buildMonthlySeries(allOps);
  const annual = buildAnnualSeries(monthly);

  // Save raw monthly series (the gold)
  document.getElementById('serie-mensual-raw').textContent = JSON.stringify(monthly);

  // Serie mensual table
  const smEl = document.getElementById('rent-serie-mensual');
  let smH = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);max-height:300px;overflow-y:auto"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Serie Mensual</div>';
  smH += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);color:var(--text3);padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:6px"><span>Mes</span><span>Ops</span><span>Rent.</span><span>P/L</span></div>';
  monthly.forEach(m => {
    smH += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.02)">
      <span style="color:var(--text2)">${m.month}</span><span style="color:var(--text3)">${m.nOps}</span>
      <span style="color:${m.rentMes>=0?'var(--bull)':'var(--bear)'}">${(m.rentMes*100).toFixed(2)}%</span>
      <span style="color:${m.plMes>=0?'var(--bull)':'var(--bear)'}">${fmtE(m.plMes)}</span></div>`;
  });
  smEl.innerHTML = smH + '</div>';

  // Serie anual table
  const saEl = document.getElementById('rent-serie-anual');
  let saH = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Serie Anual</div>';
  saH += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);color:var(--text3);padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:6px"><span>AÃ±o</span><span>Ops</span><span>Rent.Med</span><span>P/L</span></div>';
  annual.forEach(a => {
    saH += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.02)">
      <span style="color:var(--text);font-weight:600">${a.year}</span><span style="color:var(--text3)">${a.nOps}</span>
      <span style="color:${a.rentMedia>=0?'var(--bull)':'var(--bear)'}">${(a.rentMedia*100).toFixed(2)}%</span>
      <span style="color:${a.plTotal>=0?'var(--bull)':'var(--bear)'}">${fmtE(a.plTotal)}</span></div>`;
  });
  saEl.innerHTML = saH + '</div>';

  // Rent KPIs
  const totalDays = (new Date(allOps[allOps.length-1].fs) - new Date(allOps[0].fe)) / 86400000;
  const years = Math.max(totalDays / 365.25, 1/12);
  const cumReturn = allOps.reduce((s,o) => s * (1+o.pct), 1) - 1;
  const annReturn = Math.pow(1 + cumReturn, 1/years) - 1;
  const benchReturn = 0.10; // S&P500 ~10% anualizado como benchmark por defecto
  const excessReturn = annReturn - benchReturn;
  
  // Tracking Error (std of excess returns approx)
  const avgRentAnual = rg.rentMedia * rg.opsAnio;
  const trackingError = rg.stdRent * Math.sqrt(rg.opsAnio);
  const infoRatio = trackingError > 0 ? excessReturn / trackingError : 0;

  document.getElementById('kpi-rent').innerHTML = `
    <div class="kpi green"><div class="kpi-label">Rent. Acumulada</div><div class="kpi-value ${cumReturn>=0?'green':'red'}">${(cumReturn*100).toFixed(2)}%</div><div class="kpi-sub">${allOps.length} ops Â· ${(years).toFixed(1)} aÃ±os</div></div>
    <div class="kpi blue"><div class="kpi-label">Rent. Anualizada</div><div class="kpi-value ${annReturn>=0?'green':'red'}">${(annReturn*100).toFixed(2)}%</div><div class="kpi-sub">CAGR compuesto</div></div>
    <div class="kpi yellow"><div class="kpi-label">Exceso vs Bench</div><div class="kpi-value ${excessReturn>=0?'green':'red'}">${(excessReturn*100).toFixed(2)}%</div><div class="kpi-sub">vs S&P500 10%</div></div>
    <div class="kpi blue"><div class="kpi-label">Tracking Error</div><div class="kpi-value">${(trackingError*100).toFixed(2)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">Information Ratio</div><div class="kpi-value ${infoRatio>=0?'green':'red'}">${fmt(infoRatio)}</div><div class="kpi-sub">${infoRatio>0.5?'âœ… Bueno':infoRatio>0?'âš ï¸ Bajo':'âŒ Negativo'}</div></div>
    <div class="kpi blue"><div class="kpi-label">Rent. Media/Op</div><div class="kpi-value ${rg.rentMedia>=0?'green':'red'}">${fmtPct(rg.rentMedia)}</div><div class="kpi-sub">${fmt(rg.diasMedio,0)}d Â· ${fmt(rg.opsAnio,1)} ops/aÃ±o</div></div>`;

  // Monthly returns chart
  destroyChart('chart-rent-mensual');
  charts['chart-rent-mensual'] = new Chart(document.getElementById('chart-rent-mensual').getContext('2d'), {
    type:'bar', data:{labels:monthly.map(m=>m.month),datasets:[{data:monthly.map(m=>m.rentMes*100),backgroundColor:monthly.map(m=>m.rentMes>=0?'rgba(74,222,128,0.7)':'rgba(244,113,116,0.7)'),borderRadius:3}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.parsed.y.toFixed(2)+'%'}}},scales:{y:{ticks:{callback:v=>v.toFixed(1)+'%',color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxRotation:45,font:{size:9}},grid:{display:false}}}}
  });

  // Rolling returns chart
  destroyChart('chart-rolling');
  const r12 = calcRolling(allOps, Math.min(12, allOps.length));
  const r36 = calcRolling(allOps, Math.min(36, allOps.length));
  const rollingDatasets = [];
  if (r12.length) rollingDatasets.push({label:'Rolling 12 ops',data:r12.map(r=>r.ret*100),borderColor:'#40d9c0',tension:.3,pointRadius:0,fill:false,borderWidth:2});
  if (r36.length) rollingDatasets.push({label:'Rolling 36 ops',data:r36.map(r=>r.ret*100),borderColor:'#f59e0b',tension:.3,pointRadius:0,fill:false,borderWidth:2,borderDash:[5,3]});
  if (rollingDatasets.length) {
    const maxLen = Math.max(r12.length, r36.length);
    charts['chart-rolling'] = new Chart(document.getElementById('chart-rolling').getContext('2d'), {
      type:'line', data:{labels:Array.from({length:maxLen},(_,i)=>''+i),datasets:rollingDatasets},
      options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:10}}}},scales:{y:{ticks:{callback:v=>v.toFixed(0)+'%',color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{display:false}}}
    });
  }

  // Benchmark detail
  document.getElementById('rent-benchmark').innerHTML = `<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2);display:flex;gap:20px;flex-wrap:wrap">
    <span>ğŸ“Œ Benchmark: S&P 500 (10% anualizado)</span>
    <span>Exceso: <strong style="color:${excessReturn>=0?'var(--bull)':'var(--bear)'}"> ${(excessReturn*100).toFixed(2)}%</strong></span>
    <span>Info Ratio: <strong style="color:var(--accent)">${fmt(infoRatio)}</strong></span>
    <span>Track. Error: <strong>${(trackingError*100).toFixed(2)}%</strong></span></div>`;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOQUE 2: RIESGO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const dd = calcDrawdownSeries(allOps);
  const volAnual = rg.stdRent * Math.sqrt(rg.opsAnio);
  const downsideDev = calcDownsideDeviation(rents);
  const downsideDevAnual = downsideDev * Math.sqrt(rg.opsAnio);
  const var95 = calcVaR95(rents);
  
  // Beta vs benchmark (approx using correlation concept with market)
  // Since we don't have benchmark series, we approximate beta = vol_fund / vol_market * correlation
  // Using vol_market â‰ˆ 15% and assumed correlation â‰ˆ 0.6
  const volMarket = 0.15;
  const betaApprox = (volAnual / volMarket) * 0.6;
  const corrApprox = 0.6; // placeholder â€” would need real benchmark data

  document.getElementById('kpi-riesgo').innerHTML = `
    <div class="kpi yellow"><div class="kpi-label">Volatilidad Anualizada</div><div class="kpi-value yellow">${(volAnual*100).toFixed(2)}%</div><div class="kpi-sub">Ïƒ Ã— âˆš(ops/aÃ±o)</div></div>
    <div class="kpi red"><div class="kpi-label">MÃ¡ximo Drawdown</div><div class="kpi-value red">${(dd.maxDD*100).toFixed(2)}%</div><div class="kpi-sub">equity curve</div></div>
    <div class="kpi red"><div class="kpi-label">DuraciÃ³n DD</div><div class="kpi-value red">${dd.ddDuration} ops</div><div class="kpi-sub">operaciones en DD</div></div>
    <div class="kpi yellow"><div class="kpi-label">Downside Dev.</div><div class="kpi-value yellow">${(downsideDevAnual*100).toFixed(2)}%</div><div class="kpi-sub">anualizada</div></div>
    <div class="kpi red"><div class="kpi-label">VaR 95%</div><div class="kpi-value red">${(var95*100).toFixed(2)}%</div><div class="kpi-sub">por operaciÃ³n</div></div>
    <div class="kpi blue"><div class="kpi-label">Beta (aprox)</div><div class="kpi-value">${fmt(betaApprox)}</div><div class="kpi-sub">vs mercado</div></div>
    <div class="kpi blue"><div class="kpi-label">CorrelaciÃ³n</div><div class="kpi-value">${fmt(corrApprox)}</div><div class="kpi-sub">estimada</div></div>
    <div class="kpi purple"><div class="kpi-label">Desv. EstÃ¡ndar/Op</div><div class="kpi-value">${(rg.stdRent*100).toFixed(2)}%</div></div>`;

  // Drawdown chart
  destroyChart('chart-drawdown');
  charts['chart-drawdown'] = new Chart(document.getElementById('chart-drawdown').getContext('2d'), {
    type:'line', data:{labels:dd.ddSeries.map((_,i)=>'Op '+(i+1)),datasets:[{label:'Drawdown',data:dd.ddSeries.map(d=>d*100),borderColor:'#f47174',backgroundColor:'rgba(244,113,116,0.15)',fill:true,tension:.3,pointRadius:0,borderWidth:2}]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4'}}},scales:{y:{ticks:{callback:v=>v.toFixed(1)+'%',color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',font:{size:9}},grid:{display:false}}}}
  });

  // Distribution chart
  destroyChart('chart-distrib');
  const bins = 20;
  const minR = Math.min(...rents), maxR = Math.max(...rents);
  const binWidth = (maxR - minR) / bins || 0.01;
  const histogram = Array(bins).fill(0);
  rents.forEach(r => { const b = Math.min(Math.floor((r - minR) / binWidth), bins-1); histogram[b]++; });
  const binLabels = Array.from({length:bins}, (_,i) => ((minR + i*binWidth)*100).toFixed(1)+'%');
  const binColors = Array.from({length:bins}, (_,i) => {
    const mid = minR + (i+0.5)*binWidth;
    return mid >= 0 ? 'rgba(74,222,128,0.6)' : 'rgba(244,113,116,0.6)';
  });
  charts['chart-distrib'] = new Chart(document.getElementById('chart-distrib').getContext('2d'), {
    type:'bar', data:{labels:binLabels,datasets:[{data:histogram,backgroundColor:binColors,borderRadius:2}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxRotation:45,font:{size:8}},grid:{display:false}}}}
  });

  // Risk detail
  document.getElementById('risk-detail').innerHTML = `<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
    <div>Skewness: <strong style="color:var(--text);font-family:var(--mono)">${fmt(rents.reduce((s,r) => s + Math.pow((r-rg.rentMedia)/rg.stdRent, 3), 0) / rents.length)}</strong></div>
    <div>Kurtosis: <strong style="color:var(--text);font-family:var(--mono)">${fmt(rents.reduce((s,r) => s + Math.pow((r-rg.rentMedia)/rg.stdRent, 4), 0) / rents.length - 3)}</strong></div>
    <div>MÃ¡x Rachas Perd.: <strong style="color:var(--bear);font-family:var(--mono)">${rg.maxConsecLoss}</strong></div>
    <div>Profit Factor: <strong style="color:var(--accent);font-family:var(--mono)">${rg.profitFactor===Infinity?'âˆ':fmt(rg.profitFactor)}</strong></div>
    <div>AvgWin: <strong style="color:var(--bull);font-family:var(--mono)">${fmtPct(rg.avgWinPct)}</strong></div>
    <div>AvgLoss: <strong style="color:var(--bear);font-family:var(--mono)">-${(rg.avgLossPct*100).toFixed(2)}%</strong></div></div>`;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOQUE 3: EFICIENCIA RIESGO-RETORNO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const rfRate = 0.03; // risk-free ~3%
  const rfPerOp = rfRate / rg.opsAnio;
  const sharpeAnual = volAnual > 0 ? (annReturn - rfRate) / volAnual : 0;
  const sortinoAnual = downsideDevAnual > 0 ? (annReturn - rfRate) / downsideDevAnual : 0;
  const calmar = dd.maxDD !== 0 ? annReturn / Math.abs(dd.maxDD) : 0;
  const retOverDD = dd.maxDD !== 0 ? annReturn / Math.abs(dd.maxDD) : 0;

  document.getElementById('kpi-eficiencia').innerHTML = `
    <div class="kpi green"><div class="kpi-label">Sharpe Ratio</div><div class="kpi-value ${sharpeAnual>1?'green':sharpeAnual>0.5?'yellow':'red'}">${fmt(sharpeAnual)}</div><div class="kpi-sub">${sharpeAnual>1?'âœ… Excelente':sharpeAnual>0.5?'âš ï¸ Aceptable':'âŒ Bajo'} Â· anualizado</div></div>
    <div class="kpi green"><div class="kpi-label">Sortino Ratio</div><div class="kpi-value ${sortinoAnual>1.5?'green':sortinoAnual>0.5?'yellow':'red'}">${fmt(sortinoAnual)}</div><div class="kpi-sub">${sortinoAnual>1.5?'âœ… Excelente':sortinoAnual>0.5?'âš ï¸ Aceptable':'âŒ Bajo'}</div></div>
    <div class="kpi yellow"><div class="kpi-label">Calmar Ratio</div><div class="kpi-value ${calmar>1?'green':calmar>0.5?'yellow':'red'}">${fmt(calmar)}</div><div class="kpi-sub">CAGR / MÃ¡x DD</div></div>
    <div class="kpi blue"><div class="kpi-label">Ret. Anual / MÃ¡x DD</div><div class="kpi-value">${fmt(retOverDD)}</div><div class="kpi-sub">${retOverDD>2?'âœ… Muy bueno':retOverDD>1?'âš ï¸ Correcto':'âŒ Bajo'}</div></div>`;

  document.getElementById('eficiencia-detail').innerHTML = `<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2)">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div><div style="font-weight:600;color:var(--accent);margin-bottom:8px">InterpretaciÃ³n Sharpe</div>
        <div style="line-height:2">< 0.5: Malo â€” difÃ­cil justificar el riesgo<br>0.5â€“1.0: Aceptable â€” fondos promedio<br>1.0â€“2.0: Bueno â€” top quartile<br>> 2.0: Excepcional â€” muy raro sostenerlo</div></div>
      <div><div style="font-weight:600;color:var(--accent);margin-bottom:8px">InterpretaciÃ³n Calmar</div>
        <div style="line-height:2">< 0.5: Alto riesgo relativo a retorno<br>0.5â€“1.0: Equilibrado<br>1.0â€“3.0: Buen control de pÃ©rdidas<br>> 3.0: Excelente â€” muy buscado por fondos</div></div>
    </div>
    <div style="margin-top:12px;padding:10px;background:var(--accent-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm)">
      <strong style="color:var(--accent)">Tu narrativa:</strong> Sharpe ${fmt(sharpeAnual)} Â· Sortino ${fmt(sortinoAnual)} Â· Calmar ${fmt(calmar)}.
      ${calmar > 1 ? 'El fondo tiene un excelente control del drawdown relativo a su retorno.' : 
        sharpeAnual > 0.5 ? 'Rentabilidad aceptable pero hay margen para mejorar el control de caÃ­das.' : 
        'Necesitas mÃ¡s operaciones o mejorar el edge para alcanzar ratios atractivos.'}</div></div>`;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOQUE 4: PROBABILIDAD & ROBUSTEZ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const nOps5y = Math.round(rg.opsAnio * 5);
  const nOps10y = Math.round(rg.opsAnio * 10);
  const nOps15y = Math.round(rg.opsAnio * 15);
  
  // Monte Carlo
  const mc5 = monteCarloSim(rents, 1000, nOps5y, capital);
  const mc10 = monteCarloSim(rents, 500, nOps10y, capital);
  const mc15 = monteCarloSim(rents, 500, nOps15y, capital);

  // Probability of reaching 2x, 3x, 5x
  const prob2x5 = mc5.finals.filter(f => f >= capital*2).length / mc5.finals.length;
  const prob2x10 = mc10.finals.filter(f => f >= capital*2).length / mc10.finals.length;
  const prob3x10 = mc10.finals.filter(f => f >= capital*3).length / mc10.finals.length;
  const prob5x15 = mc15.finals.filter(f => f >= capital*5).length / mc15.finals.length;

  // Stress tests
  const stress3 = stressTest(rents, 3);
  const stress5 = stressTest(rents, 5);
  const stress10 = stressTest(rents, Math.min(10, rents.length));
  // Simulated "2008" = 6 worst ops consecutively, "2020" = 4 worst ops
  const stress2008 = stressTest(rents, Math.min(6, rents.length));
  const stress2020 = stressTest(rents, Math.min(4, rents.length));

  document.getElementById('kpi-prob').innerHTML = `
    <div class="kpi green"><div class="kpi-label">P(2x en 5 aÃ±os)</div><div class="kpi-value green">${(prob2x5*100).toFixed(1)}%</div><div class="kpi-sub">Monte Carlo 1000 sims</div></div>
    <div class="kpi green"><div class="kpi-label">P(2x en 10 aÃ±os)</div><div class="kpi-value green">${(prob2x10*100).toFixed(1)}%</div></div>
    <div class="kpi blue"><div class="kpi-label">P(3x en 10 aÃ±os)</div><div class="kpi-value blue">${(prob3x10*100).toFixed(1)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">P(5x en 15 aÃ±os)</div><div class="kpi-value purple">${(prob5x15*100).toFixed(1)}%</div></div>
    <div class="kpi red"><div class="kpi-label">P(DD > 20%)</div><div class="kpi-value red">${(mc5.probDD20*100).toFixed(1)}%</div><div class="kpi-sub">en horizonte 5Y</div></div>
    <div class="kpi yellow"><div class="kpi-label">P(perder capital)</div><div class="kpi-value ${mc5.probLoss>0.3?'red':'yellow'}">${(mc5.probLoss*100).toFixed(1)}%</div><div class="kpi-sub">en 5 aÃ±os</div></div>
    <div class="kpi blue"><div class="kpi-label">Mediana 5Y</div><div class="kpi-value green">${fmtK(mc5.p50)}</div><div class="kpi-sub">Ã—${(mc5.p50/capital).toFixed(2)}</div></div>
    <div class="kpi blue"><div class="kpi-label">P95 / P5 (5Y)</div><div class="kpi-value">${fmtK(mc5.p95)}</div><div class="kpi-sub">peor: ${fmtK(mc5.p5)}</div></div>`;

  // Monte Carlo chart (show 50 sample paths + percentile bands)
  destroyChart('chart-montecarlo');
  const nShow = 50;
  const mcDatasets = [];
  for (let i = 0; i < Math.min(nShow, mc5.paths.length); i++) {
    mcDatasets.push({data:mc5.paths[i], borderColor:'rgba(64,217,192,0.08)', borderWidth:1, pointRadius:0, tension:.1, fill:false});
  }
  // Percentile paths
  const pLen = nOps5y + 1;
  const p5Path=[], p50Path=[], p95Path=[];
  for (let step = 0; step < pLen; step++) {
    const vals = mc5.paths.map(p => p[Math.min(step, p.length-1)]).sort((a,b)=>a-b);
    p5Path.push(vals[Math.floor(vals.length*0.05)]);
    p50Path.push(vals[Math.floor(vals.length*0.50)]);
    p95Path.push(vals[Math.floor(vals.length*0.95)]);
  }
  mcDatasets.push({label:'P95',data:p95Path,borderColor:'#4ade80',borderWidth:2,pointRadius:0,tension:.3,fill:false,borderDash:[5,3]});
  mcDatasets.push({label:'Mediana',data:p50Path,borderColor:'#40d9c0',borderWidth:2.5,pointRadius:0,tension:.3,fill:false});
  mcDatasets.push({label:'P5',data:p5Path,borderColor:'#f47174',borderWidth:2,pointRadius:0,tension:.3,fill:false,borderDash:[5,3]});
  
  const mcLabels = Array.from({length:pLen}, (_,i) => i % Math.round(rg.opsAnio) === 0 ? `AÃ±o ${Math.round(i/rg.opsAnio)}` : '');
  charts['chart-montecarlo'] = new Chart(document.getElementById('chart-montecarlo').getContext('2d'), {
    type:'line', data:{labels:mcLabels, datasets:mcDatasets},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:10},filter:item=>item.text}}},
      scales:{y:{ticks:{callback:v=>fmtK(v),color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxTicksLimit:6},grid:{display:false}}}}
  });

  // Prob objective chart
  destroyChart('chart-prob-obj');
  const objectives = [
    {label:'2x 5Y', val:prob2x5}, {label:'2x 10Y', val:prob2x10}, {label:'3x 10Y', val:prob3x10}, {label:'5x 15Y', val:prob5x15}
  ];
  charts['chart-prob-obj'] = new Chart(document.getElementById('chart-prob-obj').getContext('2d'), {
    type:'bar', data:{labels:objectives.map(o=>o.label),datasets:[{data:objectives.map(o=>o.val*100),backgroundColor:objectives.map(o=>o.val>0.7?'rgba(74,222,128,0.7)':o.val>0.4?'rgba(251,191,36,0.7)':'rgba(244,113,116,0.7)'),borderRadius:6}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.parsed.y.toFixed(1)+'%'}}},
      scales:{y:{max:100,ticks:{callback:v=>v+'%',color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });

  // Stress test
  document.getElementById('stress-test').innerHTML = `<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)">
    <div style="font-size:12px;font-weight:600;color:var(--bear);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px">ğŸ§ª Stress Tests HistÃ³ricos</div>
    <div style="font-size:12px;line-height:2.2;font-family:var(--mono);color:var(--text2)">
      <div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)">
        <span>3 peores ops consecutivas</span><strong style="color:var(--bear)">${(stress3*100).toFixed(2)}%</strong></div>
      <div style="display:flex;justify-content:space-between;padding:4px 8px">
        <span>5 peores ops consecutivas</span><strong style="color:var(--bear)">${(stress5*100).toFixed(2)}%</strong></div>
      <div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)">
        <span>Escenario "Crisis 2008"</span><strong style="color:var(--bear)">${(stress2008*100).toFixed(2)}%</strong></div>
      <div style="display:flex;justify-content:space-between;padding:4px 8px">
        <span>Escenario "COVID 2020"</span><strong style="color:var(--bear)">${(stress2020*100).toFixed(2)}%</strong></div>
      <div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)">
        <span>10 peores ops</span><strong style="color:var(--bear)">${(stress10*100).toFixed(2)}%</strong></div>
    </div>
    <div style="margin-top:10px;padding:8px;font-size:11px;color:var(--text3)">* Crisis simuladas usando tus N peores operaciones reales de forma consecutiva</div></div>`;

  // Prob detail
  document.getElementById('prob-detail').innerHTML = `<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)">
    <div style="font-size:12px;font-weight:600;color:rgba(168,85,247,1);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px">ğŸ“Š DistribuciÃ³n Monte Carlo 5Y</div>
    <div style="font-size:12px;line-height:2.2;font-family:var(--mono);color:var(--text2)">
      <div style="display:flex;justify-content:space-between"><span>Percentil 5 (peor caso)</span><strong style="color:var(--bear)">${fmtK(mc5.p5)}</strong></div>
      <div style="display:flex;justify-content:space-between"><span>Percentil 25</span><strong style="color:var(--warn)">${fmtK(mc5.p25)}</strong></div>
      <div style="display:flex;justify-content:space-between"><span>Mediana (P50)</span><strong style="color:var(--accent)">${fmtK(mc5.p50)}</strong></div>
      <div style="display:flex;justify-content:space-between"><span>Percentil 75</span><strong style="color:var(--bull)">${fmtK(mc5.p75)}</strong></div>
      <div style="display:flex;justify-content:space-between"><span>Percentil 95 (mejor caso)</span><strong style="color:var(--bull)">${fmtK(mc5.p95)}</strong></div>
    </div>
    <div style="margin-top:12px;padding:10px;background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.25);border-radius:var(--radius-sm);font-size:11px;color:var(--text2)">
      <strong style="color:rgba(168,85,247,1)">Resumen:</strong> Con ${(mc5.probLoss*100).toFixed(0)}% prob. de perder capital y mediana de Ã—${(mc5.p50/capital).toFixed(2)} en 5 aÃ±os.
      ${mc5.probDD20 > 0.5 ? 'âš ï¸ Alta probabilidad de drawdown >20%.' : 'âœ… Riesgo de drawdown >20% contenido.'}
    </div></div>`;

  // Continue with projections
  renderProjections();
}

// â”€â”€ PROJECTIONS (inside General) â”€â”€
function renderProjections() {
  const { capital, ratios, riskPct, ddPct } = getConfig();
  const projContainer = document.getElementById('kpi-proj');
  const projTable = document.getElementById('proj-table');
  const ddEl = document.getElementById('dd-analysis');
  const scEl = document.getElementById('scenarios');

  if (!ratios) {
    projContainer.innerHTML = '<div class="empty-state"><small>Necesitas operaciones cerradas para proyectar</small></div>';
    projTable.innerHTML = ''; ddEl.innerHTML = ''; scEl.innerHTML = '';
    destroyChart('chart-projection');
    return;
  }

  const { rentMedia, opsAnio, diasMedio, winRate, avgWinPct, avgLossPct } = ratios;
  const sizing = Math.min(riskPct / (avgLossPct || 0.01), 1);
  const impactoGan = avgWinPct * sizing;
  const impactoPerd = avgLossPct * sizing;
  const rentEfectiva = winRate * impactoGan - (1-winRate) * impactoPerd;
  const totalOps5y = Math.round(opsAnio * 5);
  const cap1y = capital * Math.pow(1+rentEfectiva, Math.round(opsAnio));
  const cap5y = capital * Math.pow(1+rentEfectiva, totalOps5y);

  projContainer.innerHTML = `
    <div class="kpi green"><div class="kpi-label">Capital Inicial</div><div class="kpi-value">${fmtE(capital)}</div></div>
    <div class="kpi blue"><div class="kpi-label">Rent. HistÃ³rica/Op</div><div class="kpi-value blue">${fmtPct(rentMedia)}</div><div class="kpi-sub">${fmt(diasMedio,0)}d Â· ${fmt(opsAnio,1)} ops/aÃ±o</div></div>
    <div class="kpi yellow"><div class="kpi-label">Sizing</div><div class="kpi-value yellow">${(sizing*100).toFixed(1)}%</div><div class="kpi-sub">Riesgo ${(riskPct*100).toFixed(1)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">Impacto Real/Op</div><div class="kpi-value ${rentEfectiva>=0?'green':'red'}">${fmtPct(rentEfectiva)}</div><div class="kpi-sub">Esperanza Ã— Sizing</div></div>
    <div class="kpi green"><div class="kpi-label">ProyecciÃ³n 1Y</div><div class="kpi-value green">${fmtK(cap1y)}</div><div class="kpi-sub">Ã—${(cap1y/capital).toFixed(2)}</div></div>
    <div class="kpi green"><div class="kpi-label">ProyecciÃ³n 5Y</div><div class="kpi-value green">${fmtK(cap5y)}</div><div class="kpi-sub">Ã—${(cap5y/capital).toFixed(2)}</div></div>`;

  // Table
  let h = '';
  for (let y=1;y<=5;y++) {
    const cap = capital * Math.pow(1+rentEfectiva, Math.round(opsAnio*y));
    const bw = Math.min((cap/Math.max(cap5y,capital*1.01))*100,100);
    h += `<div class="proj-row"><span style="font-weight:600;color:var(--accent)">AÃ±o ${y}</span><div><div class="proj-bar" style="width:${bw}%"></div></div><span style="font-family:var(--mono);font-weight:600;text-align:right">${fmtK(cap)}</span></div>`;
  }
  projTable.innerHTML = h;

  // Chart with 3 curves
  destroyChart('chart-projection');
  const months = Array.from({length:61},(_,i)=>i);
  const mkCurve = rE => months.map(m => capital*Math.pow(1+rE, Math.round(opsAnio*m/12)));
  const sH = Math.min((riskPct/2)/(avgLossPct||0.01),1), sD = Math.min((riskPct*2)/(avgLossPct||0.01),1);
  const rH = winRate*avgWinPct*sH-(1-winRate)*avgLossPct*sH;
  const rD = winRate*avgWinPct*sD-(1-winRate)*avgLossPct*sD;
  charts['chart-projection'] = new Chart(document.getElementById('chart-projection').getContext('2d'), {
    type:'line',data:{labels:months.map(i=>i%12===0?`AÃ±o ${i/12}`:''),
      datasets:[
        {label:`Riesgo ${(riskPct*100).toFixed(1)}%`,data:mkCurve(rentEfectiva),borderColor:'#40d9c0',backgroundColor:'rgba(64,217,192,0.08)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5},
        {label:`Riesgo ${(riskPct*50).toFixed(1)}%`,data:mkCurve(rH),borderColor:'#38bdf8',borderDash:[5,3],tension:.3,pointRadius:0,fill:false,borderWidth:1.5},
        {label:`Riesgo ${(riskPct*200).toFixed(1)}%`,data:mkCurve(rD),borderColor:'#f59e0b',borderDash:[5,3],tension:.3,pointRadius:0,fill:false,borderWidth:1.5}]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:11}}}},scales:{y:{ticks:{callback:v=>fmtK(v),color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxTicksLimit:6},grid:{display:false}}}}
  });

  // Drawdown
  const lossRate = 1-winRate;
  let ddH = `<div style="padding:8px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:10px;font-size:12px;color:var(--text2)">
    Cada pÃ©rdida: <strong style="color:var(--bear)">-${(impactoPerd*100).toFixed(2)}%</strong> en cuenta</div><div style="font-size:13px;line-height:2">`;
  for (let n=2;n<=10;n++) {
    const prob = Math.pow(lossRate,n);
    const dd = (1-Math.pow(1-impactoPerd,n))*100;
    const p100 = (1-Math.pow(1-prob,100))*100;
    const exc = dd > ddPct*100;
    ddH += `<div style="display:flex;justify-content:space-between;padding:5px 8px;border-radius:4px;${exc?'background:var(--bear-dim)':''}">
      <span>${n} pÃ©rdidas</span><span style="font-family:var(--mono);font-size:12px">DD: <strong style="color:${exc?'var(--bear)':'var(--warn)'}">${dd.toFixed(1)}%</strong>${exc?' âš ï¸':''} Â· P(100ops): ${p100.toFixed(1)}%</span></div>`;
  }
  const lDD = Math.log(1-ddPct)/Math.log(1-impactoPerd);
  ddH += `</div><div style="margin-top:12px;padding:10px;background:var(--accent-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm);font-size:12px">
    <strong style="color:var(--accent)">Con tu sizing:</strong> <strong>${Math.floor(lDD)} pÃ©rdidas consecutivas</strong> hasta DD mÃ¡x ${(ddPct*100).toFixed(0)}%.
    ${lDD>8?'<span style="color:var(--bull)">âœ… Muy seguro</span>':lDD>5?'<span style="color:var(--warn)">âš ï¸ Moderado</span>':'<span style="color:var(--bear)">ğŸ”´ Peligroso</span>'}</div>`;
  ddEl.innerHTML = ddH;

  // Scenarios
  const scs = [{name:'Conservador',m:.5,color:'var(--warn)',d:'Mitad riesgo'},{name:'Base (actual)',m:1,color:'var(--accent)',d:`Riesgo ${(riskPct*100).toFixed(1)}%`},{name:'Agresivo',m:2,color:'var(--bear)',d:'Doble riesgo'}];
  let sH2 = '<div style="font-size:13px">';
  scs.forEach(s => {
    const sz = Math.min((riskPct*s.m)/(avgLossPct||0.01),1);
    const rE = winRate*avgWinPct*sz-(1-winRate)*avgLossPct*sz;
    const cp = capital*Math.pow(1+rE,totalOps5y);
    const ddL = Math.floor(Math.log(1-ddPct)/Math.log(1-avgLossPct*sz));
    sH2 += `<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong style="color:${s.color}">${s.name}</strong><span style="font-size:11px;color:var(--text3)">${s.d}</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:var(--text2)">
        <div>Impacto/op: <strong style="font-family:var(--mono);color:var(--text)">${fmtPct(rE)}</strong></div>
        <div>Capital 5Y: <strong style="font-family:var(--mono);color:var(--text)">${fmtK(cp)}</strong></div>
        <div>DD/pÃ©rdida: <strong style="font-family:var(--mono);color:var(--bear)">${(avgLossPct*sz*100).toFixed(2)}%</strong></div>
        <div>PÃ©rdidasâ†’DD: <strong style="font-family:var(--mono);color:${ddL>8?'var(--bull)':ddL>5?'var(--warn)':'var(--bear)'}">${ddL}</strong></div></div></div>`;
  });
  scEl.innerHTML = sH2 + '</div>';
}

// â”€â”€ GETCONFIG â”€â”€
function getConfig() {
  const capital = parseFloat(document.getElementById('capitalTotal').value)||10000;
  const riskPct = parseFloat(document.getElementById('riesgoPct').value)/100;
  const ddPct = parseFloat(document.getElementById('ddPct').value)/100;
  const maxPos = parseInt(document.getElementById('maxPos').value)||3;
  const allOps = [...DATA.bull.enriched,...DATA.bear.enriched];
  const ratios = calcRatios(allOps);
  return { capital, riskPct, ddPct, maxPos, ratios };
}

// â”€â”€ POSITION SIZING CALCULATOR â”€â”€
function calcSizing() {
  const {capital, riskPct} = getConfig();
  const ticker = document.getElementById('sz-ticker').value.trim().toUpperCase() || 'â€”';
  const precio = parseFloat(document.getElementById('sz-precio').value);
  const stop = parseFloat(document.getElementById('sz-stop').value);
  const tp = parseFloat(document.getElementById('sz-tp').value);
  const el = document.getElementById('sz-result');

  if (!precio || !stop || precio <= 0 || stop <= 0) {
    el.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:10px">Introduce precio de entrada y stop loss para calcular.</div>';
    return;
  }

  const isLong = precio > stop;
  const riskPerShare = Math.abs(precio - stop);
  const riskE = capital * riskPct;
  const acciones = Math.floor(riskE / riskPerShare);
  const capitalInvertido = acciones * precio;
  const pctCapital = capitalInvertido / capital;
  const perdidaMax = acciones * riskPerShare;
  const riskPctReal = perdidaMax / capital;

  let tpHtml = '';
  if (tp > 0) {
    const gananciaPerShare = Math.abs(tp - precio);
    const gananciaTotal = acciones * gananciaPerShare;
    const rrRatio = gananciaPerShare / riskPerShare;
    const rentPct = gananciaTotal / capitalInvertido;
    tpHtml = `
      <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
        <div>Take Profit: <strong style="color:var(--bull)">${fmtE(tp)}</strong> (${isLong?'+':'-'}${fmtE(gananciaPerShare)}/acc)</div>
        <div>Ganancia Potencial: <strong style="color:var(--bull)">${fmtE(gananciaTotal)}</strong> (${fmtPct(rentPct)} sobre invertido)</div>
        <div>Ratio R:R: <strong style="color:${rrRatio>=2?'var(--bull)':rrRatio>=1?'var(--warn)':'var(--bear)'}">${fmt(rrRatio)}:1</strong>
          ${rrRatio>=2?' âœ… Excelente':rrRatio>=1.5?' âœ… Bueno':rrRatio>=1?' âš ï¸ Justo':' âŒ Malo'}</div>
      </div>`;
  }

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:10px">Resultado para ${ticker}</div>
        <div style="font-family:var(--mono);font-size:13px;line-height:2.2;color:var(--text2)">
          <div>DirecciÃ³n: <strong style="color:${isLong?'var(--bull)':'var(--bear)'}">${isLong?'ğŸ“ˆ LONG':'ğŸ“‰ SHORT'}</strong></div>
          <div>Precio: <strong style="color:var(--text)">${fmtE(precio)}</strong></div>
          <div>Stop Loss: <strong style="color:var(--bear)">${fmtE(stop)}</strong> (${isLong?'-':'+'}${fmtE(riskPerShare)}/acc)</div>
          <div>Riesgo permitido: <strong style="color:var(--warn)">${fmtE(riskE)}</strong> (${(riskPct*100).toFixed(2)}% de ${fmtE(capital)})</div>
        </div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--accent);border-opacity:0.3">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent);margin-bottom:10px">TamaÃ±o de PosiciÃ³n</div>
        <div style="font-family:var(--mono);font-size:13px;line-height:2.2;color:var(--text2)">
          <div>Acciones: <strong style="color:var(--accent);font-size:18px">${acciones}</strong></div>
          <div>Capital a invertir: <strong style="color:var(--text)">${fmtE(capitalInvertido)}</strong> (${(pctCapital*100).toFixed(1)}% del total)</div>
          <div>PÃ©rdida mÃ¡xima: <strong style="color:var(--bear)">${fmtE(perdidaMax)}</strong> (${(riskPctReal*100).toFixed(2)}% del capital)</div>
          ${tpHtml}
        </div>
      </div>
    </div>`;
}

// â”€â”€ RISK MANAGEMENT STRATEGIES â”€â”€
function renderSemaforo() {
  const {capital,riskPct,maxPos}=getConfig();
  const rt=riskPct*maxPos; let lv,msg;
  if(rt<=0.05){lv='verde';msg=`ğŸŸ¢ Riesgo bajo: ${(rt*100).toFixed(1)}% en riesgo mÃ¡ximo`;}
  else if(rt<=0.12){lv='amarillo';msg=`ğŸŸ¡ Riesgo moderado: ${(rt*100).toFixed(1)}% en riesgo mÃ¡ximo`;}
  else{lv='rojo';msg=`ğŸ”´ Riesgo alto: ${(rt*100).toFixed(1)}% en riesgo â€” Â¡Cuidado!`;}
  document.getElementById('semaforo-container').innerHTML=`<div class="semaforo ${lv}"><div class="semaforo-dot"></div>${msg}</div>`;
}

function renderRiskKPIs() {
  const {capital,riskPct,ddPct,maxPos}=getConfig();
  const re=capital*riskPct, dm=capital*ddPct, rn=re*maxPos;
  document.getElementById('kpi-risk').innerHTML=`
    <div class="kpi blue"><div class="kpi-label">Riesgo/Op</div><div class="kpi-value blue">${fmtE(re)}</div><div class="kpi-sub">${(riskPct*100).toFixed(2)}%</div></div>
    <div class="kpi yellow"><div class="kpi-label">DD MÃ¡x Tolerable</div><div class="kpi-value yellow">${fmtE(dm)}</div><div class="kpi-sub">${(ddPct*100).toFixed(0)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">Ops Simult. MÃ¡x</div><div class="kpi-value">${maxPos}</div></div>
    <div class="kpi red"><div class="kpi-label">Capital en Riesgo</div><div class="kpi-value ${rn>dm?'red':'green'}">${fmtE(rn)}</div><div class="kpi-sub">con ${maxPos} posiciones</div></div>`;
}

function calcPctFijo() {
  const {capital,riskPct}=getConfig(); const sl=parseFloat(document.getElementById('pf-sl').value)||2;
  const re=capital*riskPct, acc=Math.floor(re/sl);
  document.getElementById('pf-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-family:var(--mono);font-size:13px;line-height:2">
    <div>Capital: <strong style="color:var(--accent)">${fmtE(capital)}</strong></div>
    <div>Riesgo: <strong>${(riskPct*100).toFixed(2)}%</strong> = <strong style="color:var(--warn)">${fmtE(re)}</strong></div>
    <div>Stop Loss: <strong>${fmtE(sl)}</strong>/acciÃ³n</div>
    <div>Acciones: <strong style="color:var(--bull)">${acc}</strong></div></div>`;
  let h='<div style="font-size:13px;line-height:1.8">',c=capital;
  for(let i=1;i<=15;i++){c-=c*riskPct;const p=((capital-c)/capital*100).toFixed(1);
    h+=`<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;${p>25?'background:var(--bear-dim)':''}"><span>${i} pÃ©rdidas</span><span style="font-family:var(--mono);color:${p>25?'var(--bear)':'var(--text2)'}">-${p}% (${fmtE(c)})</span></div>`;}
  document.getElementById('pf-racha').innerHTML=h+'</div>';
}

function calcKelly() {
  const {ratios,capital}=getConfig(); if(!ratios)return;
  const W=ratios.winRate, R=ratios.avgWinPct/(ratios.avgLossPct||0.01), k=W-(1-W)/R, hk=k/2, qk=k/4;
  document.getElementById('kelly-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-family:var(--mono);font-size:13px;line-height:2.2">
    <div>Win Rate: <strong style="color:var(--bull)">${(W*100).toFixed(1)}%</strong></div>
    <div>Ratio W/L: <strong style="color:var(--accent)">${fmt(R)}x</strong></div>
    <div style="border-top:1px solid var(--border);margin:8px 0;padding-top:8px">
    <div>Full Kelly: <strong style="color:${k>0?'var(--bull)':'var(--bear)'}">${(k*100).toFixed(2)}%</strong>${k<=0?' âš ï¸ No edge':''}</div>
    <div>Half Kelly: <strong style="color:var(--accent)">${(hk*100).toFixed(2)}%</strong> â† Recomendado</div>
    <div>Quarter Kelly: <strong style="color:var(--text2)">${(qk*100).toFixed(2)}%</strong></div></div></div>`;
  document.getElementById('kelly-comparison').innerHTML=`<div style="font-size:13px;line-height:2;padding:14px;background:var(--surface2);border-radius:var(--radius-sm)">
    <div style="display:flex;justify-content:space-between"><span>Full â†’</span><strong style="font-family:var(--mono)">${fmtE(capital*Math.max(k,0))}</strong></div>
    <div style="display:flex;justify-content:space-between"><span>Half â†’</span><strong style="font-family:var(--mono);color:var(--accent)">${fmtE(capital*Math.max(hk,0))}</strong></div>
    <div style="display:flex;justify-content:space-between"><span>Quarter â†’</span><strong style="font-family:var(--mono)">${fmtE(capital*Math.max(qk,0))}</strong></div>
    <div style="margin-top:10px;color:var(--warn);font-size:11px">âš ï¸ La mayorÃ­a de profesionales usan Half Kelly o menos.</div></div>`;
}

function calcMartingala() {
  const {capital}=getConfig(); const ap=parseFloat(document.getElementById('mg-apuesta').value)||100;
  let h='',ac=0,b=ap;
  for(let i=1;i<=12;i++){ac+=b;const p=(ac/capital*100).toFixed(1),r=ac>=capital;
    h+=`<tr style="${r?'background:var(--bear-dim)':''}"><td>${i}</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${p}%</td><td>${r?'ğŸ’€ RUINA':ac>capital*.5?'âš ï¸':'âœ…'}</td></tr>`;b*=2;}
  document.getElementById('mg-table').innerHTML=h;
  document.getElementById('mg-result').innerHTML=`<div style="padding:14px;background:var(--bear-dim);border:1px solid var(--bear-border);border-radius:var(--radius-sm);font-size:13px">
    <strong style="color:var(--bear)">âš ï¸ Con ${fmtE(ap)} y ${fmtE(capital)}, ruina en ${Math.ceil(Math.log2(capital/ap))} pÃ©rdidas consecutivas.</strong></div>`;
}

function calcAntiMartingala() {
  const ap=parseFloat(document.getElementById('am-apuesta').value)||100, rs=parseInt(document.getElementById('am-reset').value)||3;
  let h='',b=ap,ac=0;
  for(let i=1;i<=rs+2;i++){ac+=b;h+=`<tr><td>${i}</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${i>=rs?'ğŸ”„ RESET':'â¬†ï¸ Doblar'}</td></tr>`;if(i>=rs)b=ap;else b*=2;}
  document.getElementById('am-table').innerHTML=h;
  document.getElementById('am-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Tras <strong>${rs}</strong> ganancias, reset a <strong>${fmtE(ap)}</strong>.</div>`;
}

function calcFibonacci() {
  const {capital}=getConfig(); const bs=parseFloat(document.getElementById('fib-base').value)||50;
  const fibs=[1,1,2,3,5,8,13,21,34,55]; let h='',ac=0;
  for(let i=0;i<fibs.length;i++){const b=bs*fibs[i];ac+=b;const ov=ac>capital;
    h+=`<tr style="${ov?'background:var(--bear-dim)':''}"><td>${i+1}</td><td>${fibs[i]}x</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${ov?'âš ï¸':'âœ…'}</td></tr>`;}
  document.getElementById('fib-table').innerHTML=h;
  const ms=fibs.filter((_,i)=>{let s=0;for(let j=0;j<=i;j++)s+=bs*fibs[j];return s<=capital;}).length;
  document.getElementById('fib-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Aguantas <strong style="color:var(--accent)">${ms} pasos</strong> antes de superar capital.</div>`;
}

function calcParabolico() {
  const {capital,riskPct}=getConfig(); const dl=parseFloat(document.getElementById('par-delta').value)/100||0.25;
  const bs=capital*riskPct; let h='';
  for(let i=0;i<=8;i++){h+=`<tr><td>Nivel ${i}</td><td style="font-family:var(--mono)">${fmtE(bs*i*dl/riskPct)}</td><td style="font-family:var(--mono)">${fmtE(bs*(1+i*dl))}</td><td>+${(i*dl*100).toFixed(0)}%</td></tr>`;}
  document.getElementById('par-table').innerHTML=h;
  document.getElementById('par-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Capital original protegido. Delta: <strong>${(dl*100).toFixed(0)}%</strong>.</div>`;
}

let volRows=3;
function addVolRow(){volRows++;renderVolInputs();}
function renderVolInputs(){
  let h='<div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;margin-bottom:10px"><div style="font-size:11px;color:var(--text2);font-weight:600">ACTIVO</div><div style="font-size:11px;color:var(--text2);font-weight:600">PRECIO</div><div style="font-size:11px;color:var(--text2);font-weight:600">ATR</div>';
  for(let i=0;i<volRows;i++){h+=`<input type="text" id="vol-n-${i}" placeholder="Ticker" oninput="calcVol()"><input type="number" id="vol-p-${i}" placeholder="0.00" step="0.01" oninput="calcVol()"><input type="number" id="vol-a-${i}" placeholder="0.00" step="0.01" oninput="calcVol()">`;}
  document.getElementById('vol-inputs').innerHTML=h+'</div>';
}
function calcVol(){
  const {capital}=getConfig(); let assets=[];
  for(let i=0;i<volRows;i++){const n=document.getElementById(`vol-n-${i}`)?.value,p=parseFloat(document.getElementById(`vol-p-${i}`)?.value),a=parseFloat(document.getElementById(`vol-a-${i}`)?.value);if(n&&p>0&&a>0)assets.push({n,p,a});}
  if(!assets.length){document.getElementById('vol-result').innerHTML='';return;}
  const tiv=assets.reduce((s,x)=>s+1/x.a,0);
  let h='<div class="table-wrap"><table><thead><tr><th>Activo</th><th>Precio</th><th>ATR</th><th>Peso</th><th>Capital</th><th>Acc.</th></tr></thead><tbody>';
  assets.forEach(x=>{const w=(1/x.a)/tiv,c=capital*w;h+=`<tr><td><strong>${x.n}</strong></td><td style="font-family:var(--mono)">${fmtE(x.p)}</td><td style="font-family:var(--mono)">${fmt(x.a)}</td><td>${(w*100).toFixed(1)}%</td><td style="font-family:var(--mono)">${fmtE(c)}</td><td>${Math.floor(c/x.p)}</td></tr>`;});
  document.getElementById('vol-result').innerHTML=h+'</tbody></table></div>';
}

// â”€â”€ ADD OPERATION â”€â”€
function addOp(type) {
  var pf = 'add-' + type;
  var v = document.getElementById(pf + '-valor').value.trim();
  var t = document.getElementById(pf + '-ticker').value.trim().toUpperCase();
  var fe = document.getElementById(pf + '-fentrada').value;
  var fs = document.getElementById(pf + '-fsalida').value;
  var pe = parseFloat(document.getElementById(pf + '-pentrada').value);
  var ps = parseFloat(document.getElementById(pf + '-psalida').value);
  var cap = parseFloat(document.getElementById(pf + '-capital').value);
  if (!v || !t || !fe || !pe || !cap) { alert('Rellena: Valor, Ticker, F.Entrada, P.Entrada y Capital'); return; }
  if (fs && ps) {
    DATA[type].closed.push({ valor:v, ticker:t, fe:fe, fs:fs, pe:pe, ps:ps, cap:cap });
    DATA[type].enriched = enrichOps(DATA[type].closed, type === 'bear');
  } else {
    var peso = cap / (parseFloat(document.getElementById('capitalTotal').value) || 10000);
    DATA[type].open.push({ valor:v, ticker:t, fe:fe, pe:pe, cap:cap, peso:peso });
  }
  var fields = ['valor','ticker','fentrada','fsalida','pentrada','psalida','capital'];
  for (var fi = 0; fi < fields.length; fi++) {
    var el = document.getElementById(pf + '-' + fields[fi]);
    if (el) el.value = '';
  }
  saveData();
  recalcAll();
}

// â”€â”€ CLOSE POSITION MODAL â”€â”€
let closeTarget = { type: null, index: null };

function openCloseModal(type, index) {
  const op = DATA[type].open[index];
  if (!op) return;
  closeTarget = { type, index };
  document.getElementById('cm-name').textContent = `${op.valor} (${op.ticker})`;
  document.getElementById('cm-fecha').value = new Date().toISOString().slice(0, 10);
  document.getElementById('cm-precio').value = '';
  document.getElementById('cm-preview').innerHTML = `Entrada: ${fmtE(op.pe)} Â· Capital: ${fmtE(op.cap)}`;
  const modal = document.getElementById('close-modal');
  modal.style.display = 'flex';
  // Live preview
  document.getElementById('cm-precio').oninput = () => {
    const ps = parseFloat(document.getElementById('cm-precio').value);
    if (!ps) { document.getElementById('cm-preview').innerHTML = `Entrada: ${fmtE(op.pe)} Â· Capital: ${fmtE(op.cap)}`; return; }
    const acc = op.cap / op.pe;
    const isBear = type === 'bear';
    const pl = isBear ? acc * (op.pe - ps) : acc * (ps - op.pe);
    const pct = isBear ? (op.pe - ps) / op.pe : (ps - op.pe) / op.pe;
    document.getElementById('cm-preview').innerHTML = `
      Entrada: ${fmtE(op.pe)} â†’ Salida: ${fmtE(ps)}<br>
      P/L: <strong style="color:${pl >= 0 ? 'var(--bull)' : 'var(--bear)'}">${fmtE(pl)} (${fmtPct(pct)})</strong>`;
  };
}

function closeModal() {
  document.getElementById('close-modal').style.display = 'none';
  closeTarget = { type: null, index: null };
}

function confirmClose() {
  const { type, index } = closeTarget;
  if (type === null) return;
  const ps = parseFloat(document.getElementById('cm-precio').value);
  const fs = document.getElementById('cm-fecha').value;
  if (!ps || !fs) { alert('Introduce fecha y precio de salida'); return; }
  
  const op = DATA[type].open[index];
  // Move to closed
  const closedOp = { valor: op.valor, ticker: op.ticker, fe: op.fe, fs, pe: op.pe, ps, cap: op.cap };
  DATA[type].closed.push(closedOp);
  DATA[type].enriched = enrichOps(DATA[type].closed, type === 'bear');
  // Remove from open
  DATA[type].open.splice(index, 1);
  
  saveData();
  closeModal();
  recalcAll();
}

// Click outside modal to close
document.getElementById('close-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// â”€â”€ NAVIGATION â”€â”€
function switchMain(view) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  document.querySelectorAll('.tabs .tab').forEach(t=>{t.classList.remove('active');if(t.dataset.view===view)t.classList.add('active');});
}
function switchSub(sub) {
  document.querySelectorAll('.sub-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`sub-${sub}`).classList.add('active');
  document.querySelectorAll('.sub-tab').forEach(t=>{t.className='sub-tab';if(t.dataset.sub===sub)t.classList.add(sub==='bull'?'active-bull':sub==='bear'?'active-bear':'active-gen');});
}
function switchStrat(s) {
  document.querySelectorAll('.strat-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`strat-${s}`).classList.add('active');
  document.querySelectorAll('.strat-tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
}

// â”€â”€ RECALC ALL â”€â”€
function recalcAll() {
  document.getElementById('riesgoPctVal').textContent=document.getElementById('riesgoPct').value+'%';
  document.getElementById('ddPctVal').textContent=document.getElementById('ddPct').value+'%';
  const cap=parseFloat(document.getElementById('capitalTotal').value)||10000;
  const pA=parseFloat(document.getElementById('pctAlcista').value)||50, pB=parseFloat(document.getElementById('pctBajista').value)||50;
  document.getElementById('euroAlcista').textContent=fmtE(cap*pA/100);
  document.getElementById('euroBajista').textContent=fmtE(cap*pB/100);

  // Bull
  renderKPIs('kpi-bull',calcRatios(DATA.bull.enriched),'bull');
  renderTable('tb-bull-closed',DATA.bull.enriched);
  renderOpenTable('tb-bull-open',DATA.bull.open,'bull');
  renderPLChart('chart-bull-pl',DATA.bull.enriched,'rgba(16,185,129,0.7)','rgba(244,63,94,0.7)');
  renderEquityChart('chart-bull-equity',DATA.bull.enriched,'#10b981');

  // Bear
  renderKPIs('kpi-bear',calcRatios(DATA.bear.enriched),'bear');
  renderTable('tb-bear-closed',DATA.bear.enriched);
  renderOpenTable('tb-bear-open',DATA.bear.open,'bear');
  renderPLChart('chart-bear-pl',DATA.bear.enriched,'rgba(16,185,129,0.7)','rgba(244,63,94,0.7)');
  renderEquityChart('chart-bear-equity',DATA.bear.enriched,'#f43f5e');

  // General + Projections
  renderGeneral();

  // Risk
  renderSemaforo(); renderRiskKPIs(); calcSizing();
  calcPctFijo(); calcKelly(); calcMartingala(); calcAntiMartingala(); calcFibonacci(); calcParabolico(); calcVol();

  document.getElementById('lastUpdate').textContent='Actualizado: '+new Date().toLocaleString('es-ES');
  saveConfig();
}

// â”€â”€ EVENT DELEGATION FOR CLOSE BUTTONS â”€â”€
document.addEventListener('click', function(e) {
  var btn = e.target.closest('.close-pos-btn');
  if (btn) {
    var type = btn.getAttribute('data-type');
    var idx = parseInt(btn.getAttribute('data-idx'));
    openCloseModal(type, idx);
  }
});

// â”€â”€ INIT â”€â”€
// Load saved capital config
try {
  var savedConfig = localStorage.getItem('ethan_config');
  if (savedConfig) {
    var cfg = JSON.parse(savedConfig);
    if (cfg.capital) document.getElementById('capitalTotal').value = cfg.capital;
    if (cfg.pctA) document.getElementById('pctAlcista').value = cfg.pctA;
    if (cfg.pctB) document.getElementById('pctBajista').value = cfg.pctB;
    if (cfg.riesgo) document.getElementById('riesgoPct').value = cfg.riesgo;
    if (cfg.dd) document.getElementById('ddPct').value = cfg.dd;
    if (cfg.maxPos) document.getElementById('maxPos').value = cfg.maxPos;
  }
} catch(e) {}

function saveConfig() {
  try {
    localStorage.setItem('ethan_config', JSON.stringify({
      capital: document.getElementById('capitalTotal').value,
      pctA: document.getElementById('pctAlcista').value,
      pctB: document.getElementById('pctBajista').value,
      riesgo: document.getElementById('riesgoPct').value,
      dd: document.getElementById('ddPct').value,
      maxPos: document.getElementById('maxPos').value
    }));
  } catch(e) {}
}

function resetAllData() {
  if (!confirm('Â¿Borrar TODAS las operaciones? Esta acciÃ³n no se puede deshacer.')) return;
  DATA.bull = { closed: [], open: [], enriched: [] };
  DATA.bear = { closed: [], open: [], enriched: [] };
  saveData();
  recalcAll();
}

renderVolInputs();
recalcAll();
</script>
</div>
</body>
</html>

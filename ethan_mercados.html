<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ethan mercados ¬∑ Cartera</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#040e0e;--surface:#071717;--surface2:#0b1f1f;--surface3:#0f2828;
  --border:#1a3c3c;--border2:#245050;
  --accent:#40d9c0;--accent2:#2ba897;--accent-glow:rgba(64,217,192,0.10);
  --bull:#4ade80;--bull-dim:rgba(74,222,128,0.10);--bull-border:rgba(74,222,128,0.25);
  --bear:#f47174;--bear-dim:rgba(244,113,116,0.10);--bear-border:rgba(244,113,116,0.25);
  --warn:#fbbf24;--warn-dim:rgba(251,191,36,0.10);
  --text:#d0e8e4;--text2:#9cb8b4;--text3:#4a706a;
  --radius:12px;--radius-sm:8px;
  --font:'Montserrat',sans-serif;--mono:'IBM Plex Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.app{max-width:1440px;margin:0 auto;padding:20px 24px 60px}
header{display:flex;align-items:center;justify-content:space-between;padding:20px 0 24px;border-bottom:1px solid var(--border);margin-bottom:24px;flex-wrap:wrap;gap:16px}
.brand{display:flex;align-items:center;gap:14px}
.brand-icon{width:44px;height:44px;background:linear-gradient(135deg,#0f2828,#133232);border:1px solid var(--accent);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;letter-spacing:-1px;font-family:var(--mono)}
.brand h1{font-size:22px;font-weight:700;letter-spacing:-0.5px}
.brand p{font-size:12px;color:var(--text2);margin-top:1px}

/* TABS */
.tabs{display:flex;gap:4px;background:var(--surface);border-radius:var(--radius);padding:4px;margin-bottom:20px;border:1px solid var(--border)}
.tab{padding:10px 22px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text2);border:none;background:none;font-family:var(--font)}
.tab:hover{color:var(--text);background:var(--surface2)}
.tab.active{background:var(--accent-glow);color:var(--accent);border:1px solid rgba(59,130,246,0.3)}
.sub-tabs{display:flex;gap:4px;margin-bottom:20px}
.sub-tab{padding:8px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text3);border:1px solid var(--border);background:var(--surface);font-family:var(--font)}
.sub-tab:hover{color:var(--text2);border-color:var(--border2)}
.sub-tab.active-bull{background:var(--bull-dim);color:var(--bull);border-color:var(--bull-border)}
.sub-tab.active-bear{background:var(--bear-dim);color:var(--bear);border-color:var(--bear-border)}
.sub-tab.active-gen{background:var(--accent-glow);color:var(--accent);border-color:rgba(59,130,246,0.3)}
.view{display:none}.view.active{display:block}
.sub-view{display:none}.sub-view.active{display:block}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:16px;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:0.5px}
.card-title span{font-size:16px}

/* KPIs */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi.green::before{background:var(--bull)}.kpi.red::before{background:var(--bear)}.kpi.blue::before{background:var(--accent)}.kpi.purple::before{background:var(--accent2)}.kpi.yellow::before{background:var(--warn)}
.kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:0.6px;color:var(--text2);margin-bottom:6px;font-weight:500}
.kpi-value{font-size:26px;font-weight:700;font-family:var(--mono);letter-spacing:-1px;line-height:1.1}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:4px;font-family:var(--mono)}
.kpi-value.green{color:var(--bull)}.kpi-value.red{color:var(--bear)}.kpi-value.blue{color:var(--accent)}.kpi-value.yellow{color:var(--warn)}.kpi-value.purple{color:var(--accent2)}

/* TABLES */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:var(--surface2);padding:10px 14px;text-align:left;font-weight:600;color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;position:sticky;top:0}
td{padding:10px 14px;border-top:1px solid var(--border);white-space:nowrap}
tr:hover td{background:var(--surface2)}
.ticker{font-family:var(--mono);font-weight:600;font-size:12px;background:var(--surface2);padding:2px 8px;border-radius:4px}
.badge-green{color:var(--bull);background:var(--bull-dim);padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:12px;font-weight:600}
.badge-red{color:var(--bear);background:var(--bear-dim);padding:2px 8px;border-radius:4px;font-family:var(--mono);font-size:12px;font-weight:600}

/* FORMS */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group label{font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text2);font-weight:500}
input[type="number"],input[type="text"],input[type="date"],select{
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;width:100%;transition:border-color .2s}
input:focus,select:focus{border-color:var(--accent)}
input[type="range"]{-webkit-appearance:none;background:var(--surface2);height:6px;border-radius:3px;outline:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid var(--surface)}
.btn{padding:9px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:var(--font)}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#2563eb}
.btn-success{background:var(--bull);color:#fff}.btn-success:hover{background:#059669}
.btn-danger{background:var(--bear);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text2)}.btn-outline:hover{border-color:var(--text);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:11px}

/* STRAT TABS */
.strat-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px}
.strat-tab{padding:7px 14px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .2s;font-family:var(--font)}
.strat-tab:hover{border-color:var(--accent);color:var(--text)}
.strat-tab.active{background:var(--accent-glow);color:var(--accent);border-color:rgba(59,130,246,0.4)}
.strat-view{display:none}.strat-view.active{display:block}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
.mb-sm{margin-bottom:14px}.mb-md{margin-bottom:20px}.mb-lg{margin-bottom:28px}

.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-box canvas{max-height:300px}

.semaforo{display:flex;gap:12px;align-items:center;padding:14px 18px;border-radius:var(--radius);font-weight:600;font-size:14px}
.semaforo.verde{background:var(--bull-dim);border:1px solid var(--bull-border);color:var(--bull)}
.semaforo.amarillo{background:var(--warn-dim);border:1px solid rgba(245,158,11,0.3);color:var(--warn)}
.semaforo.rojo{background:var(--bear-dim);border:1px solid var(--bear-border);color:var(--bear)}
.semaforo-dot{width:14px;height:14px;border-radius:50%;animation:pulse 2s infinite}
.semaforo.verde .semaforo-dot{background:var(--bull)}
.semaforo.amarillo .semaforo-dot{background:var(--warn)}
.semaforo.rojo .semaforo-dot{background:var(--bear)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.proj-row{display:grid;grid-template-columns:60px 1fr 100px;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.proj-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .5s ease}

.empty-state{text-align:center;padding:40px 20px;color:var(--text3)}
.empty-state p{font-size:14px;margin-bottom:8px}
.empty-state small{font-size:12px}
.close-pos-btn{font-size:10px;padding:4px 12px;background:var(--bear-dim);color:var(--bear);border:1px solid var(--bear-border);border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font);font-weight:600;transition:all .2s}
.close-pos-btn:hover{background:var(--bear);color:#fff}

@media(max-width:900px){.g2,.g3{grid-template-columns:1fr}.kpi-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.app{padding:12px 10px}.kpi-grid{grid-template-columns:1fr}.tabs,.sub-tabs{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<header>
  <div class="brand">
    <div class="brand-icon">E</div>
    <div><h1 style="font-family:'Cormorant Garamond',serif;font-weight:300;letter-spacing:2px">ETHAN <span style="font-weight:600">Mercados</span></h1><p>Cartera & Risk Management</p></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span style="font-family:var(--mono);font-size:12px;color:var(--text2)" id="lastUpdate"></span>
    <button class="btn btn-sm btn-outline" onclick="resetAllData()" style="font-size:10px;opacity:0.6">Resetear datos</button>
  </div>
</header>

<!-- CAPITAL BAR (siempre visible) -->
<div class="card mb-md" style="display:flex;flex-wrap:wrap;gap:20px;align-items:flex-end">
  <div class="form-group" style="min-width:180px">
    <label>Capital Total (‚Ç¨)</label>
    <input type="number" id="capitalTotal" value="10000" min="100" step="100" oninput="recalcAll()">
  </div>
  <div class="form-group" style="min-width:140px">
    <label>% RV Alcista</label>
    <input type="number" id="pctAlcista" value="50" min="0" max="100" step="5" oninput="recalcAll()">
  </div>
  <div class="form-group" style="min-width:140px">
    <label>% RV Bajista</label>
    <input type="number" id="pctBajista" value="50" min="0" max="100" step="5" oninput="recalcAll()">
  </div>
  <div style="font-family:var(--mono);font-size:13px;color:var(--text2)">
    Alcista: <strong id="euroAlcista" style="color:var(--bull)">‚Ç¨5,000</strong> ¬∑ 
    Bajista: <strong id="euroBajista" style="color:var(--bear)">‚Ç¨5,000</strong>
  </div>
</div>

<!-- 2 MAIN TABS -->
<div class="tabs">
  <button class="tab active" data-view="cartera" onclick="switchMain('cartera')">üìä Cartera</button>
  <button class="tab" data-view="risk" onclick="switchMain('risk')">‚öôÔ∏è Risk Management</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- VIEW: CARTERA                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="view-cartera">
  <div class="sub-tabs">
    <button class="sub-tab active-bull" data-sub="bull" onclick="switchSub('bull')">üìà RV Alcista</button>
    <button class="sub-tab" data-sub="bear" onclick="switchSub('bear')">üìâ RV Bajista</button>
    <button class="sub-tab" data-sub="general" onclick="switchSub('general')">üìä General + Proyecciones</button>
  </div>

  <!-- SUB: BULL -->
  <div class="sub-view active" id="sub-bull">
    <div class="kpi-grid" id="kpi-bull"></div>
    <div class="g2 mb-md">
      <div class="card">
        <div class="card-title"><span>üìã</span> Operaciones Cerradas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Salida</th><th>P.Ent</th><th>P.Sal</th><th>Capital</th><th>P/L ‚Ç¨</th><th>P/L %</th><th>D√≠as</th></tr></thead>
          <tbody id="tb-bull-closed"></tbody></table>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>üü¢</span> Posiciones Abiertas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Precio</th><th>Capital</th><th>Peso</th><th>Acc.</th><th></th></tr></thead>
          <tbody id="tb-bull-open"></tbody></table>
        </div>
      </div>
    </div>
    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>üìä</span> P/L por Operaci√≥n</div><canvas id="chart-bull-pl"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>üìà</span> Equity Curve</div><canvas id="chart-bull-equity"></canvas></div>
    </div>
    <div class="card mb-md">
      <div class="card-title"><span>‚ûï</span> A√±adir Operaci√≥n Alcista</div>
      <div class="form-grid mb-sm">
        <div class="form-group"><label>Valor</label><input type="text" id="add-bull-valor" placeholder="APPLE"></div>
        <div class="form-group"><label>Ticker</label><input type="text" id="add-bull-ticker" placeholder="AAPL"></div>
        <div class="form-group"><label>F. Entrada</label><input type="date" id="add-bull-fentrada"></div>
        <div class="form-group"><label>F. Salida (vac√≠o=abierta)</label><input type="date" id="add-bull-fsalida"></div>
        <div class="form-group"><label>P. Entrada (‚Ç¨)</label><input type="number" id="add-bull-pentrada" step="0.01"></div>
        <div class="form-group"><label>P. Salida (‚Ç¨)</label><input type="number" id="add-bull-psalida" step="0.01"></div>
        <div class="form-group"><label>Capital (‚Ç¨)</label><input type="number" id="add-bull-capital" step="100"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-success" onclick="addOp('bull')">A√±adir</button></div>
      </div>
    </div>
  </div>

  <!-- SUB: BEAR -->
  <div class="sub-view" id="sub-bear">
    <div class="kpi-grid" id="kpi-bear"></div>
    <div class="g2 mb-md">
      <div class="card">
        <div class="card-title"><span>üìã</span> Operaciones Cerradas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Salida</th><th>P.Ent</th><th>P.Sal</th><th>Capital</th><th>P/L ‚Ç¨</th><th>P/L %</th><th>D√≠as</th></tr></thead>
          <tbody id="tb-bear-closed"></tbody></table>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span>üî¥</span> Posiciones Abiertas</div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto">
          <table><thead><tr><th>Valor</th><th>Ticker</th><th>Entrada</th><th>Precio</th><th>Capital</th><th>Peso</th><th>Acc.</th><th></th></tr></thead>
          <tbody id="tb-bear-open"></tbody></table>
        </div>
      </div>
    </div>
    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>üìä</span> P/L por Operaci√≥n</div><canvas id="chart-bear-pl"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>üìà</span> Equity Curve</div><canvas id="chart-bear-equity"></canvas></div>
    </div>
    <div class="card mb-md">
      <div class="card-title"><span>‚ûï</span> A√±adir Operaci√≥n Bajista</div>
      <div class="form-grid mb-sm">
        <div class="form-group"><label>Valor</label><input type="text" id="add-bear-valor" placeholder="TESLA"></div>
        <div class="form-group"><label>Ticker</label><input type="text" id="add-bear-ticker" placeholder="TSLA"></div>
        <div class="form-group"><label>F. Entrada</label><input type="date" id="add-bear-fentrada"></div>
        <div class="form-group"><label>F. Salida (vac√≠o=abierta)</label><input type="date" id="add-bear-fsalida"></div>
        <div class="form-group"><label>P. Entrada (‚Ç¨)</label><input type="number" id="add-bear-pentrada" step="0.01"></div>
        <div class="form-group"><label>P. Salida (‚Ç¨)</label><input type="number" id="add-bear-psalida" step="0.01"></div>
        <div class="form-group"><label>Capital (‚Ç¨)</label><input type="number" id="add-bear-capital" step="100"></div>
        <div class="form-group" style="justify-content:flex-end"><button class="btn btn-danger" onclick="addOp('bear')">A√±adir</button></div>
      </div>
    </div>
  </div>

  <!-- SUB: GENERAL + AN√ÅLISIS INSTITUCIONAL -->
  <div class="sub-view" id="sub-general">
    <div class="kpi-grid" id="kpi-general"></div>

    <div class="g2 mb-md">
      <div class="chart-box"><div class="card-title"><span>‚öñÔ∏è</span> Comparativa Alcista vs Bajista</div><canvas id="chart-compare"></canvas></div>
      <div class="chart-box"><div class="card-title"><span>üìà</span> Equity Curve Combinada</div><canvas id="chart-general-equity"></canvas></div>
    </div>

    <!-- BLOQUE 1: RENTABILIDAD -->
    <div class="card mb-md" style="border-color:var(--accent)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>üìä</span> 1. RENTABILIDAD</div>
      <div class="g2 mb-sm"><div id="rent-serie-mensual"></div><div id="rent-serie-anual"></div></div>
      <div class="kpi-grid mb-sm" id="kpi-rent"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>üìÖ</span> Rentabilidad Mensual (% cartera)</div><canvas id="chart-rent-mensual"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>üîÑ</span> Rolling Returns (temporal)</div><canvas id="chart-rolling"></canvas></div>
      </div>
      <div id="rent-benchmark"></div>
    </div>

    <!-- BLOQUE 2: RIESGO -->
    <div class="card mb-md" style="border-color:var(--bear)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>‚ö†Ô∏è</span> 2. RIESGO (nivel fondo)</div>
      <div class="kpi-grid mb-sm" id="kpi-riesgo"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>üìâ</span> Drawdown Hist√≥rico (% cartera)</div><canvas id="chart-drawdown"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>üìä</span> Distribuci√≥n de Retornos</div><canvas id="chart-distrib"></canvas></div>
      </div>
      <div id="risk-detail"></div>
    </div>

    <!-- BLOQUE 3: EFICIENCIA -->
    <div class="card mb-md" style="border-color:var(--warn)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>‚ö°</span> 3. EFICIENCIA RIESGO-RETORNO</div>
      <div class="kpi-grid mb-sm" id="kpi-eficiencia"></div>
      <div id="eficiencia-detail"></div>
    </div>

    <!-- BLOQUE 4: PROBABILIDAD -->
    <div class="card mb-md" style="border-color:rgba(168,85,247,0.5)">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>üéØ</span> 4. PROBABILIDAD & ROBUSTEZ</div>
      <div class="kpi-grid mb-sm" id="kpi-prob"></div>
      <div class="g2 mb-sm">
        <div class="chart-box"><div class="card-title"><span>üé≤</span> Monte Carlo (1000 sims ¬∑ sizing real)</div><canvas id="chart-montecarlo"></canvas></div>
        <div class="chart-box"><div class="card-title"><span>üìà</span> Prob. de Alcanzar Objetivo</div><canvas id="chart-prob-obj"></canvas></div>
      </div>
      <div class="g2 mb-sm"><div id="stress-test"></div><div id="prob-detail"></div></div>
    </div>

    <!-- PROYECCIONES -->
    <div class="card mb-md">
      <div class="card-title" style="font-size:15px;margin-bottom:16px"><span>üöÄ</span> PROYECCIONES & ESCENARIOS</div>
      <div class="kpi-grid mb-sm" id="kpi-proj"></div>
      <div class="g2 mb-sm">
        <div><p style="font-size:12px;color:var(--text2);margin-bottom:14px">Basado en rentabilidad media √ó sizing actual, con reinversi√≥n compuesta.</p><div id="proj-table"></div></div>
        <div class="chart-box"><div class="card-title"><span>üìà</span> Curva de Crecimiento</div><canvas id="chart-projection"></canvas></div>
      </div>
      <div class="g2"><div id="dd-analysis"></div><div id="scenarios"></div></div>
    </div>

    <div id="serie-mensual-raw" style="display:none"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- VIEW: RISK MANAGEMENT                      -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-risk">
  <!-- CALCULADORA DE POSICI√ìN -->
  <div class="card mb-md" style="border-color:var(--accent)">
    <div class="card-title"><span>üìê</span> Calculadora de Tama√±o de Posici√≥n</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px">Calcula cu√°ntas acciones comprar y cu√°nto capital invertir para cada operaci√≥n que quieras abrir.</p>
    <div class="form-grid mb-sm">
      <div class="form-group"><label>Ticker / Valor</label><input type="text" id="sz-ticker" placeholder="Ej: AAPL" oninput="calcSizing()"></div>
      <div class="form-group"><label>Precio de Entrada (‚Ç¨)</label><input type="number" id="sz-precio" step="0.01" placeholder="150.00" oninput="calcSizing()"></div>
      <div class="form-group"><label>Stop Loss (‚Ç¨)</label><input type="number" id="sz-stop" step="0.01" placeholder="145.00" oninput="calcSizing()"></div>
      <div class="form-group"><label>Take Profit (‚Ç¨) <span style="color:var(--text3)">(opcional)</span></label><input type="number" id="sz-tp" step="0.01" placeholder="165.00" oninput="calcSizing()"></div>
    </div>
    <div id="sz-result"></div>
  </div>

  <div id="semaforo-container" class="mb-md"></div>

  <div class="card mb-md">
    <div class="card-title"><span>üéØ</span> Configuraci√≥n de Riesgo</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Riesgo por Operaci√≥n (%)</label>
        <input type="range" id="riesgoPct" min="0.5" max="5" step="0.25" value="1" oninput="recalcAll()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)"><span>0.5%</span><span id="riesgoPctVal" style="color:var(--accent);font-weight:700">1%</span><span>5%</span></div>
      </div>
      <div class="form-group">
        <label>Drawdown M√°x. Tolerable (%)</label>
        <input type="range" id="ddPct" min="5" max="30" step="1" value="10" oninput="recalcAll()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3)"><span>5%</span><span id="ddPctVal" style="color:var(--bear);font-weight:700">10%</span><span>30%</span></div>
      </div>
      <div class="form-group">
        <label>Posiciones Simult√°neas M√°x.</label>
        <input type="number" id="maxPos" value="3" min="1" max="20" oninput="recalcAll()">
      </div>
    </div>
  </div>

  <div class="kpi-grid mb-md" id="kpi-risk"></div>

  <!-- 7 Strategy tabs -->
  <div class="strat-tabs">
    <button class="strat-tab active" onclick="switchStrat('pctfijo')">% Fijo</button>
    <button class="strat-tab" onclick="switchStrat('kelly')">Kelly</button>
    <button class="strat-tab" onclick="switchStrat('martingala')">Martingala</button>
    <button class="strat-tab" onclick="switchStrat('antimartingala')">Anti-Martingala</button>
    <button class="strat-tab" onclick="switchStrat('fibonacci')">Fibonacci</button>
    <button class="strat-tab" onclick="switchStrat('parabolico')">Parab√≥lico</button>
    <button class="strat-tab" onclick="switchStrat('volatilidad')">Por Volatilidad</button>
  </div>

  <!-- % Fijo -->
  <div class="strat-view active" id="strat-pctfijo">
    <div class="g2">
      <div class="card">
        <div class="card-title"><span>üìê</span> % Fijo del Capital</div>
        <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Arriesgas un porcentaje fijo en cada operaci√≥n. La m√°s recomendada.</p>
        <div class="form-group mb-sm"><label>Stop Loss (‚Ç¨ desde entrada)</label><input type="number" id="pf-sl" value="2" step="0.1" oninput="calcPctFijo()"></div>
        <div id="pf-result"></div>
      </div>
      <div class="card">
        <div class="card-title"><span>üìâ</span> Simulaci√≥n de Rachas Perdedoras</div>
        <div id="pf-racha"></div>
      </div>
    </div>
  </div>

  <!-- Kelly -->
  <div class="strat-view" id="strat-kelly"><div class="g2">
    <div class="card"><div class="card-title"><span>üßÆ</span> Criterio de Kelly</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Fracci√≥n √≥ptima para maximizar crecimiento a largo plazo. Se alimenta de tu Win Rate y ratios reales.</p>
      <div id="kelly-result"></div></div>
    <div class="card"><div class="card-title"><span>üìä</span> Full vs Half vs Quarter</div><div id="kelly-comparison"></div></div>
  </div></div>

  <!-- Martingala -->
  <div class="strat-view" id="strat-martingala"><div class="g2">
    <div class="card"><div class="card-title"><span>‚ö†Ô∏è</span> Martingala (Alto Riesgo)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Doblas la apuesta tras cada p√©rdida. Extremadamente peligrosa.</p>
      <div class="form-group mb-sm"><label>Apuesta Inicial (‚Ç¨)</label><input type="number" id="mg-apuesta" value="100" step="10" oninput="calcMartingala()"></div>
      <div id="mg-result"></div></div>
    <div class="card"><div class="card-title"><span>üíÄ</span> Tabla de Destrucci√≥n</div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Apuesta</th><th>P√©rdida Acum.</th><th>% Capital</th><th>Estado</th></tr></thead><tbody id="mg-table"></tbody></table></div></div>
  </div></div>

  <!-- Anti-Martingala -->
  <div class="strat-view" id="strat-antimartingala"><div class="g2">
    <div class="card"><div class="card-title"><span>üîÑ</span> Anti-Martingala (Paroli)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Doblas tras cada ganancia, reset tras p√©rdida.</p>
      <div class="form-group mb-sm"><label>Apuesta Base (‚Ç¨)</label><input type="number" id="am-apuesta" value="100" step="10" oninput="calcAntiMartingala()"></div>
      <div class="form-group mb-sm"><label>Reset tras X ganancias</label><input type="number" id="am-reset" value="3" min="2" max="10" oninput="calcAntiMartingala()"></div>
      <div id="am-result"></div></div>
    <div class="card"><div class="card-title"><span>üìä</span> Tabla de Progresi√≥n</div>
      <div class="table-wrap"><table><thead><tr><th>#</th><th>Apuesta</th><th>Ganancia Acum.</th><th>Acci√≥n</th></tr></thead><tbody id="am-table"></tbody></table></div></div>
  </div></div>

  <!-- Fibonacci -->
  <div class="strat-view" id="strat-fibonacci"><div class="g2">
    <div class="card"><div class="card-title"><span>üåÄ</span> Secuencia Fibonacci</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Aumentas siguiendo Fibonacci tras cada p√©rdida.</p>
      <div class="form-group mb-sm"><label>Unidad Base (‚Ç¨)</label><input type="number" id="fib-base" value="50" step="10" oninput="calcFibonacci()"></div>
      <div id="fib-result"></div></div>
    <div class="card"><div class="card-title"><span>üìä</span> Secuencia</div>
      <div class="table-wrap"><table><thead><tr><th>Paso</th><th>Mult.</th><th>Apuesta</th><th>Acum.</th><th>Estado</th></tr></thead><tbody id="fib-table"></tbody></table></div></div>
  </div></div>

  <!-- Parab√≥lico -->
  <div class="strat-view" id="strat-parabolico"><div class="g2">
    <div class="card"><div class="card-title"><span>üìà</span> Parab√≥lico (Power of Profits)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">Escalas usando solo ganancias acumuladas. Capital original protegido.</p>
      <div class="form-group mb-sm"><label>Delta de escalado (%)</label><input type="number" id="par-delta" value="25" min="5" max="100" step="5" oninput="calcParabolico()"></div>
      <div id="par-result"></div></div>
    <div class="card"><div class="card-title"><span>üìä</span> Niveles de Escalado</div>
      <div class="table-wrap"><table><thead><tr><th>Nivel</th><th>Beneficio Necesario</th><th>Sizing</th><th>Aumento</th></tr></thead><tbody id="par-table"></tbody></table></div></div>
  </div></div>

  <!-- Volatilidad -->
  <div class="strat-view" id="strat-volatilidad">
    <div class="card">
      <div class="card-title"><span>‚ö°</span> Sizing por Volatilidad Inversa (ATR)</div>
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px">M√°s capital a activos menos vol√°tiles, igualando riesgo real.</p>
      <div id="vol-inputs" class="mb-sm"></div>
      <button class="btn btn-outline btn-sm" onclick="addVolRow()">+ A√±adir Activo</button>
      <div id="vol-result" style="margin-top:16px"></div>
    </div>
  </div>
</div>

<!-- MODAL CERRAR POSICI√ìN -->
<div id="close-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:28px;width:380px;max-width:90vw">
    <div style="font-size:14px;font-weight:600;margin-bottom:18px;color:var(--text)">Cerrar Posici√≥n: <span id="cm-name" style="color:var(--accent)"></span></div>
    <div class="form-group mb-sm"><label>Fecha de Salida</label><input type="date" id="cm-fecha"></div>
    <div class="form-group mb-sm"><label>Precio de Salida (‚Ç¨)</label><input type="number" id="cm-precio" step="0.01" placeholder="0.00"></div>
    <div id="cm-preview" style="margin:14px 0;font-size:13px;font-family:var(--mono);color:var(--text2)"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-success" onclick="confirmClose()">Cerrar Posici√≥n</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- JAVASCRIPT                                 -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ DATA + PERSISTENCE ‚îÄ‚îÄ
var DATA = loadData();

function loadData() {
  try {
    var saved = localStorage.getItem('ethan_cartera');
    if (saved) {
      var d = JSON.parse(saved);
      if (d.bull && d.bear) {
        d.bull.enriched = [];
        d.bear.enriched = [];
        return d;
      }
    }
  } catch(e) { console.log('No saved data'); }
  return { bull: { closed: [], open: [] }, bear: { closed: [], open: [] } };
}

function saveData() {
  try {
    var toSave = {
      bull: { closed: DATA.bull.closed, open: DATA.bull.open },
      bear: { closed: DATA.bear.closed, open: DATA.bear.open }
    };
    localStorage.setItem('ethan_cartera', JSON.stringify(toSave));
  } catch(e) { console.log('Save error', e); }
}

function enrichOps(ops, isBear) {
  return ops.map(op => {
    const dias = Math.round((new Date(op.fs) - new Date(op.fe)) / 86400000);
    const acciones = op.cap / op.pe;
    let pl, pct;
    if (isBear) { pl = acciones * (op.pe - op.ps); pct = (op.pe - op.ps) / op.pe; }
    else { pl = acciones * (op.ps - op.pe); pct = (op.ps - op.pe) / op.pe; }
    return { ...op, dias, acciones, pl: Math.round(pl * 100) / 100, pct };
  });
}
DATA.bull.enriched = enrichOps(DATA.bull.closed, false);
DATA.bear.enriched = enrichOps(DATA.bear.closed, true);

// ‚îÄ‚îÄ CALC RATIOS ‚îÄ‚îÄ
function calcRatios(ops) {
  if (!ops.length) return null;
  const totalPL = ops.reduce((s,o) => s+o.pl, 0);
  const winners = ops.filter(o => o.pl > 0), losers = ops.filter(o => o.pl <= 0);
  const winRate = winners.length / ops.length;
  const avgWinPct = winners.length ? winners.reduce((s,o) => s+o.pct, 0)/winners.length : 0;
  const avgLossPct = losers.length ? Math.abs(losers.reduce((s,o) => s+o.pct, 0)/losers.length) : 0;
  const esperanza = winRate * avgWinPct - (1-winRate) * avgLossPct;
  const rents = ops.map(o => o.pct);
  const meanRent = rents.reduce((s,r) => s+r, 0)/rents.length;
  const stdRent = Math.sqrt(rents.reduce((s,r) => s+(r-meanRent)**2, 0)/rents.length);
  const sharpe = stdRent > 0 ? meanRent/stdRent : 0;
  const diasArr = ops.map(o => o.dias).filter(d => d > 0);
  const diasMedio = diasArr.length ? diasArr.reduce((s,d) => s+d, 0)/diasArr.length : 0;
  const maxWin = ops.reduce((a,b) => a.pct > b.pct ? a : b);
  const maxLoss = ops.reduce((a,b) => a.pct < b.pct ? a : b);
  const opsAnio = diasMedio > 0 ? 365.25/diasMedio : 0;
  const grossWin = winners.reduce((s,o) => s+o.pl, 0);
  const grossLoss = Math.abs(losers.reduce((s,o) => s+o.pl, 0));
  const profitFactor = grossLoss > 0 ? grossWin/grossLoss : Infinity;
  let maxConsecLoss = 0, cl = 0;
  ops.forEach(o => { if (o.pl <= 0) { cl++; maxConsecLoss = Math.max(maxConsecLoss, cl); } else cl = 0; });
  return { totalPL, winRate, avgWinPct, avgLossPct, esperanza, sharpe, diasMedio, maxWin, maxLoss, opsAnio, rentMedia: meanRent, profitFactor, maxConsecLoss, winners: winners.length, losers: losers.length, total: ops.length, stdRent };
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
const charts = {};
function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

// ‚îÄ‚îÄ FORMATTERS ‚îÄ‚îÄ
function fmt(n, d=2) { return n.toFixed(d); }
function fmtE(n) { return '‚Ç¨'+n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtPct(n) { return (n>=0?'+':'')+(n*100).toFixed(2)+'%'; }
function fmtK(n) { return n>=1000 ? '‚Ç¨'+(n/1000).toFixed(1)+'k' : fmtE(n); }

// ‚îÄ‚îÄ RENDER KPIs ‚îÄ‚îÄ
function renderKPIs(id, r, color) {
  const c = document.getElementById(id);
  if (!r) { c.innerHTML = '<div class="empty-state"><p>Sin operaciones cerradas</p><small>A√±ade operaciones con el formulario de abajo</small></div>'; return; }
  const cl = color==='bull'?'green':color==='bear'?'red':'blue';
  c.innerHTML = `
    <div class="kpi ${cl}"><div class="kpi-label">P/L Total</div><div class="kpi-value ${r.totalPL>=0?'green':'red'}">${fmtE(r.totalPL)}</div><div class="kpi-sub">${r.total} operaciones</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Win Rate</div><div class="kpi-value">${(r.winRate*100).toFixed(1)}%</div><div class="kpi-sub">${r.winners}W / ${r.losers}L</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Rent. Media/Op</div><div class="kpi-value ${r.rentMedia>=0?'green':'red'}">${fmtPct(r.rentMedia)}</div><div class="kpi-sub">${fmt(r.diasMedio,0)} d√≠as ¬∑ ${fmt(r.opsAnio,1)} ops/a√±o</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Esperanza Mat.</div><div class="kpi-value ${r.esperanza>=0?'green':'red'}">${fmtPct(r.esperanza)}</div><div class="kpi-sub">Sharpe: ${fmt(r.sharpe)}</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">Profit Factor</div><div class="kpi-value">${r.profitFactor===Infinity?'‚àû':fmt(r.profitFactor)}</div><div class="kpi-sub">AvgW: ${fmtPct(r.avgWinPct)} ¬∑ AvgL: -${(r.avgLossPct*100).toFixed(2)}%</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">M√°x Ganancia</div><div class="kpi-value green">${fmtPct(r.maxWin.pct)}</div><div class="kpi-sub">${r.maxWin.ticker} ¬∑ ${r.maxWin.dias}d</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">M√°x P√©rdida</div><div class="kpi-value red">${fmtPct(r.maxLoss.pct)}</div><div class="kpi-sub">${r.maxLoss.ticker} ¬∑ ${r.maxLoss.dias}d</div></div>
    <div class="kpi ${cl}"><div class="kpi-label">M√°x Rachas Perd.</div><div class="kpi-value red">${r.maxConsecLoss}</div><div class="kpi-sub">consecutivas</div></div>`;
}

function renderTable(tbId, ops) {
  document.getElementById(tbId).innerHTML = ops.length ? ops.map(o => `<tr>
    <td><strong>${o.valor}</strong></td><td><span class="ticker">${o.ticker}</span></td>
    <td>${new Date(o.fe).toLocaleDateString('es-ES')}</td><td>${new Date(o.fs).toLocaleDateString('es-ES')}</td>
    <td>${fmtE(o.pe)}</td><td>${fmtE(o.ps)}</td><td>${fmtE(o.cap)}</td>
    <td><span class="${o.pl>=0?'badge-green':'badge-red'}">${fmtE(o.pl)}</span></td>
    <td><span class="${o.pct>=0?'badge-green':'badge-red'}">${fmtPct(o.pct)}</span></td>
    <td>${o.dias}d</td></tr>`).join('') : '<tr><td colspan="10" style="text-align:center;color:var(--text3)">‚Äî</td></tr>';
}

function renderOpenTable(tbId, ops, type) {
  const tb = document.getElementById(tbId);
  tb.innerHTML = ops.length ? ops.map((o,i) => '<tr>' +
    '<td><strong>' + o.valor + '</strong></td>' +
    '<td><span class="ticker">' + o.ticker + '</span></td>' +
    '<td>' + new Date(o.fe).toLocaleDateString('es-ES') + '</td>' +
    '<td>' + fmtE(o.pe) + '</td>' +
    '<td>' + fmtE(o.cap) + '</td>' +
    '<td>' + (o.peso*100).toFixed(0) + '%</td>' +
    '<td>' + (o.cap/o.pe).toFixed(2) + '</td>' +
    '<td><button class="close-pos-btn" data-type="' + type + '" data-idx="' + i + '">&#10005; Cerrar</button></td>' +
    '</tr>').join('') : '<tr><td colspan="8" style="text-align:center;color:var(--text3)">&mdash;</td></tr>';
}

function renderPLChart(canvasId, ops, cPos, cNeg) {
  destroyChart(canvasId);
  if (!ops.length) return;
  charts[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
    type:'bar', data:{labels:ops.map(o=>o.ticker),datasets:[{data:ops.map(o=>o.pl),backgroundColor:ops.map(o=>o.pl>=0?cPos:cNeg),borderRadius:4}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtE(c.parsed.y)}}},scales:{y:{ticks:{callback:v=>'‚Ç¨'+v,color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });
}

function renderEquityChart(canvasId, ops, color) {
  destroyChart(canvasId);
  if (!ops.length) return;
  let eq = [0]; ops.forEach((o,i) => eq.push(eq[i]+o.pl));
  charts[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
    type:'line', data:{labels:['Inicio',...ops.map(o=>o.ticker)],datasets:[{data:eq,borderColor:color,backgroundColor:color+'20',fill:true,tension:.3,pointRadius:4,pointBackgroundColor:color}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtE(c.parsed.y)}}},scales:{y:{ticks:{callback:v=>'‚Ç¨'+v,color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });
}


// ‚îÄ‚îÄ INSTITUTIONAL ANALYTICS (v2 ‚Äî corrected) ‚îÄ‚îÄ

// FIX 1: Portfolio-level impact per operation (P/L √∑ total capital)
function enrichPortfolioImpact(ops, totalCapital) {
  return ops.map(o => ({ ...o, impactoCartera: o.pl / totalCapital, pesoOp: o.cap / totalCapital }));
}

// Monthly series using portfolio-level impacts (not position returns)
function buildMonthlySeries(ops) {
  if (!ops.length) return [];
  var sorted = ops.slice().sort(function(a,b){ return new Date(a.fs) - new Date(b.fs); });
  var months = {};
  sorted.forEach(function(op) {
    var m = op.fs.substring(0,7);
    if (!months[m]) months[m] = [];
    months[m].push(op);
  });
  var series = [];
  Object.keys(months).sort().forEach(function(m) {
    var mOps = months[m];
    var rentMes = mOps.reduce(function(s,o){ return s + o.impactoCartera; }, 0);
    var rentPosMedia = mOps.reduce(function(s,o){ return s + o.pct; }, 0) / mOps.length;
    var plMes = mOps.reduce(function(s,o){ return s + o.pl; }, 0);
    series.push({ month: m, rentMes: rentMes, rentPosMedia: rentPosMedia, plMes: plMes, nOps: mOps.length });
  });
  var acumF = 1;
  series.forEach(function(m) { acumF *= (1 + m.rentMes); m.acumPct = acumF - 1; });
  return series;
}

function buildAnnualSeries(monthly) {
  var years = {};
  monthly.forEach(function(m) {
    var y = m.month.substring(0,4);
    if (!years[y]) years[y] = { nOps: 0, rc: 1, pl: 0 };
    years[y].nOps += m.nOps;
    years[y].rc *= (1 + m.rentMes);
    years[y].pl += m.plMes;
  });
  return Object.keys(years).sort().map(function(y) {
    return { year: y, nOps: years[y].nOps, rentAnual: years[y].rc - 1, plTotal: years[y].pl };
  });
}

// FIX 5: Rolling by CALENDAR MONTHS, not by op count
function calcRollingMonths(monthly, windowMonths) {
  if (monthly.length < windowMonths) return [];
  var result = [];
  for (var i = windowMonths; i <= monthly.length; i++) {
    var slice = monthly.slice(i - windowMonths, i);
    var cum = 1;
    slice.forEach(function(m){ cum *= (1 + m.rentMes); });
    result.push({ endMonth: slice[slice.length-1].month, ret: cum - 1 });
  }
  return result;
}

// FIX 2: Drawdown on portfolio % using growth factor (starts at 1.0, never divides by 0)
function calcDrawdownSeries(opsP) {
  if (!opsP.length) return { maxDD: 0, ddDuration: 0, ddSeries: [], eqFactors: [] };
  var factor = 1, peak = 1, maxDD = 0, maxDur = 0;
  var ddStart = -1, inDD = false;
  var eqFactors = [1], ddSeries = [];
  opsP.forEach(function(o, i) {
    factor *= (1 + o.impactoCartera);
    eqFactors.push(factor);
    if (factor > peak) {
      peak = factor;
      if (inDD) { maxDur = Math.max(maxDur, i - ddStart); inDD = false; }
    } else if (!inDD) { inDD = true; ddStart = i; }
    var dd = (factor - peak) / peak;
    if (dd < maxDD) maxDD = dd;
    ddSeries.push(dd);
  });
  if (inDD) maxDur = Math.max(maxDur, opsP.length - ddStart);
  return { maxDD: maxDD, ddDuration: maxDur, ddSeries: ddSeries, eqFactors: eqFactors };
}

function calcDownsideDeviation(impacts) {
  var neg = impacts.filter(function(r){ return r < 0; }).map(function(r){ return r*r; });
  return neg.length ? Math.sqrt(neg.reduce(function(s,x){ return s+x; }, 0) / impacts.length) : 0;
}

function calcVaR95(impacts) {
  if (!impacts.length) return 0;
  var mean = impacts.reduce(function(s,r){ return s+r; }, 0) / impacts.length;
  var std = Math.sqrt(impacts.reduce(function(s,r){ return s + (r-mean)*(r-mean); }, 0) / impacts.length);
  return mean - 1.645 * std;
}

// FIX 4: Monte Carlo uses portfolio impacts (already sized), not position returns
function monteCarloSim(impacts, nSims, nOps, startCap) {
  var paths = [], finals = [];
  for (var s = 0; s < nSims; s++) {
    var cap = startCap, path = [cap];
    for (var i = 0; i < nOps; i++) {
      cap *= (1 + impacts[Math.floor(Math.random() * impacts.length)]);
      if (cap < 0) cap = 0;
      path.push(cap);
    }
    paths.push(path); finals.push(cap);
  }
  finals.sort(function(a,b){ return a-b; });
  var probDD20 = 0;
  paths.forEach(function(p) {
    var pk = p[0];
    for (var i = 1; i < p.length; i++) {
      if (p[i] > pk) pk = p[i];
      if (pk > 0 && (p[i] - pk) / pk < -0.20) { probDD20++; break; }
    }
  });
  return {
    paths: paths, finals: finals,
    p5:  finals[Math.floor(nSims * 0.05)],  p25: finals[Math.floor(nSims * 0.25)],
    p50: finals[Math.floor(nSims * 0.50)],  p75: finals[Math.floor(nSims * 0.75)],
    p95: finals[Math.floor(nSims * 0.95)],
    probLoss: finals.filter(function(f){ return f < startCap; }).length / nSims,
    probDD20: probDD20 / nSims
  };
}

// FIX 7: Stress test on portfolio impacts, clear naming
function stressTest(impacts, nWorst) {
  var sorted = impacts.slice().sort(function(a,b){ return a-b; });
  var worst = sorted.slice(0, Math.min(nWorst, sorted.length));
  var cap = 1;
  worst.forEach(function(r){ cap *= (1+r); });
  return cap - 1;
}

// FIX 6: Export CSV
function exportMonthlySeries() {
  try {
    var raw = JSON.parse(document.getElementById('serie-mensual-raw').textContent);
    if (!raw.length) { alert('No hay datos'); return; }
    var csv = 'Mes,Operaciones,Rent_Cartera_Pct,Rent_Pos_Media_Pct,PL_EUR,Acumulado_Pct\n';
    raw.forEach(function(m) {
      csv += m.month+','+m.nOps+','+(m.rentMes*100).toFixed(4)+','+(m.rentPosMedia*100).toFixed(4)+','+m.plMes.toFixed(2)+','+(m.acumPct*100).toFixed(4)+'\n';
    });
    var blob = new Blob([csv], {type:'text/csv'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'serie_mensual_ethan.csv';
    a.click();
  } catch(e) { alert('Error: '+e.message); }
}

// ‚îÄ‚îÄ RENDER GENERAL ‚îÄ‚îÄ
function renderGeneral() {
  var rb = calcRatios(DATA.bull.enriched), rr = calcRatios(DATA.bear.enriched);
  var allOps = DATA.bull.enriched.concat(DATA.bear.enriched).sort(function(a,b){ return new Date(a.fe)-new Date(b.fe); });
  var rg = calcRatios(allOps);
  renderKPIs('kpi-general', rg, 'general');

  // Radar
  destroyChart('chart-compare');
  if (rb || rr) {
    var mkData = function(r) { return [r?r.winRate*100:0,(r?r.rentMedia:0)*100,(r?r.esperanza:0)*100,r?r.sharpe:0,Math.min(r?r.profitFactor:0,10)]; };
    charts['chart-compare'] = new Chart(document.getElementById('chart-compare').getContext('2d'), {
      type:'radar',data:{labels:['Win Rate','Rent. Media %','Esperanza %','Sharpe','Profit Factor'],
        datasets:[{label:'Alcista',data:mkData(rb),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',pointBackgroundColor:'#10b981'},
                  {label:'Bajista',data:mkData(rr),borderColor:'#f43f5e',backgroundColor:'rgba(244,63,94,0.1)',pointBackgroundColor:'#f43f5e'}]},
      options:{responsive:true,scales:{r:{ticks:{color:'#8896ab',backdropColor:'transparent'},grid:{color:'rgba(255,255,255,0.06)'},pointLabels:{color:'#e8ecf4',font:{size:11}}}},plugins:{legend:{labels:{color:'#e8ecf4'}}}}
    });
  }

  // Combined equity (‚Ç¨)
  destroyChart('chart-general-equity');
  if (allOps.length) {
    var eq=[0]; allOps.forEach(function(o,i){ eq.push(eq[i]+o.pl); });
    charts['chart-general-equity'] = new Chart(document.getElementById('chart-general-equity').getContext('2d'), {
      type:'line',data:{labels:eq.map(function(_,i){ return i===0?'Inicio':'Op '+i; }),datasets:[{label:'P/L Acumulado (‚Ç¨)',data:eq,borderColor:'#38bdf8',tension:.3,pointRadius:3,fill:false}]},
      options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4'}}},scales:{y:{ticks:{callback:function(v){return '‚Ç¨'+v;},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
    });
  }

  // Empty guard
  if (!rg || allOps.length < 2) {
    ['rent-serie-mensual','rent-serie-anual','kpi-rent','rent-benchmark','kpi-riesgo','risk-detail',
     'kpi-eficiencia','eficiencia-detail','kpi-prob','stress-test','prob-detail'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.innerHTML = '<div class="empty-state"><small>Necesitas operaciones cerradas</small></div>';
    });
    ['chart-rent-mensual','chart-rolling','chart-drawdown','chart-distrib','chart-montecarlo','chart-prob-obj'].forEach(function(id){ destroyChart(id); });
    renderProjections();
    return;
  }

  var cap0 = getConfig().capital;
  var allOpsP = enrichPortfolioImpact(allOps, cap0);
  var impacts = allOpsP.map(function(o){ return o.impactoCartera; });

  // ‚ïê‚ïê‚ïê BLOQUE 1: RENTABILIDAD ‚ïê‚ïê‚ïê
  var monthly = buildMonthlySeries(allOpsP);
  var annual = buildAnnualSeries(monthly);
  document.getElementById('serie-mensual-raw').textContent = JSON.stringify(monthly);

  // Serie mensual table + export
  var smEl = document.getElementById('rent-serie-mensual');
  var smH = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);max-height:300px;overflow-y:auto">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">' +
    '<div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px">Serie Mensual</div>' +
    '<button class="btn btn-sm btn-outline" onclick="exportMonthlySeries()" style="font-size:10px;padding:4px 10px">üì• CSV</button></div>' +
    '<div style="display:grid;grid-template-columns:1fr .5fr 1fr 1fr 1fr;gap:4px;font-size:10px;font-family:var(--mono);color:var(--text3);padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:6px"><span>Mes</span><span>Ops</span><span>Cartera</span><span>P/L</span><span>Acum.</span></div>';
  monthly.forEach(function(m) {
    smH += '<div style="display:grid;grid-template-columns:1fr .5fr 1fr 1fr 1fr;gap:4px;font-size:10px;font-family:var(--mono);padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.02)">' +
      '<span style="color:var(--text2)">'+m.month+'</span><span style="color:var(--text3)">'+m.nOps+'</span>' +
      '<span style="color:'+(m.rentMes>=0?'var(--bull)':'var(--bear)')+'">'+(m.rentMes*100).toFixed(2)+'%</span>' +
      '<span style="color:'+(m.plMes>=0?'var(--bull)':'var(--bear)')+'">'+fmtE(m.plMes)+'</span>' +
      '<span style="color:'+(m.acumPct>=0?'var(--bull)':'var(--bear)')+'">'+(m.acumPct*100).toFixed(2)+'%</span></div>';
  });
  smEl.innerHTML = smH + '</div>';

  // Serie anual
  var saEl = document.getElementById('rent-serie-anual');
  var saH = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px">Serie Anual (compuesta)</div>' +
    '<div style="display:grid;grid-template-columns:1fr .6fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);color:var(--text3);padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:6px"><span>A√±o</span><span>Ops</span><span>Rent.</span><span>P/L</span></div>';
  annual.forEach(function(a) {
    saH += '<div style="display:grid;grid-template-columns:1fr .6fr 1fr 1fr;gap:4px;font-size:11px;font-family:var(--mono);padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.02)">' +
      '<span style="color:var(--text);font-weight:600">'+a.year+'</span><span style="color:var(--text3)">'+a.nOps+'</span>' +
      '<span style="color:'+(a.rentAnual>=0?'var(--bull)':'var(--bear)')+'">'+(a.rentAnual*100).toFixed(2)+'%</span>' +
      '<span style="color:'+(a.plTotal>=0?'var(--bull)':'var(--bear)')+'">'+fmtE(a.plTotal)+'</span></div>';
  });
  saEl.innerHTML = saH + '</div>';

  // FIX 2: Rent acumulada compuesta sobre cartera (no sobre posici√≥n)
  var totalDays = (new Date(allOps[allOps.length-1].fs) - new Date(allOps[0].fe)) / 86400000;
  var yrs = Math.max(totalDays / 365.25, 1/12);
  var cumReturn = monthly.length ? monthly[monthly.length-1].acumPct : 0;
  var annReturn = Math.pow(1 + cumReturn, 1/yrs) - 1;
  var benchReturn = 0.10;
  var excessReturn = annReturn - benchReturn;
  var meanImp = impacts.reduce(function(s,r){return s+r;},0) / impacts.length;
  var stdImp = Math.sqrt(impacts.reduce(function(s,r){return s+(r-meanImp)*(r-meanImp);},0) / impacts.length);
  var volAnual = stdImp * Math.sqrt(rg.opsAnio);
  var tError = volAnual;
  var infoR = tError > 0 ? excessReturn / tError : 0;
  var r12m = calcRollingMonths(monthly, 12);
  var r36m = calcRollingMonths(monthly, 36);

  document.getElementById('kpi-rent').innerHTML =
    '<div class="kpi green"><div class="kpi-label">Rent. Acumulada</div><div class="kpi-value '+(cumReturn>=0?'green':'red')+'">'+(cumReturn*100).toFixed(2)+'%</div><div class="kpi-sub">'+allOps.length+' ops ¬∑ '+yrs.toFixed(1)+' a√±os</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">Rent. Anualizada</div><div class="kpi-value '+(annReturn>=0?'green':'red')+'">'+(annReturn*100).toFixed(2)+'%</div><div class="kpi-sub">CAGR sobre cartera</div></div>' +
    '<div class="kpi yellow"><div class="kpi-label">Exceso vs Bench</div><div class="kpi-value '+(excessReturn>=0?'green':'red')+'">'+(excessReturn*100).toFixed(2)+'%</div><div class="kpi-sub">vs S&P500 10%</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">Tracking Error</div><div class="kpi-value">'+(tError*100).toFixed(2)+'%</div><div class="kpi-sub">vol. cartera anualiz.</div></div>' +
    '<div class="kpi purple"><div class="kpi-label">Information Ratio</div><div class="kpi-value '+(infoR>=0?'green':'red')+'">'+fmt(infoR)+'</div><div class="kpi-sub">'+(infoR>0.5?'‚úÖ Bueno':infoR>0?'‚ö†Ô∏è Bajo':'‚ùå Negativo')+'</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">Impacto Medio/Op</div><div class="kpi-value '+(meanImp>=0?'green':'red')+'">'+(meanImp*100).toFixed(3)+'%</div><div class="kpi-sub">sobre total cartera</div></div>';

  // Monthly chart (portfolio %)
  destroyChart('chart-rent-mensual');
  charts['chart-rent-mensual'] = new Chart(document.getElementById('chart-rent-mensual').getContext('2d'), {
    type:'bar', data:{labels:monthly.map(function(m){return m.month;}),datasets:[{data:monthly.map(function(m){return m.rentMes*100;}),backgroundColor:monthly.map(function(m){return m.rentMes>=0?'rgba(74,222,128,0.7)':'rgba(244,113,116,0.7)';}),borderRadius:3}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return c.parsed.y.toFixed(2)+'% cartera';}}}},scales:{y:{ticks:{callback:function(v){return v.toFixed(1)+'%';},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxRotation:45,font:{size:9}},grid:{display:false}}}}
  });

  // Rolling chart ‚Äî FIX 5: temporal 12m/36m
  destroyChart('chart-rolling');
  var rDS = [];
  if (r12m.length) rDS.push({label:'Rolling 12 meses',data:r12m.map(function(r){return r.ret*100;}),borderColor:'#40d9c0',tension:.3,pointRadius:0,fill:false,borderWidth:2});
  if (r36m.length) rDS.push({label:'Rolling 36 meses',data:r36m.map(function(r){return r.ret*100;}),borderColor:'#f59e0b',tension:.3,pointRadius:0,fill:false,borderWidth:2,borderDash:[5,3]});
  if (rDS.length) {
    var rLabels = (r12m.length >= (r36m.length||0) ? r12m : r36m).map(function(r){return r.endMonth;});
    charts['chart-rolling'] = new Chart(document.getElementById('chart-rolling').getContext('2d'), {
      type:'line', data:{labels:rLabels, datasets:rDS},
      options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:10}}}},scales:{y:{ticks:{callback:function(v){return v.toFixed(0)+'%';},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxRotation:45,font:{size:8}},grid:{display:false}}}}
    });
  }

  // Benchmark note
  document.getElementById('rent-benchmark').innerHTML = '<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2);display:flex;gap:20px;flex-wrap:wrap;align-items:center">' +
    '<span>üìå Benchmark: S&P 500 (10% anualizado)</span>' +
    '<span>Exceso: <strong style="color:'+(excessReturn>=0?'var(--bull)':'var(--bear)')+'"> '+(excessReturn*100).toFixed(2)+'%</strong></span>' +
    '<span>Info Ratio: <strong style="color:var(--accent)">'+fmt(infoR)+'</strong></span>' +
    '<span style="color:var(--text3);font-size:10px">¬∑ Todos los % calculados sobre capital total, no sobre posici√≥n</span></div>';

  // ‚ïê‚ïê‚ïê BLOQUE 2: RIESGO (sin Beta/Correlaci√≥n falsos ‚Äî FIX 3) ‚ïê‚ïê‚ïê
  var dd = calcDrawdownSeries(allOpsP);
  var dsDev = calcDownsideDeviation(impacts);
  var dsDevAn = dsDev * Math.sqrt(rg.opsAnio);
  var var95 = calcVaR95(impacts);

  document.getElementById('kpi-riesgo').innerHTML =
    '<div class="kpi yellow"><div class="kpi-label">Volatilidad Anualizada</div><div class="kpi-value yellow">'+(volAnual*100).toFixed(2)+'%</div><div class="kpi-sub">œÉ cartera √ó ‚àö(ops/a√±o)</div></div>' +
    '<div class="kpi red"><div class="kpi-label">M√°ximo Drawdown</div><div class="kpi-value red">'+(dd.maxDD*100).toFixed(2)+'%</div><div class="kpi-sub">sobre capital total</div></div>' +
    '<div class="kpi red"><div class="kpi-label">Duraci√≥n DD</div><div class="kpi-value red">'+dd.ddDuration+' ops</div><div class="kpi-sub">en drawdown</div></div>' +
    '<div class="kpi yellow"><div class="kpi-label">Downside Dev.</div><div class="kpi-value yellow">'+(dsDevAn*100).toFixed(2)+'%</div><div class="kpi-sub">anualizada ¬∑ cartera</div></div>' +
    '<div class="kpi red"><div class="kpi-label">VaR 95%</div><div class="kpi-value red">'+(var95*100).toFixed(2)+'%</div><div class="kpi-sub">por op ¬∑ cartera</div></div>' +
    '<div class="kpi purple"><div class="kpi-label">œÉ por Operaci√≥n</div><div class="kpi-value">'+(stdImp*100).toFixed(3)+'%</div><div class="kpi-sub">desv. impacto cartera</div></div>';

  // Drawdown chart ‚Äî FIX 2: portfolio %
  destroyChart('chart-drawdown');
  charts['chart-drawdown'] = new Chart(document.getElementById('chart-drawdown').getContext('2d'), {
    type:'line', data:{labels:dd.ddSeries.map(function(_,i){return 'Op '+(i+1);}),datasets:[{label:'Drawdown (% cartera)',data:dd.ddSeries.map(function(d){return d*100;}),borderColor:'#f47174',backgroundColor:'rgba(244,113,116,0.15)',fill:true,tension:.3,pointRadius:0,borderWidth:2}]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4'}}},scales:{y:{ticks:{callback:function(v){return v.toFixed(1)+'%';},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',font:{size:9}},grid:{display:false}}}}
  });

  // Distribution ‚Äî portfolio impacts
  destroyChart('chart-distrib');
  var nBins = Math.min(20, Math.max(5, Math.ceil(Math.sqrt(impacts.length))));
  var minI = Math.min.apply(null,impacts), maxI = Math.max.apply(null,impacts);
  var binW = (maxI - minI) / nBins || 0.001;
  var hist = new Array(nBins).fill(0);
  impacts.forEach(function(r){ var b = Math.min(Math.floor((r-minI)/binW), nBins-1); hist[b]++; });
  var bLabels = [], bColors = [];
  for (var bi=0; bi<nBins; bi++) {
    bLabels.push(((minI+bi*binW)*100).toFixed(2)+'%');
    bColors.push((minI+(bi+0.5)*binW)>=0?'rgba(74,222,128,0.6)':'rgba(244,113,116,0.6)');
  }
  charts['chart-distrib'] = new Chart(document.getElementById('chart-distrib').getContext('2d'), {
    type:'bar', data:{labels:bLabels,datasets:[{data:hist,backgroundColor:bColors,borderRadius:2}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxRotation:45,font:{size:7}},grid:{display:false}}}}
  });

  // Risk detail ‚Äî skewness, kurtosis on portfolio impacts
  var skew = stdImp > 0 ? impacts.reduce(function(s,r){return s+Math.pow((r-meanImp)/stdImp,3);},0)/impacts.length : 0;
  var kurt = stdImp > 0 ? impacts.reduce(function(s,r){return s+Math.pow((r-meanImp)/stdImp,4);},0)/impacts.length - 3 : 0;
  document.getElementById('risk-detail').innerHTML = '<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">' +
    '<div>Skewness: <strong style="color:var(--text);font-family:var(--mono)">'+fmt(skew)+'</strong> <span style="font-size:10px;color:var(--text3)">'+(skew>0.2?'(cola dcha ‚úÖ)':skew<-0.2?'(cola izda ‚ö†Ô∏è)':'(sim√©trico)')+'</span></div>' +
    '<div>Kurtosis: <strong style="color:var(--text);font-family:var(--mono)">'+fmt(kurt)+'</strong> <span style="font-size:10px;color:var(--text3)">'+(kurt>1?'(colas pesadas ‚ö†Ô∏è)':'(normal)')+'</span></div>' +
    '<div>M√°x Rachas Perd.: <strong style="color:var(--bear);font-family:var(--mono)">'+rg.maxConsecLoss+'</strong></div>' +
    '<div>Profit Factor: <strong style="color:var(--accent);font-family:var(--mono)">'+(rg.profitFactor===Infinity?'‚àû':fmt(rg.profitFactor))+'</strong></div>' +
    '<div>AvgWin/pos: <strong style="color:var(--bull);font-family:var(--mono)">'+fmtPct(rg.avgWinPct)+'</strong></div>' +
    '<div>AvgLoss/pos: <strong style="color:var(--bear);font-family:var(--mono)">-'+(rg.avgLossPct*100).toFixed(2)+'%</strong></div>' +
    '<div style="grid-column:span 3;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--text3)">‚ö†Ô∏è Riesgo calculado sobre impacto real en cartera (P/L √∑ Capital Total). No incluye Beta ni Correlaci√≥n ‚Äî requieren serie de benchmark real.</div></div>';

  // ‚ïê‚ïê‚ïê BLOQUE 3: EFICIENCIA ‚ïê‚ïê‚ïê
  var rfRate = 0.03;
  var sharpeA = volAnual > 0 ? (annReturn - rfRate) / volAnual : 0;
  var sortinoA = dsDevAn > 0 ? (annReturn - rfRate) / dsDevAn : 0;
  var calmar = dd.maxDD !== 0 ? annReturn / Math.abs(dd.maxDD) : 0;

  document.getElementById('kpi-eficiencia').innerHTML =
    '<div class="kpi green"><div class="kpi-label">Sharpe Ratio</div><div class="kpi-value '+(sharpeA>1?'green':sharpeA>0.5?'yellow':'red')+'">'+fmt(sharpeA)+'</div><div class="kpi-sub">'+(sharpeA>1?'‚úÖ Excelente':sharpeA>0.5?'‚ö†Ô∏è Aceptable':'‚ùå Bajo')+' ¬∑ anualizado</div></div>' +
    '<div class="kpi green"><div class="kpi-label">Sortino Ratio</div><div class="kpi-value '+(sortinoA>1.5?'green':sortinoA>0.5?'yellow':'red')+'">'+fmt(sortinoA)+'</div><div class="kpi-sub">'+(sortinoA>1.5?'‚úÖ Excelente':sortinoA>0.5?'‚ö†Ô∏è Aceptable':'‚ùå Bajo')+'</div></div>' +
    '<div class="kpi yellow"><div class="kpi-label">Calmar Ratio</div><div class="kpi-value '+(calmar>1?'green':calmar>0.5?'yellow':'red')+'">'+fmt(calmar)+'</div><div class="kpi-sub">CAGR / M√°x DD</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">Ret. Anual / M√°x DD</div><div class="kpi-value">'+fmt(calmar)+'</div><div class="kpi-sub">'+(calmar>2?'‚úÖ Muy bueno':calmar>1?'‚ö†Ô∏è Correcto':'‚ùå Bajo')+'</div></div>';

  document.getElementById('eficiencia-detail').innerHTML = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);font-size:12px;color:var(--text2)">' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
    '<div><div style="font-weight:600;color:var(--accent);margin-bottom:8px">Interpretaci√≥n Sharpe</div><div style="line-height:2">&lt; 0.5: Malo ‚Äî dif√≠cil justificar el riesgo<br>0.5‚Äì1.0: Aceptable ‚Äî fondos promedio<br>1.0‚Äì2.0: Bueno ‚Äî top quartile<br>&gt; 2.0: Excepcional ‚Äî muy raro sostenerlo</div></div>' +
    '<div><div style="font-weight:600;color:var(--accent);margin-bottom:8px">Interpretaci√≥n Calmar</div><div style="line-height:2">&lt; 0.5: Alto riesgo relativo a retorno<br>0.5‚Äì1.0: Equilibrado<br>1.0‚Äì3.0: Buen control de p√©rdidas<br>&gt; 3.0: Excelente ‚Äî muy buscado por fondos</div></div></div>' +
    '<div style="margin-top:12px;padding:10px;background:var(--accent-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm)">' +
    '<strong style="color:var(--accent)">Tu narrativa:</strong> Sharpe '+fmt(sharpeA)+' ¬∑ Sortino '+fmt(sortinoA)+' ¬∑ Calmar '+fmt(calmar)+'. ' +
    (calmar>1?'Excelente control del drawdown relativo a retorno.':sharpeA>0.5?'Rentabilidad aceptable, margen para mejorar control de ca√≠das.':'Necesitas m√°s operaciones o mejorar el edge.')+'</div></div>';

  // ‚ïê‚ïê‚ïê BLOQUE 4: PROBABILIDAD & ROBUSTEZ ‚ïê‚ïê‚ïê
  var nOps5y = Math.round(rg.opsAnio * 5);
  var nOps10y = Math.round(rg.opsAnio * 10);
  var nOps15y = Math.round(rg.opsAnio * 15);

  // FIX 4: Monte Carlo con portfolio impacts (sizing real)
  var mc5 = monteCarloSim(impacts, 1000, nOps5y, cap0);
  var mc10 = monteCarloSim(impacts, 500, nOps10y, cap0);
  var mc15 = monteCarloSim(impacts, 500, nOps15y, cap0);

  var p2x5  = mc5.finals.filter(function(f){return f>=cap0*2;}).length / mc5.finals.length;
  var p2x10 = mc10.finals.filter(function(f){return f>=cap0*2;}).length / mc10.finals.length;
  var p3x10 = mc10.finals.filter(function(f){return f>=cap0*3;}).length / mc10.finals.length;
  var p5x15 = mc15.finals.filter(function(f){return f>=cap0*5;}).length / mc15.finals.length;

  // FIX 7: Stress tests on portfolio impacts, honest naming
  var st3 = stressTest(impacts, 3);
  var st5 = stressTest(impacts, 5);
  var st10 = stressTest(impacts, Math.min(10, impacts.length));
  var stCrisis = stressTest(impacts, Math.min(6, impacts.length));
  var stCrash = stressTest(impacts, Math.min(4, impacts.length));

  document.getElementById('kpi-prob').innerHTML =
    '<div class="kpi green"><div class="kpi-label">P(2x en 5 a√±os)</div><div class="kpi-value green">'+(p2x5*100).toFixed(1)+'%</div><div class="kpi-sub">1000 simulaciones</div></div>' +
    '<div class="kpi green"><div class="kpi-label">P(2x en 10 a√±os)</div><div class="kpi-value green">'+(p2x10*100).toFixed(1)+'%</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">P(3x en 10 a√±os)</div><div class="kpi-value blue">'+(p3x10*100).toFixed(1)+'%</div></div>' +
    '<div class="kpi purple"><div class="kpi-label">P(5x en 15 a√±os)</div><div class="kpi-value purple">'+(p5x15*100).toFixed(1)+'%</div></div>' +
    '<div class="kpi red"><div class="kpi-label">P(DD &gt; 20%)</div><div class="kpi-value red">'+(mc5.probDD20*100).toFixed(1)+'%</div><div class="kpi-sub">horizonte 5Y</div></div>' +
    '<div class="kpi yellow"><div class="kpi-label">P(perder capital)</div><div class="kpi-value '+(mc5.probLoss>0.3?'red':'yellow')+'">'+(mc5.probLoss*100).toFixed(1)+'%</div><div class="kpi-sub">en 5 a√±os</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">Mediana 5Y</div><div class="kpi-value green">'+fmtK(mc5.p50)+'</div><div class="kpi-sub">√ó'+(mc5.p50/cap0).toFixed(2)+'</div></div>' +
    '<div class="kpi blue"><div class="kpi-label">P95 / P5 (5Y)</div><div class="kpi-value">'+fmtK(mc5.p95)+'</div><div class="kpi-sub">peor: '+fmtK(mc5.p5)+'</div></div>';

  // Monte Carlo chart
  destroyChart('chart-montecarlo');
  var mcDS = [];
  var nShow = Math.min(50, mc5.paths.length);
  for (var si=0; si<nShow; si++) {
    mcDS.push({data:mc5.paths[si],borderColor:'rgba(64,217,192,0.08)',borderWidth:1,pointRadius:0,tension:.1,fill:false});
  }
  var pLen = nOps5y + 1;
  var p5P=[], p50P=[], p95P=[];
  for (var step=0; step<pLen; step++) {
    var vals = mc5.paths.map(function(p){return p[Math.min(step,p.length-1)];}).sort(function(a,b){return a-b;});
    p5P.push(vals[Math.floor(vals.length*0.05)]);
    p50P.push(vals[Math.floor(vals.length*0.50)]);
    p95P.push(vals[Math.floor(vals.length*0.95)]);
  }
  mcDS.push({label:'P95',data:p95P,borderColor:'#4ade80',borderWidth:2,pointRadius:0,tension:.3,fill:false,borderDash:[5,3]});
  mcDS.push({label:'Mediana',data:p50P,borderColor:'#40d9c0',borderWidth:2.5,pointRadius:0,tension:.3,fill:false});
  mcDS.push({label:'P5',data:p5P,borderColor:'#f47174',borderWidth:2,pointRadius:0,tension:.3,fill:false,borderDash:[5,3]});
  var opsPerY = Math.max(1, Math.round(rg.opsAnio));
  var mcL = [];
  for (var li=0; li<pLen; li++) mcL.push(li % opsPerY === 0 ? 'A√±o '+Math.round(li/opsPerY) : '');
  charts['chart-montecarlo'] = new Chart(document.getElementById('chart-montecarlo').getContext('2d'), {
    type:'line', data:{labels:mcL, datasets:mcDS},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:10},filter:function(item){return item.text;}}}},
      scales:{y:{ticks:{callback:function(v){return fmtK(v);},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxTicksLimit:6},grid:{display:false}}}}
  });

  // Prob objective chart
  destroyChart('chart-prob-obj');
  var objs = [{l:'2x 5Y',v:p2x5},{l:'2x 10Y',v:p2x10},{l:'3x 10Y',v:p3x10},{l:'5x 15Y',v:p5x15}];
  charts['chart-prob-obj'] = new Chart(document.getElementById('chart-prob-obj').getContext('2d'), {
    type:'bar', data:{labels:objs.map(function(o){return o.l;}),datasets:[{data:objs.map(function(o){return o.v*100;}),backgroundColor:objs.map(function(o){return o.v>0.7?'rgba(74,222,128,0.7)':o.v>0.4?'rgba(251,191,36,0.7)':'rgba(244,113,116,0.7)';}),borderRadius:6}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return c.parsed.y.toFixed(1)+'%';}}}},
      scales:{y:{max:100,ticks:{callback:function(v){return v+'%';},color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab'},grid:{display:false}}}}
  });

  // Stress test ‚Äî FIX 7: honest labels, portfolio impacts
  document.getElementById('stress-test').innerHTML = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)">' +
    '<div style="font-size:12px;font-weight:600;color:var(--bear);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">üß™ Stress Tests</div>' +
    '<div style="font-size:10px;color:var(--text3);margin-bottom:12px">Simulaciones: tus N peores operaciones (impacto real en cartera) aplicadas consecutivamente.</div>' +
    '<div style="font-size:12px;line-height:2.2;font-family:var(--mono);color:var(--text2)">' +
    '<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)"><span>3 peores ops seguidas</span><strong style="color:var(--bear)">'+(st3*100).toFixed(2)+'%</strong></div>' +
    '<div style="display:flex;justify-content:space-between;padding:4px 8px"><span>5 peores ops seguidas</span><strong style="color:var(--bear)">'+(st5*100).toFixed(2)+'%</strong></div>' +
    '<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)"><span>Sim. crisis severa (6 peores)</span><strong style="color:var(--bear)">'+(stCrisis*100).toFixed(2)+'%</strong></div>' +
    '<div style="display:flex;justify-content:space-between;padding:4px 8px"><span>Sim. crash r√°pido (4 peores)</span><strong style="color:var(--bear)">'+(stCrash*100).toFixed(2)+'%</strong></div>' +
    '<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;background:rgba(244,113,116,0.05)"><span>Escenario extremo (10 peores)</span><strong style="color:var(--bear)">'+(st10*100).toFixed(2)+'%</strong></div></div></div>';

  // Prob detail
  document.getElementById('prob-detail').innerHTML = '<div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm)">' +
    '<div style="font-size:12px;font-weight:600;color:rgba(168,85,247,1);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px">üìä Distribuci√≥n Monte Carlo 5Y</div>' +
    '<div style="font-size:12px;line-height:2.2;font-family:var(--mono);color:var(--text2)">' +
    '<div style="display:flex;justify-content:space-between"><span>Percentil 5 (peor caso)</span><strong style="color:var(--bear)">'+fmtK(mc5.p5)+'</strong></div>' +
    '<div style="display:flex;justify-content:space-between"><span>Percentil 25</span><strong style="color:var(--warn)">'+fmtK(mc5.p25)+'</strong></div>' +
    '<div style="display:flex;justify-content:space-between"><span>Mediana (P50)</span><strong style="color:var(--accent)">'+fmtK(mc5.p50)+'</strong></div>' +
    '<div style="display:flex;justify-content:space-between"><span>Percentil 75</span><strong style="color:var(--bull)">'+fmtK(mc5.p75)+'</strong></div>' +
    '<div style="display:flex;justify-content:space-between"><span>Percentil 95 (mejor caso)</span><strong style="color:var(--bull)">'+fmtK(mc5.p95)+'</strong></div></div>' +
    '<div style="margin-top:12px;padding:10px;background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.25);border-radius:var(--radius-sm);font-size:11px;color:var(--text2)">' +
    '<strong style="color:rgba(168,85,247,1)">Resumen:</strong> '+(mc5.probLoss*100).toFixed(0)+'% prob. de perder capital. Mediana √ó'+(mc5.p50/cap0).toFixed(2)+' en 5 a√±os. ' +
    (mc5.probDD20>0.5?'‚ö†Ô∏è Alta probabilidad de DD &gt;20%.':'‚úÖ Riesgo de DD &gt;20% contenido.') +
    '<div style="margin-top:6px;color:var(--text3);font-size:10px">Simulaciones con tus retornos reales (impacto en cartera con sizing actual).</div></div></div>';

  renderProjections();
}


// ‚îÄ‚îÄ PROJECTIONS (inside General) ‚îÄ‚îÄ
function renderProjections() {
  const { capital, ratios, riskPct, ddPct } = getConfig();
  const projContainer = document.getElementById('kpi-proj');
  const projTable = document.getElementById('proj-table');
  const ddEl = document.getElementById('dd-analysis');
  const scEl = document.getElementById('scenarios');

  if (!ratios) {
    projContainer.innerHTML = '<div class="empty-state"><small>Necesitas operaciones cerradas para proyectar</small></div>';
    projTable.innerHTML = ''; ddEl.innerHTML = ''; scEl.innerHTML = '';
    destroyChart('chart-projection');
    return;
  }

  const { rentMedia, opsAnio, diasMedio, winRate, avgWinPct, avgLossPct } = ratios;
  const sizing = Math.min(riskPct / (avgLossPct || 0.01), 1);
  const impactoGan = avgWinPct * sizing;
  const impactoPerd = avgLossPct * sizing;
  const rentEfectiva = winRate * impactoGan - (1-winRate) * impactoPerd;
  const totalOps5y = Math.round(opsAnio * 5);
  const cap1y = capital * Math.pow(1+rentEfectiva, Math.round(opsAnio));
  const cap5y = capital * Math.pow(1+rentEfectiva, totalOps5y);

  projContainer.innerHTML = `
    <div class="kpi green"><div class="kpi-label">Capital Inicial</div><div class="kpi-value">${fmtE(capital)}</div></div>
    <div class="kpi blue"><div class="kpi-label">Rent. Hist√≥rica/Op</div><div class="kpi-value blue">${fmtPct(rentMedia)}</div><div class="kpi-sub">${fmt(diasMedio,0)}d ¬∑ ${fmt(opsAnio,1)} ops/a√±o</div></div>
    <div class="kpi yellow"><div class="kpi-label">Sizing</div><div class="kpi-value yellow">${(sizing*100).toFixed(1)}%</div><div class="kpi-sub">Riesgo ${(riskPct*100).toFixed(1)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">Impacto Real/Op</div><div class="kpi-value ${rentEfectiva>=0?'green':'red'}">${fmtPct(rentEfectiva)}</div><div class="kpi-sub">Esperanza √ó Sizing</div></div>
    <div class="kpi green"><div class="kpi-label">Proyecci√≥n 1Y</div><div class="kpi-value green">${fmtK(cap1y)}</div><div class="kpi-sub">√ó${(cap1y/capital).toFixed(2)}</div></div>
    <div class="kpi green"><div class="kpi-label">Proyecci√≥n 5Y</div><div class="kpi-value green">${fmtK(cap5y)}</div><div class="kpi-sub">√ó${(cap5y/capital).toFixed(2)}</div></div>`;

  // Table
  let h = '';
  for (let y=1;y<=5;y++) {
    const cap = capital * Math.pow(1+rentEfectiva, Math.round(opsAnio*y));
    const bw = Math.min((cap/Math.max(cap5y,capital*1.01))*100,100);
    h += `<div class="proj-row"><span style="font-weight:600;color:var(--accent)">A√±o ${y}</span><div><div class="proj-bar" style="width:${bw}%"></div></div><span style="font-family:var(--mono);font-weight:600;text-align:right">${fmtK(cap)}</span></div>`;
  }
  projTable.innerHTML = h;

  // Chart with 3 curves
  destroyChart('chart-projection');
  const months = Array.from({length:61},(_,i)=>i);
  const mkCurve = rE => months.map(m => capital*Math.pow(1+rE, Math.round(opsAnio*m/12)));
  const sH = Math.min((riskPct/2)/(avgLossPct||0.01),1), sD = Math.min((riskPct*2)/(avgLossPct||0.01),1);
  const rH = winRate*avgWinPct*sH-(1-winRate)*avgLossPct*sH;
  const rD = winRate*avgWinPct*sD-(1-winRate)*avgLossPct*sD;
  charts['chart-projection'] = new Chart(document.getElementById('chart-projection').getContext('2d'), {
    type:'line',data:{labels:months.map(i=>i%12===0?`A√±o ${i/12}`:''),
      datasets:[
        {label:`Riesgo ${(riskPct*100).toFixed(1)}%`,data:mkCurve(rentEfectiva),borderColor:'#40d9c0',backgroundColor:'rgba(64,217,192,0.08)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5},
        {label:`Riesgo ${(riskPct*50).toFixed(1)}%`,data:mkCurve(rH),borderColor:'#38bdf8',borderDash:[5,3],tension:.3,pointRadius:0,fill:false,borderWidth:1.5},
        {label:`Riesgo ${(riskPct*200).toFixed(1)}%`,data:mkCurve(rD),borderColor:'#f59e0b',borderDash:[5,3],tension:.3,pointRadius:0,fill:false,borderWidth:1.5}]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#e8ecf4',font:{size:11}}}},scales:{y:{ticks:{callback:v=>fmtK(v),color:'#8896ab'},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#8896ab',maxTicksLimit:6},grid:{display:false}}}}
  });

  // Drawdown
  const lossRate = 1-winRate;
  let ddH = `<div style="padding:8px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:10px;font-size:12px;color:var(--text2)">
    Cada p√©rdida: <strong style="color:var(--bear)">-${(impactoPerd*100).toFixed(2)}%</strong> en cuenta</div><div style="font-size:13px;line-height:2">`;
  for (let n=2;n<=10;n++) {
    const prob = Math.pow(lossRate,n);
    const dd = (1-Math.pow(1-impactoPerd,n))*100;
    const p100 = (1-Math.pow(1-prob,100))*100;
    const exc = dd > ddPct*100;
    ddH += `<div style="display:flex;justify-content:space-between;padding:5px 8px;border-radius:4px;${exc?'background:var(--bear-dim)':''}">
      <span>${n} p√©rdidas</span><span style="font-family:var(--mono);font-size:12px">DD: <strong style="color:${exc?'var(--bear)':'var(--warn)'}">${dd.toFixed(1)}%</strong>${exc?' ‚ö†Ô∏è':''} ¬∑ P(100ops): ${p100.toFixed(1)}%</span></div>`;
  }
  const lDD = Math.log(1-ddPct)/Math.log(1-impactoPerd);
  ddH += `</div><div style="margin-top:12px;padding:10px;background:var(--accent-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm);font-size:12px">
    <strong style="color:var(--accent)">Con tu sizing:</strong> <strong>${Math.floor(lDD)} p√©rdidas consecutivas</strong> hasta DD m√°x ${(ddPct*100).toFixed(0)}%.
    ${lDD>8?'<span style="color:var(--bull)">‚úÖ Muy seguro</span>':lDD>5?'<span style="color:var(--warn)">‚ö†Ô∏è Moderado</span>':'<span style="color:var(--bear)">üî¥ Peligroso</span>'}</div>`;
  ddEl.innerHTML = ddH;

  // Scenarios
  const scs = [{name:'Conservador',m:.5,color:'var(--warn)',d:'Mitad riesgo'},{name:'Base (actual)',m:1,color:'var(--accent)',d:`Riesgo ${(riskPct*100).toFixed(1)}%`},{name:'Agresivo',m:2,color:'var(--bear)',d:'Doble riesgo'}];
  let sH2 = '<div style="font-size:13px">';
  scs.forEach(s => {
    const sz = Math.min((riskPct*s.m)/(avgLossPct||0.01),1);
    const rE = winRate*avgWinPct*sz-(1-winRate)*avgLossPct*sz;
    const cp = capital*Math.pow(1+rE,totalOps5y);
    const ddL = Math.floor(Math.log(1-ddPct)/Math.log(1-avgLossPct*sz));
    sH2 += `<div style="padding:12px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong style="color:${s.color}">${s.name}</strong><span style="font-size:11px;color:var(--text3)">${s.d}</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:var(--text2)">
        <div>Impacto/op: <strong style="font-family:var(--mono);color:var(--text)">${fmtPct(rE)}</strong></div>
        <div>Capital 5Y: <strong style="font-family:var(--mono);color:var(--text)">${fmtK(cp)}</strong></div>
        <div>DD/p√©rdida: <strong style="font-family:var(--mono);color:var(--bear)">${(avgLossPct*sz*100).toFixed(2)}%</strong></div>
        <div>P√©rdidas‚ÜíDD: <strong style="font-family:var(--mono);color:${ddL>8?'var(--bull)':ddL>5?'var(--warn)':'var(--bear)'}">${ddL}</strong></div></div></div>`;
  });
  scEl.innerHTML = sH2 + '</div>';
}

// ‚îÄ‚îÄ GETCONFIG ‚îÄ‚îÄ
function getConfig() {
  const capital = parseFloat(document.getElementById('capitalTotal').value)||10000;
  const riskPct = parseFloat(document.getElementById('riesgoPct').value)/100;
  const ddPct = parseFloat(document.getElementById('ddPct').value)/100;
  const maxPos = parseInt(document.getElementById('maxPos').value)||3;
  const allOps = [...DATA.bull.enriched,...DATA.bear.enriched];
  const ratios = calcRatios(allOps);
  return { capital, riskPct, ddPct, maxPos, ratios };
}

// ‚îÄ‚îÄ POSITION SIZING CALCULATOR ‚îÄ‚îÄ
function calcSizing() {
  const {capital, riskPct} = getConfig();
  const ticker = document.getElementById('sz-ticker').value.trim().toUpperCase() || '‚Äî';
  const precio = parseFloat(document.getElementById('sz-precio').value);
  const stop = parseFloat(document.getElementById('sz-stop').value);
  const tp = parseFloat(document.getElementById('sz-tp').value);
  const el = document.getElementById('sz-result');

  if (!precio || !stop || precio <= 0 || stop <= 0) {
    el.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:10px">Introduce precio de entrada y stop loss para calcular.</div>';
    return;
  }

  const isLong = precio > stop;
  const riskPerShare = Math.abs(precio - stop);
  const riskE = capital * riskPct;
  const acciones = Math.floor(riskE / riskPerShare);
  const capitalInvertido = acciones * precio;
  const pctCapital = capitalInvertido / capital;
  const perdidaMax = acciones * riskPerShare;
  const riskPctReal = perdidaMax / capital;

  let tpHtml = '';
  if (tp > 0) {
    const gananciaPerShare = Math.abs(tp - precio);
    const gananciaTotal = acciones * gananciaPerShare;
    const rrRatio = gananciaPerShare / riskPerShare;
    const rentPct = gananciaTotal / capitalInvertido;
    tpHtml = `
      <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
        <div>Take Profit: <strong style="color:var(--bull)">${fmtE(tp)}</strong> (${isLong?'+':'-'}${fmtE(gananciaPerShare)}/acc)</div>
        <div>Ganancia Potencial: <strong style="color:var(--bull)">${fmtE(gananciaTotal)}</strong> (${fmtPct(rentPct)} sobre invertido)</div>
        <div>Ratio R:R: <strong style="color:${rrRatio>=2?'var(--bull)':rrRatio>=1?'var(--warn)':'var(--bear)'}">${fmt(rrRatio)}:1</strong>
          ${rrRatio>=2?' ‚úÖ Excelente':rrRatio>=1.5?' ‚úÖ Bueno':rrRatio>=1?' ‚ö†Ô∏è Justo':' ‚ùå Malo'}</div>
      </div>`;
  }

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:10px">Resultado para ${ticker}</div>
        <div style="font-family:var(--mono);font-size:13px;line-height:2.2;color:var(--text2)">
          <div>Direcci√≥n: <strong style="color:${isLong?'var(--bull)':'var(--bear)'}">${isLong?'üìà LONG':'üìâ SHORT'}</strong></div>
          <div>Precio: <strong style="color:var(--text)">${fmtE(precio)}</strong></div>
          <div>Stop Loss: <strong style="color:var(--bear)">${fmtE(stop)}</strong> (${isLong?'-':'+'}${fmtE(riskPerShare)}/acc)</div>
          <div>Riesgo permitido: <strong style="color:var(--warn)">${fmtE(riskE)}</strong> (${(riskPct*100).toFixed(2)}% de ${fmtE(capital)})</div>
        </div>
      </div>
      <div style="padding:16px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--accent);border-opacity:0.3">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent);margin-bottom:10px">Tama√±o de Posici√≥n</div>
        <div style="font-family:var(--mono);font-size:13px;line-height:2.2;color:var(--text2)">
          <div>Acciones: <strong style="color:var(--accent);font-size:18px">${acciones}</strong></div>
          <div>Capital a invertir: <strong style="color:var(--text)">${fmtE(capitalInvertido)}</strong> (${(pctCapital*100).toFixed(1)}% del total)</div>
          <div>P√©rdida m√°xima: <strong style="color:var(--bear)">${fmtE(perdidaMax)}</strong> (${(riskPctReal*100).toFixed(2)}% del capital)</div>
          ${tpHtml}
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ RISK MANAGEMENT STRATEGIES ‚îÄ‚îÄ
function renderSemaforo() {
  const {capital,riskPct,maxPos}=getConfig();
  const rt=riskPct*maxPos; let lv,msg;
  if(rt<=0.05){lv='verde';msg=`üü¢ Riesgo bajo: ${(rt*100).toFixed(1)}% en riesgo m√°ximo`;}
  else if(rt<=0.12){lv='amarillo';msg=`üü° Riesgo moderado: ${(rt*100).toFixed(1)}% en riesgo m√°ximo`;}
  else{lv='rojo';msg=`üî¥ Riesgo alto: ${(rt*100).toFixed(1)}% en riesgo ‚Äî ¬°Cuidado!`;}
  document.getElementById('semaforo-container').innerHTML=`<div class="semaforo ${lv}"><div class="semaforo-dot"></div>${msg}</div>`;
}

function renderRiskKPIs() {
  const {capital,riskPct,ddPct,maxPos}=getConfig();
  const re=capital*riskPct, dm=capital*ddPct, rn=re*maxPos;
  document.getElementById('kpi-risk').innerHTML=`
    <div class="kpi blue"><div class="kpi-label">Riesgo/Op</div><div class="kpi-value blue">${fmtE(re)}</div><div class="kpi-sub">${(riskPct*100).toFixed(2)}%</div></div>
    <div class="kpi yellow"><div class="kpi-label">DD M√°x Tolerable</div><div class="kpi-value yellow">${fmtE(dm)}</div><div class="kpi-sub">${(ddPct*100).toFixed(0)}%</div></div>
    <div class="kpi purple"><div class="kpi-label">Ops Simult. M√°x</div><div class="kpi-value">${maxPos}</div></div>
    <div class="kpi red"><div class="kpi-label">Capital en Riesgo</div><div class="kpi-value ${rn>dm?'red':'green'}">${fmtE(rn)}</div><div class="kpi-sub">con ${maxPos} posiciones</div></div>`;
}

function calcPctFijo() {
  const {capital,riskPct}=getConfig(); const sl=parseFloat(document.getElementById('pf-sl').value)||2;
  const re=capital*riskPct, acc=Math.floor(re/sl);
  document.getElementById('pf-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-family:var(--mono);font-size:13px;line-height:2">
    <div>Capital: <strong style="color:var(--accent)">${fmtE(capital)}</strong></div>
    <div>Riesgo: <strong>${(riskPct*100).toFixed(2)}%</strong> = <strong style="color:var(--warn)">${fmtE(re)}</strong></div>
    <div>Stop Loss: <strong>${fmtE(sl)}</strong>/acci√≥n</div>
    <div>Acciones: <strong style="color:var(--bull)">${acc}</strong></div></div>`;
  let h='<div style="font-size:13px;line-height:1.8">',c=capital;
  for(let i=1;i<=15;i++){c-=c*riskPct;const p=((capital-c)/capital*100).toFixed(1);
    h+=`<div style="display:flex;justify-content:space-between;padding:4px 8px;border-radius:4px;${p>25?'background:var(--bear-dim)':''}"><span>${i} p√©rdidas</span><span style="font-family:var(--mono);color:${p>25?'var(--bear)':'var(--text2)'}">-${p}% (${fmtE(c)})</span></div>`;}
  document.getElementById('pf-racha').innerHTML=h+'</div>';
}

function calcKelly() {
  const {ratios,capital}=getConfig(); if(!ratios)return;
  const W=ratios.winRate, R=ratios.avgWinPct/(ratios.avgLossPct||0.01), k=W-(1-W)/R, hk=k/2, qk=k/4;
  document.getElementById('kelly-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-family:var(--mono);font-size:13px;line-height:2.2">
    <div>Win Rate: <strong style="color:var(--bull)">${(W*100).toFixed(1)}%</strong></div>
    <div>Ratio W/L: <strong style="color:var(--accent)">${fmt(R)}x</strong></div>
    <div style="border-top:1px solid var(--border);margin:8px 0;padding-top:8px">
    <div>Full Kelly: <strong style="color:${k>0?'var(--bull)':'var(--bear)'}">${(k*100).toFixed(2)}%</strong>${k<=0?' ‚ö†Ô∏è No edge':''}</div>
    <div>Half Kelly: <strong style="color:var(--accent)">${(hk*100).toFixed(2)}%</strong> ‚Üê Recomendado</div>
    <div>Quarter Kelly: <strong style="color:var(--text2)">${(qk*100).toFixed(2)}%</strong></div></div></div>`;
  document.getElementById('kelly-comparison').innerHTML=`<div style="font-size:13px;line-height:2;padding:14px;background:var(--surface2);border-radius:var(--radius-sm)">
    <div style="display:flex;justify-content:space-between"><span>Full ‚Üí</span><strong style="font-family:var(--mono)">${fmtE(capital*Math.max(k,0))}</strong></div>
    <div style="display:flex;justify-content:space-between"><span>Half ‚Üí</span><strong style="font-family:var(--mono);color:var(--accent)">${fmtE(capital*Math.max(hk,0))}</strong></div>
    <div style="display:flex;justify-content:space-between"><span>Quarter ‚Üí</span><strong style="font-family:var(--mono)">${fmtE(capital*Math.max(qk,0))}</strong></div>
    <div style="margin-top:10px;color:var(--warn);font-size:11px">‚ö†Ô∏è La mayor√≠a de profesionales usan Half Kelly o menos.</div></div>`;
}

function calcMartingala() {
  const {capital}=getConfig(); const ap=parseFloat(document.getElementById('mg-apuesta').value)||100;
  let h='',ac=0,b=ap;
  for(let i=1;i<=12;i++){ac+=b;const p=(ac/capital*100).toFixed(1),r=ac>=capital;
    h+=`<tr style="${r?'background:var(--bear-dim)':''}"><td>${i}</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${p}%</td><td>${r?'üíÄ RUINA':ac>capital*.5?'‚ö†Ô∏è':'‚úÖ'}</td></tr>`;b*=2;}
  document.getElementById('mg-table').innerHTML=h;
  document.getElementById('mg-result').innerHTML=`<div style="padding:14px;background:var(--bear-dim);border:1px solid var(--bear-border);border-radius:var(--radius-sm);font-size:13px">
    <strong style="color:var(--bear)">‚ö†Ô∏è Con ${fmtE(ap)} y ${fmtE(capital)}, ruina en ${Math.ceil(Math.log2(capital/ap))} p√©rdidas consecutivas.</strong></div>`;
}

function calcAntiMartingala() {
  const ap=parseFloat(document.getElementById('am-apuesta').value)||100, rs=parseInt(document.getElementById('am-reset').value)||3;
  let h='',b=ap,ac=0;
  for(let i=1;i<=rs+2;i++){ac+=b;h+=`<tr><td>${i}</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${i>=rs?'üîÑ RESET':'‚¨ÜÔ∏è Doblar'}</td></tr>`;if(i>=rs)b=ap;else b*=2;}
  document.getElementById('am-table').innerHTML=h;
  document.getElementById('am-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Tras <strong>${rs}</strong> ganancias, reset a <strong>${fmtE(ap)}</strong>.</div>`;
}

function calcFibonacci() {
  const {capital}=getConfig(); const bs=parseFloat(document.getElementById('fib-base').value)||50;
  const fibs=[1,1,2,3,5,8,13,21,34,55]; let h='',ac=0;
  for(let i=0;i<fibs.length;i++){const b=bs*fibs[i];ac+=b;const ov=ac>capital;
    h+=`<tr style="${ov?'background:var(--bear-dim)':''}"><td>${i+1}</td><td>${fibs[i]}x</td><td style="font-family:var(--mono)">${fmtE(b)}</td><td style="font-family:var(--mono)">${fmtE(ac)}</td><td>${ov?'‚ö†Ô∏è':'‚úÖ'}</td></tr>`;}
  document.getElementById('fib-table').innerHTML=h;
  const ms=fibs.filter((_,i)=>{let s=0;for(let j=0;j<=i;j++)s+=bs*fibs[j];return s<=capital;}).length;
  document.getElementById('fib-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Aguantas <strong style="color:var(--accent)">${ms} pasos</strong> antes de superar capital.</div>`;
}

function calcParabolico() {
  const {capital,riskPct}=getConfig(); const dl=parseFloat(document.getElementById('par-delta').value)/100||0.25;
  const bs=capital*riskPct; let h='';
  for(let i=0;i<=8;i++){h+=`<tr><td>Nivel ${i}</td><td style="font-family:var(--mono)">${fmtE(bs*i*dl/riskPct)}</td><td style="font-family:var(--mono)">${fmtE(bs*(1+i*dl))}</td><td>+${(i*dl*100).toFixed(0)}%</td></tr>`;}
  document.getElementById('par-table').innerHTML=h;
  document.getElementById('par-result').innerHTML=`<div style="padding:14px;background:var(--surface2);border-radius:var(--radius-sm);font-size:13px;color:var(--text2)">Capital original protegido. Delta: <strong>${(dl*100).toFixed(0)}%</strong>.</div>`;
}

let volRows=3;
function addVolRow(){volRows++;renderVolInputs();}
function renderVolInputs(){
  let h='<div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;margin-bottom:10px"><div style="font-size:11px;color:var(--text2);font-weight:600">ACTIVO</div><div style="font-size:11px;color:var(--text2);font-weight:600">PRECIO</div><div style="font-size:11px;color:var(--text2);font-weight:600">ATR</div>';
  for(let i=0;i<volRows;i++){h+=`<input type="text" id="vol-n-${i}" placeholder="Ticker" oninput="calcVol()"><input type="number" id="vol-p-${i}" placeholder="0.00" step="0.01" oninput="calcVol()"><input type="number" id="vol-a-${i}" placeholder="0.00" step="0.01" oninput="calcVol()">`;}
  document.getElementById('vol-inputs').innerHTML=h+'</div>';
}
function calcVol(){
  const {capital}=getConfig(); let assets=[];
  for(let i=0;i<volRows;i++){const n=document.getElementById(`vol-n-${i}`)?.value,p=parseFloat(document.getElementById(`vol-p-${i}`)?.value),a=parseFloat(document.getElementById(`vol-a-${i}`)?.value);if(n&&p>0&&a>0)assets.push({n,p,a});}
  if(!assets.length){document.getElementById('vol-result').innerHTML='';return;}
  const tiv=assets.reduce((s,x)=>s+1/x.a,0);
  let h='<div class="table-wrap"><table><thead><tr><th>Activo</th><th>Precio</th><th>ATR</th><th>Peso</th><th>Capital</th><th>Acc.</th></tr></thead><tbody>';
  assets.forEach(x=>{const w=(1/x.a)/tiv,c=capital*w;h+=`<tr><td><strong>${x.n}</strong></td><td style="font-family:var(--mono)">${fmtE(x.p)}</td><td style="font-family:var(--mono)">${fmt(x.a)}</td><td>${(w*100).toFixed(1)}%</td><td style="font-family:var(--mono)">${fmtE(c)}</td><td>${Math.floor(c/x.p)}</td></tr>`;});
  document.getElementById('vol-result').innerHTML=h+'</tbody></table></div>';
}

// ‚îÄ‚îÄ ADD OPERATION ‚îÄ‚îÄ
function addOp(type) {
  var pf = 'add-' + type;
  var v = document.getElementById(pf + '-valor').value.trim();
  var t = document.getElementById(pf + '-ticker').value.trim().toUpperCase();
  var fe = document.getElementById(pf + '-fentrada').value;
  var fs = document.getElementById(pf + '-fsalida').value;
  var pe = parseFloat(document.getElementById(pf + '-pentrada').value);
  var ps = parseFloat(document.getElementById(pf + '-psalida').value);
  var cap = parseFloat(document.getElementById(pf + '-capital').value);
  if (!v || !t || !fe || !pe || !cap) { alert('Rellena: Valor, Ticker, F.Entrada, P.Entrada y Capital'); return; }
  if (fs && ps) {
    DATA[type].closed.push({ valor:v, ticker:t, fe:fe, fs:fs, pe:pe, ps:ps, cap:cap });
    DATA[type].enriched = enrichOps(DATA[type].closed, type === 'bear');
  } else {
    var peso = cap / (parseFloat(document.getElementById('capitalTotal').value) || 10000);
    DATA[type].open.push({ valor:v, ticker:t, fe:fe, pe:pe, cap:cap, peso:peso });
  }
  var fields = ['valor','ticker','fentrada','fsalida','pentrada','psalida','capital'];
  for (var fi = 0; fi < fields.length; fi++) {
    var el = document.getElementById(pf + '-' + fields[fi]);
    if (el) el.value = '';
  }
  saveData();
  recalcAll();
}

// ‚îÄ‚îÄ CLOSE POSITION MODAL ‚îÄ‚îÄ
let closeTarget = { type: null, index: null };

function openCloseModal(type, index) {
  const op = DATA[type].open[index];
  if (!op) return;
  closeTarget = { type, index };
  document.getElementById('cm-name').textContent = `${op.valor} (${op.ticker})`;
  document.getElementById('cm-fecha').value = new Date().toISOString().slice(0, 10);
  document.getElementById('cm-precio').value = '';
  document.getElementById('cm-preview').innerHTML = `Entrada: ${fmtE(op.pe)} ¬∑ Capital: ${fmtE(op.cap)}`;
  const modal = document.getElementById('close-modal');
  modal.style.display = 'flex';
  // Live preview
  document.getElementById('cm-precio').oninput = () => {
    const ps = parseFloat(document.getElementById('cm-precio').value);
    if (!ps) { document.getElementById('cm-preview').innerHTML = `Entrada: ${fmtE(op.pe)} ¬∑ Capital: ${fmtE(op.cap)}`; return; }
    const acc = op.cap / op.pe;
    const isBear = type === 'bear';
    const pl = isBear ? acc * (op.pe - ps) : acc * (ps - op.pe);
    const pct = isBear ? (op.pe - ps) / op.pe : (ps - op.pe) / op.pe;
    document.getElementById('cm-preview').innerHTML = `
      Entrada: ${fmtE(op.pe)} ‚Üí Salida: ${fmtE(ps)}<br>
      P/L: <strong style="color:${pl >= 0 ? 'var(--bull)' : 'var(--bear)'}">${fmtE(pl)} (${fmtPct(pct)})</strong>`;
  };
}

function closeModal() {
  document.getElementById('close-modal').style.display = 'none';
  closeTarget = { type: null, index: null };
}

function confirmClose() {
  const { type, index } = closeTarget;
  if (type === null) return;
  const ps = parseFloat(document.getElementById('cm-precio').value);
  const fs = document.getElementById('cm-fecha').value;
  if (!ps || !fs) { alert('Introduce fecha y precio de salida'); return; }
  
  const op = DATA[type].open[index];
  // Move to closed
  const closedOp = { valor: op.valor, ticker: op.ticker, fe: op.fe, fs, pe: op.pe, ps, cap: op.cap };
  DATA[type].closed.push(closedOp);
  DATA[type].enriched = enrichOps(DATA[type].closed, type === 'bear');
  // Remove from open
  DATA[type].open.splice(index, 1);
  
  saveData();
  closeModal();
  recalcAll();
}

// Click outside modal to close
document.getElementById('close-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function switchMain(view) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  document.querySelectorAll('.tabs .tab').forEach(t=>{t.classList.remove('active');if(t.dataset.view===view)t.classList.add('active');});
}
function switchSub(sub) {
  document.querySelectorAll('.sub-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`sub-${sub}`).classList.add('active');
  document.querySelectorAll('.sub-tab').forEach(t=>{t.className='sub-tab';if(t.dataset.sub===sub)t.classList.add(sub==='bull'?'active-bull':sub==='bear'?'active-bear':'active-gen');});
}
function switchStrat(s) {
  document.querySelectorAll('.strat-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(`strat-${s}`).classList.add('active');
  document.querySelectorAll('.strat-tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
}

// ‚îÄ‚îÄ RECALC ALL ‚îÄ‚îÄ
function recalcAll() {
  document.getElementById('riesgoPctVal').textContent=document.getElementById('riesgoPct').value+'%';
  document.getElementById('ddPctVal').textContent=document.getElementById('ddPct').value+'%';
  const cap=parseFloat(document.getElementById('capitalTotal').value)||10000;
  const pA=parseFloat(document.getElementById('pctAlcista').value)||50, pB=parseFloat(document.getElementById('pctBajista').value)||50;
  document.getElementById('euroAlcista').textContent=fmtE(cap*pA/100);
  document.getElementById('euroBajista').textContent=fmtE(cap*pB/100);

  // Bull
  renderKPIs('kpi-bull',calcRatios(DATA.bull.enriched),'bull');
  renderTable('tb-bull-closed',DATA.bull.enriched);
  renderOpenTable('tb-bull-open',DATA.bull.open,'bull');
  renderPLChart('chart-bull-pl',DATA.bull.enriched,'rgba(16,185,129,0.7)','rgba(244,63,94,0.7)');
  renderEquityChart('chart-bull-equity',DATA.bull.enriched,'#10b981');

  // Bear
  renderKPIs('kpi-bear',calcRatios(DATA.bear.enriched),'bear');
  renderTable('tb-bear-closed',DATA.bear.enriched);
  renderOpenTable('tb-bear-open',DATA.bear.open,'bear');
  renderPLChart('chart-bear-pl',DATA.bear.enriched,'rgba(16,185,129,0.7)','rgba(244,63,94,0.7)');
  renderEquityChart('chart-bear-equity',DATA.bear.enriched,'#f43f5e');

  // General + Projections
  renderGeneral();

  // Risk
  renderSemaforo(); renderRiskKPIs(); calcSizing();
  calcPctFijo(); calcKelly(); calcMartingala(); calcAntiMartingala(); calcFibonacci(); calcParabolico(); calcVol();

  document.getElementById('lastUpdate').textContent='Actualizado: '+new Date().toLocaleString('es-ES');
  saveConfig();
}

// ‚îÄ‚îÄ EVENT DELEGATION FOR CLOSE BUTTONS ‚îÄ‚îÄ
document.addEventListener('click', function(e) {
  var btn = e.target.closest('.close-pos-btn');
  if (btn) {
    var type = btn.getAttribute('data-type');
    var idx = parseInt(btn.getAttribute('data-idx'));
    openCloseModal(type, idx);
  }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
// Load saved capital config
try {
  var savedConfig = localStorage.getItem('ethan_config');
  if (savedConfig) {
    var cfg = JSON.parse(savedConfig);
    if (cfg.capital) document.getElementById('capitalTotal').value = cfg.capital;
    if (cfg.pctA) document.getElementById('pctAlcista').value = cfg.pctA;
    if (cfg.pctB) document.getElementById('pctBajista').value = cfg.pctB;
    if (cfg.riesgo) document.getElementById('riesgoPct').value = cfg.riesgo;
    if (cfg.dd) document.getElementById('ddPct').value = cfg.dd;
    if (cfg.maxPos) document.getElementById('maxPos').value = cfg.maxPos;
  }
} catch(e) {}

function saveConfig() {
  try {
    localStorage.setItem('ethan_config', JSON.stringify({
      capital: document.getElementById('capitalTotal').value,
      pctA: document.getElementById('pctAlcista').value,
      pctB: document.getElementById('pctBajista').value,
      riesgo: document.getElementById('riesgoPct').value,
      dd: document.getElementById('ddPct').value,
      maxPos: document.getElementById('maxPos').value
    }));
  } catch(e) {}
}

function resetAllData() {
  if (!confirm('¬øBorrar TODAS las operaciones? Esta acci√≥n no se puede deshacer.')) return;
  DATA.bull = { closed: [], open: [], enriched: [] };
  DATA.bear = { closed: [], open: [], enriched: [] };
  saveData();
  recalcAll();
}

renderVolInputs();
recalcAll();
</script>
</div>
</body>
</html>
